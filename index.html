<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas 2026 - Simulador Realista</title>
    
    <!-- Leaflet & Bibliotecas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <style>
        :root {
            --bg-primary: #0a0c10; --bg-card: rgba(20, 24, 32, 0.98);
            --accent-blue: #3b82f6; --text-primary: #ffffff; --text-muted: #94a3b8;
            --sim-highlight: #ff0055;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; height: 100vh; }
        
        #app { display: flex; width: 100vw; height: 100vh; }
        #map { flex: 1; background: #1a1a1a; z-index: 1; }

        .sidebar { width: 380px; background: var(--bg-card); display: flex; flex-direction: column; z-index: 1000; border-right: 1px solid rgba(255,255,255,0.1); box-shadow: 5px 0 30px rgba(0,0,0,0.5); overflow: hidden; }
        .sidebar-right { border-left: 1px solid rgba(255,255,255,0.1); border-right: none; width: 420px; }

        .header { padding: 20px; background: linear-gradient(180deg, #0a0c10 0%, rgba(10,12,16,0.9) 100%); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { font-size: 1.2rem; font-weight: 800; color: white; margin-bottom: 2px; }
        
        /* SIMULATOR STYLES */
        .sim-panel { background: rgba(255, 0, 85, 0.05); border-bottom: 1px solid var(--sim-highlight); padding: 15px; overflow-y: auto; flex: 1; }
        .sim-header { font-size: 0.75rem; color: var(--sim-highlight); font-weight: 800; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .sim-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .sim-img { width: 24px; height: 24px; border-radius: 50%; background: #333; object-fit: cover; }
        .sim-label { flex: 1; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sim-slider { flex: 1; height: 4px; accent-color: var(--sim-highlight); cursor: pointer; }
        .sim-val { width: 42px; font-family: monospace; font-size: 0.9rem; text-align: right; color: var(--sim-highlight); }
        
        .sim-total { 
            margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; 
            display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700;
        }
        .sim-total.error { color: #ff3333; border: 1px solid #ff3333; }
        .sim-total.ok { color: #00ff88; border: 1px solid #00ff88; }

        .controls { padding: 15px; overflow-y: auto; flex: 1; }
        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 700; letter-spacing: 0.5px; }
        select { width: 100%; padding: 8px; background: #050505; color: white; border: 1px solid #333; border-radius: 6px; }

        .btn-action { width: 100%; padding: 10px; background: #222; color: white; border: 1px solid #444; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 5px; transition: 0.2s; }
        .btn-action:hover { background: #333; border-color: white; }
        .btn-action.active { background: var(--sim-highlight); border-color: var(--sim-highlight); }

        /* RESULTS LIST */
        .cand-row { display: flex; align-items: center; padding: 8px; margin-bottom: 4px; background: rgba(255,255,255,0.03); border-radius: 6px; }
        .cand-bar-bg { flex: 1; height: 6px; background: #333; margin: 0 10px; border-radius: 3px; overflow: hidden; }
        .cand-bar-fill { height: 100%; }

        #loader { position: absolute; inset: 0; background: #0a0c10; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.5s; }
        .hidden { opacity: 0; pointer-events: none; }
        
        /* Map Overrides */
        .legend { position: absolute; bottom: 20px; right: 440px; background: #000; padding: 10px; border-radius: 8px; border: 1px solid #333; z-index: 999; }
        .legend-grad { width: 200px; height: 10px; background: linear-gradient(to right, #eee 0%, #222 100%); margin-top: 5px; }
    </style>
</head>
<body>

<div id="loader">
    <h3 style="color:white; margin-bottom:10px;">Carregando Inteligência Eleitoral...</h3>
    <div style="width: 200px; height: 4px; background: #333; border-radius: 2px;"><div id="loadBar" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div></div>
</div>

<div id="app">
    <!-- ESQUERDA: CONTROLES -->
    <aside class="sidebar">
        <div class="header">
            <h1>Atlas Eleitoral</h1>
            <div style="font-size:0.8rem; color:#888;">Simulador de Cenários & Histórico</div>
        </div>

        <div style="padding: 15px 15px 0 15px;">
            <div class="control-group">
                <label>MODO</label>
                <select id="modeSelect" onchange="app.toggleMode()">
                    <option value="sim2026" selected>★ SIMULADOR 2026</option>
                    <option value="hist">HISTÓRICO (1994-2022)</option>
                </select>
            </div>
        </div>

        <!-- PAINEL SIMULADOR -->
        <div id="simPanel" class="sim-panel">
            <div class="sim-header">
                <span>INTENÇÃO DE VOTO (NACIONAL)</span>
                <button onclick="app.normalizeSliders()" style="background:transparent; border:none; color:#aaa; cursor:pointer; font-size:0.7rem; text-decoration:underline;">Normalizar</button>
            </div>
            
            <div id="slidersContainer"></div>

            <div class="sim-total" id="simTotalBox">
                <span>TOTAL</span>
                <span id="simTotalVal">100%</span>
            </div>

            <button id="btnSecondTurn" class="btn-action" onclick="app.toggleSecondTurn()">
                <i class="fas fa-random"></i> SIMULAR 2º TURNO
            </button>
            
            <div id="secondTurnControls" style="display:none; margin-top:10px; background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; border:1px solid #444;">
                <label style="font-size:0.7rem; font-weight:700; color:#aaa;">QUEM AVANÇA?</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <select id="stCand1" onchange="app.calcMap()"></select>
                    <select id="stCand2" onchange="app.calcMap()"></select>
                </div>
            </div>
        </div>

        <!-- PAINEL HISTORICO (Escondido no inicio) -->
        <div id="histPanel" class="controls" style="display:none;">
            <div class="control-group">
                <label>ANO</label>
                <select id="yearSelect">
                    <option value="2022">2022</option>
                    <option value="2018">2018</option>
                    <option value="2014">2014</option>
                </select>
            </div>
            <div class="control-group">
                <label>CARGO</label>
                <select id="roleSelect">
                    <option value="president">Presidente</option>
                    <option value="governor">Governador</option>
                </select>
            </div>
            <button class="btn-action" onclick="app.loadHistoricalData()">Carregar Mapa</button>
        </div>
    </aside>

    <div id="map"></div>

    <!-- DIREITA: RESULTADOS -->
    <aside class="sidebar sidebar-right">
        <div class="header">
            <h2 id="regionName">Brasil</h2>
            <div style="font-size:0.8rem; color:#3b82f6;">Projeção do Cenário</div>
        </div>
        <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <button id="btnBack" class="btn-action" style="display:none; margin-bottom:10px;" onclick="app.resetSelection()">Voltar ao Nacional</button>
            <div style="font-size:0.7rem; color:#888; text-transform:uppercase;">Total de Votos (Est. 2022)</div>
            <div id="totalVotes" style="font-size:1.5rem; font-weight:800;">-</div>
        </div>
        <div id="resultsList" style="padding:15px; overflow-y:auto;"></div>
    </aside>

    <!-- LEGENDA -->
    <div class="legend">
        <div style="font-size:0.75rem; font-weight:700; color:#fff; margin-bottom:5px;">Intensidade da Vitória</div>
        <div style="display:flex; height:10px; border-radius:4px; overflow:hidden;">
            <div style="flex:1; background:#ddd;"></div>
            <div style="flex:1; background:#bbb;"></div>
            <div style="flex:1; background:#999;"></div>
            <div style="flex:1; background:#666;"></div>
            <div style="flex:1; background:#333;"></div>
            <div style="flex:1; background:#111;"></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:#aaa; margin-top:3px;">
            <span>Disputado</span><span>Hegemônico</span>
        </div>
    </div>
</div>

<script>
// --- CONFIGURAÇÃO DE CANDIDATOS E PESOS ---
// Weights: Home State Boost multiplier
const CANDIDATES = [
    { id: 'LULA', name: 'Lula da Silva', party: 'PT', color: '#E12525', default: 45.0, base: 'L', home: '26' }, // PE home simbólico, mas base forte NE
    { id: 'FLAVIO', name: 'Flávio Bolsonaro', party: 'PL', color: '#0056A8', default: 30.0, base: 'R', home: '33' }, // RJ
    { id: 'RATINHO', name: 'Ratinho Jr', party: 'PSD', color: '#FAA21B', default: 5.0, base: 'R', home: '41', homeBoost: 7.0 }, // PR (Boost Massivo)
    { id: 'CAIADO', name: 'Ronaldo Caiado', party: 'UNIÃO', color: '#009EE3', default: 6.0, base: 'R', home: '52', homeBoost: 6.0 }, // GO (Boost Massivo)
    { id: 'ZEMA', name: 'Romeu Zema', party: 'NOVO', color: '#F58220', default: 4.0, base: 'R', home: '31', homeBoost: 3.5 }, // MG
    { id: 'RENAN', name: 'Renan Santos', party: 'MISSÃO', color: '#333333', default: 5.0, base: 'C', home: '35', homeBoost: 1.2 }, // SP
    { id: 'CIRO', name: 'Ciro Gomes', party: 'PSDB', color: '#008000', default: 5.0, base: 'C', home: '23', homeBoost: 4.0 }  // CE
];

const app = {
    map: null,
    layers: { mun: null, states: null },
    data: { 
        base2022: null, 
        currentSim: null, // Resultado calculado da simulação
        geoJson: null // Cache da malha
    },
    state: {
        mode: 'sim2026',
        secondTurn: false,
        selectedId: null, // ID Município ou Estado selecionado
        selectedName: "Brasil"
    },

    init: async () => {
        // Mapa
        app.map = L.map('map', { center: [-15, -55], zoom: 4, zoomControl: false, preferCanvas: true, background: '#1a1a1a' });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.3 }).addTo(app.map);
        
        app.renderSliders();
        
        // Carregar Dados Base
        try {
            document.getElementById('loadBar').style.width = "30%";
            // GeoJSON Municípios
            const geoRes = await fetch("https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json");
            app.data.geoJson = await geoRes.json();
            document.getElementById('loadBar').style.width = "60%";

            // Dados Eleitorais Inteligentes
            const baseRes = await fetch("2026_president.json"); // JSON gerado pelo Python
            const json = await baseRes.json();
            app.data.base2022 = json["1"].base_inteligencia;
            document.getElementById('loadBar').style.width = "100%";
            
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
                app.calcMap(); // Primeira simulação
            }, 500);

        } catch(e) {
            alert("Erro ao carregar dados. Verifique se o Python gerou '2026_president.json'.");
            console.error(e);
        }
    },

    renderSliders: () => {
        const c = document.getElementById('slidersContainer');
        c.innerHTML = '';
        
        // Popular selects do 2º turno tb
        const s1 = document.getElementById('stCand1');
        const s2 = document.getElementById('stCand2');
        s1.innerHTML = ''; s2.innerHTML = '';

        CANDIDATES.forEach(cand => {
            // HTML do Slider
            const div = document.createElement('div');
            div.className = 'sim-row';
            div.innerHTML = `
                <div style="width:4px; height:24px; background:${cand.color}; border-radius:2px;"></div>
                <div class="sim-label">${cand.name}</div>
                <input type="range" class="sim-slider" id="sl_${cand.id}" 
                       min="0" max="100" step="0.5" value="${cand.default}" 
                       oninput="app.updateSlider('${cand.id}', this.value)">
                <div class="sim-val" id="val_${cand.id}">${cand.default}%</div>
            `;
            c.appendChild(div);

            // Selects
            const opt1 = new Option(cand.name, cand.id);
            const opt2 = new Option(cand.name, cand.id);
            s1.add(opt1); s2.add(opt2);
        });
        
        // Defaults 2o turno
        s1.value = 'LULA'; s2.value = 'FLAVIO';
        app.checkTotal();
    },

    updateSlider: (id, val) => {
        document.getElementById(`val_${id}`).textContent = parseFloat(val).toFixed(1) + '%';
        app.checkTotal();
        // Debounce calculation
        if(app.calcTimeout) clearTimeout(app.calcTimeout);
        app.calcTimeout = setTimeout(app.calcMap, 100); 
    },

    checkTotal: () => {
        let sum = 0;
        CANDIDATES.forEach(c => sum += parseFloat(document.getElementById(`sl_${c.id}`).value));
        const el = document.getElementById('simTotalBox');
        const valEl = document.getElementById('simTotalVal');
        valEl.textContent = sum.toFixed(1) + '%';
        
        el.className = 'sim-total';
        if(sum > 100.1) el.classList.add('error');
        else if(sum > 99.0) el.classList.add('ok');
    },

    normalizeSliders: () => {
        let sum = 0;
        const vals = {};
        CANDIDATES.forEach(c => {
            let v = parseFloat(document.getElementById(`sl_${c.id}`).value);
            vals[c.id] = v;
            sum += v;
        });
        
        if(sum === 0) return;
        const factor = 100 / sum;
        
        CANDIDATES.forEach(c => {
            const newVal = vals[c.id] * factor;
            document.getElementById(`sl_${c.id}`).value = newVal;
            document.getElementById(`val_${c.id}`).textContent = newVal.toFixed(1) + '%';
        });
        app.checkTotal();
        app.calcMap();
    },

    toggleSecondTurn: () => {
        app.state.secondTurn = !app.state.secondTurn;
        const btn = document.getElementById('btnSecondTurn');
        const painel = document.getElementById('secondTurnControls');
        
        if(app.state.secondTurn) {
            btn.classList.add('active');
            painel.style.display = 'block';
        } else {
            btn.classList.remove('active');
            painel.style.display = 'none';
        }
        app.calcMap();
    },

    // --- CORE DA SIMULAÇÃO (Matemática Realista) ---
    calcMap: () => {
        const resultCache = {}; // { id_mun: { LULA: 100, FLAVIO: 50... } }
        const munData = app.data.base2022;
        
        // 1. Coletar "Metas Nacionais" dos sliders
        const targets = {};
        let sumTargets = 0;
        CANDIDATES.forEach(c => {
            targets[c.id] = parseFloat(document.getElementById(`sl_${c.id}`).value);
            sumTargets += targets[c.id];
        });
        
        // Normalização interna para cálculo (garantir que soma 100 na math)
        if(sumTargets > 0) {
             Object.keys(targets).forEach(k => targets[k] = (targets[k]/sumTargets));
        }

        // Agrupar targets por Coalizão (Esquerda, Direita, Centro)
        // Isso define QUEM divide o bolo de cada espectro
        const weights = { L: {}, R: {}, C: {} };
        const spectrumTotals = { L: 0, R: 0, C: 0 };

        CANDIDATES.forEach(c => {
            weights[c.base][c.id] = targets[c.id]; // Peso Bruto Nacional
            spectrumTotals[c.base] += targets[c.id];
        });

        // 2. Processar cada município
        for (const [id, prof] of Object.entries(munData)) {
            const cityVotes = {};
            const state = prof.UF; // ex: '41' (PR)

            // A. Calcular distribuição LOCAL da Direita (R)
            // Se Ratinho tem target nacional 5%, mas é PR, ele suga mais % do bolo da Direita local
            let localWeightsR = {}; 
            let sumLocalWR = 0;
            
            // Loop nos candidatos de Direita
            Object.keys(weights.R).forEach(candId => {
                const cand = CANDIDATES.find(x => x.id === candId);
                let w = weights.R[candId]; // Peso nacional base
                
                // HOME STATE BOOST
                if(cand.home === state && cand.homeBoost) {
                    w *= cand.homeBoost;
                }
                
                localWeightsR[candId] = w;
                sumLocalWR += w;
            });

            // Normalizar a divisão da Direita local
            if(sumLocalWR > 0) {
                Object.keys(localWeightsR).forEach(k => localWeightsR[k] /= sumLocalWR);
            }

            // B. O mesmo para Esquerda e Centro (embora Lula domine L, Ciro domine CE)
            // (Simplificado: apenas aplica lógica similar se houver múltiplos cands na mesma base)
            
            // C. Atribuir Votos Finais
            // Votos = (PerfilLocal_Esquerda * PesoNacionalEsqModificado) + (PerfilLocal_Direita * DivisaoDireitaLocal) ...
            // Na verdade, a logica swingometer é: 
            // VotosCand = (PerfilBaseCand * SwingNacional) * HomeBoost
            
            // Lógica Híbrida mais robusta:
            // O Perfil "R" (Bolsonarista 2022) do município vai ser fatiado entre os candidatos R
            // baseado nos pesos locais calculados acima.
            
            // ESQUERDA (Base L)
            const baseL = prof.L * prof.TOT;
            // Assumimos que Lula herda quase tudo de L, mas perde se houver outro L.
            // Aqui só tem Lula L, então ele pega tudo * Swing se quisermos, mas
            // vamos usar a logica de fatiamento do espectro.
            // Se Esquerda Nacional caiu (Targets L < Real 2022 L), reduzimos.
            // Mas o target é % global. 
            
            // Vamos distribuir o bolo:
            // Votos vindos da Direita (2022):
            const potR = prof.R * prof.TOT;
            Object.keys(localWeightsR).forEach(cid => {
                cityVotes[cid] = (cityVotes[cid]||0) + (potR * localWeightsR[cid]);
            });

            // Votos vindos da Esquerda (2022):
            const potL = prof.L * prof.TOT;
            // Assumindo Lula pega 95% do L, e Ciro rouba um pouco? 
            // Simples: Divide potL proporcionalmente aos targets L (se tiver mais de 1)
            // Como só tem Lula na base L neste exemplo:
            // Mas espera: Se Lula caiu de 48 pra 40 nacional, ele perdeu votos. Pra quem?
            // O modelo de fatiamento assume fidelidade ideológica. 
            // Para permitir migração (Lula -> Ciro), precisamos de uma "Matriz de Transferencia" ou
            // ajustar os Potes.
            // SIMPLIFICAÇÃO FUNCIONAL: Ajustar o tamanho dos potes baseado na variação nacional dos espectros.
            
            // Ajuste de Tamanho de Espectro Nacional:
            // Real 2022: L~48, R~43, C~9
            // Target 2026: L=40, R=50, C=10 (Exemplo)
            // Swing L = 40/48 = 0.83. Swing R = 50/43 = 1.16.
            
            const swingL = spectrumTotals.L / 0.48; // Aprox
            const swingR = spectrumTotals.R / 0.43; 
            const swingC = spectrumTotals.C / 0.09;

            // Potes Ajustados Localmente
            const finalPotL = potL * swingL;
            const finalPotR = potR * swingR;
            const finalPotC = potC = (prof.TOT - finalPotL - finalPotR); // Resto vai pro centro/indefinido
            
            // Distribuir Pote L (Apenas Lula na lista)
            if(CANDIDATES.find(c=>c.id=='LULA')) cityVotes['LULA'] = finalPotL;

            // Distribuir Pote R (Já calculado os pesos relativos locais)
            Object.keys(localWeightsR).forEach(cid => {
                cityVotes[cid] = (cityVotes[cid]||0) + (finalPotR * localWeightsR[cid]); // Substitui o calculo anterior
            });

            // Distribuir Pote C (Renan, Ciro)
            let localWeightsC = {}; let sumC = 0;
            CANDIDATES.filter(c=>c.base==='C').forEach(c => {
                let w = targets[c.id];
                if(c.home === state) w *= c.homeBoost || 1;
                localWeightsC[c.id] = w;
                sumC += w;
            });
            Object.keys(localWeightsC).forEach(cid => {
                const ratio = sumC > 0 ? localWeightsC[cid]/sumC : 0;
                cityVotes[cid] = (cityVotes[cid]||0) + (Math.max(0, finalPotC) * ratio);
            });

            // 3. SEGUNDO TURNO (Se ativo)
            if(app.state.secondTurn) {
                const c1 = document.getElementById('stCand1').value;
                const c2 = document.getElementById('stCand2').value;
                
                let v1 = cityVotes[c1] || 0;
                let v2 = cityVotes[c2] || 0;
                
                // Transferência dos derrotados
                Object.keys(cityVotes).forEach(cid => {
                    if(cid !== c1 && cid !== c2) {
                        const votes = cityVotes[cid];
                        const cand = CANDIDATES.find(x => x.id === cid);
                        const cand1Obj = CANDIDATES.find(x => x.id === c1);
                        const cand2Obj = CANDIDATES.find(x => x.id === c2);
                        
                        // Lógica simples de afinidade: Mesmo espectro -> 90% transfere.
                        // Espectro oposto -> 10% transfere.
                        let p1 = 0.5, p2 = 0.5; // Neutro
                        
                        if(cand.base === cand1Obj.base) p1 = 0.9;
                        else if(cand.base === cand2Obj.base) p1 = 0.1;
                        
                        p2 = 1 - p1;
                        
                        v1 += votes * p1;
                        v2 += votes * p2;
                    }
                });
                
                resultCache[id] = { [c1]: v1, [c2]: v2, TOTAL: v1+v2 };
            } else {
                cityVotes.TOTAL = Object.values(cityVotes).reduce((a,b)=>a+b,0);
                resultCache[id] = cityVotes;
            }
        }
        
        app.data.currentSim = resultCache;
        app.renderMap();
        app.updateSidePanel();
    },

    renderMap: () => {
        if(app.layers.mun) app.map.removeLayer(app.layers.mun);
        
        app.layers.mun = L.geoJSON(app.data.geoJson, {
            style: (feature) => {
                const id = feature.properties.id || feature.properties.codarea;
                const res = app.data.currentSim[id];
                
                if(!res || res.TOTAL === 0) return { fillColor: '#333', weight: 0, fillOpacity:1 };
                
                // Achar vencedor
                let winner = null; 
                let max = -1;
                Object.entries(res).forEach(([k, v]) => {
                    if(k !== 'TOTAL' && v > max) { max = v; winner = k; }
                });
                
                const pct = (max / res.TOTAL) * 100;
                const candObj = CANDIDATES.find(c => c.id === winner);
                const colorHex = candObj ? candObj.color : '#333';
                
                // Intensidade (Darker = Stronger)
                // Escala de 30% a 70%
                let intensity = (pct - 30) / (70 - 30); // 0 a 1
                if(intensity < 0) intensity = 0;
                if(intensity > 1) intensity = 1;
                
                // Misturar com preto (para escurecer os fortes) ou branco (para clarear os fracos)?
                // O pedido era: 20% claro, 100% escuro (saturado).
                // Leaflet fill color direct mix.
                
                return {
                    fillColor: app.getGradientColor(colorHex, pct),
                    weight: app.state.selectedId === id ? 2 : 0.2,
                    color: app.state.selectedId === id ? '#fff' : '#000',
                    fillOpacity: 1
                };
            },
            onEachFeature: (feature, layer) => {
                const id = feature.properties.id || feature.properties.codarea;
                layer.on('click', () => app.selectRegion(id, feature.properties.name));
            }
        }).addTo(app.map);
    },

    getGradientColor: (hex, pct) => {
        // Escala discreta para performance e visual "mapa eleitoral"
        // <35, 35-45, 45-55, 55-65, >65
        const c = app.hexToRgb(hex);
        let factor = 0; // Quanto de BRANCO misturar (0 = cor pura, 1 = branco)
        
        if (pct < 35) factor = 0.6;
        else if (pct < 45) factor = 0.4;
        else if (pct < 55) factor = 0.2;
        else if (pct < 65) factor = 0.1;
        else factor = 0; // Saturado
        
        const r = Math.round(c.r + (255 - c.r) * factor);
        const g = Math.round(c.g + (255 - c.g) * factor);
        const b = Math.round(c.b + (255 - c.b) * factor);
        return `rgb(${r},${g},${b})`;
    },

    hexToRgb: (hex) => {
        const bigint = parseInt(hex.replace('#',''), 16);
        return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
    },

    updateSidePanel: () => {
        const list = document.getElementById('resultsList');
        const totalEl = document.getElementById('totalVotes');
        const regionName = document.getElementById('regionName');
        list.innerHTML = '';
        
        // Agregar dados (Nacional ou Local)
        let agg = {};
        let total = 0;
        
        const targetIds = app.state.selectedId ? [app.state.selectedId] : Object.keys(app.data.currentSim);
        regionName.textContent = app.state.selectedName;
        
        targetIds.forEach(id => {
            const d = app.data.currentSim[id];
            if(d) {
                Object.keys(d).forEach(k => {
                    if(k!=='TOTAL') agg[k] = (agg[k]||0) + d[k];
                });
                total += d.TOTAL;
            }
        });
        
        totalEl.textContent = total.toLocaleString('pt-BR');
        
        // Ordenar e Renderizar
        const sorted = Object.entries(agg).sort((a,b) => b[1] - a[1]);
        
        sorted.forEach(([candId, votes]) => {
            const pct = (votes / total) * 100;
            const cObj = CANDIDATES.find(c => c.id === candId);
            
            const row = document.createElement('div');
            row.className = 'cand-row';
            row.innerHTML = `
                <div style="width:3px; height:30px; background:${cObj.color}; margin-right:8px;"></div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; font-weight:700; font-size:0.9rem;">
                        <span>${cObj.name}</span>
                        <span style="color:${cObj.color}">${pct.toFixed(2)}%</span>
                    </div>
                    <div style="font-size:0.7rem; color:#888; display:flex; justify-content:space-between;">
                        <span>${cObj.party}</span>
                        <span>${Math.round(votes).toLocaleString()}</span>
                    </div>
                    <div class="cand-bar-bg">
                        <div class="cand-bar-fill" style="width:${pct}%; background:${cObj.color};"></div>
                    </div>
                </div>
            `;
            list.appendChild(row);
        });
    },

    selectRegion: (id, name) => {
        app.state.selectedId = id;
        app.state.selectedName = name;
        document.getElementById('btnBack').style.display = 'block';
        app.updateSidePanel();
        app.renderMap(); // Re-render para highlight borda
    },
    
    resetSelection: () => {
        app.state.selectedId = null;
        app.state.selectedName = "Brasil";
        document.getElementById('btnBack').style.display = 'none';
        app.updateSidePanel();
        app.renderMap();
    },

    toggleMode: () => {
        const mode = document.getElementById('modeSelect').value;
        if(mode === 'sim2026') {
            document.getElementById('simPanel').style.display = 'flex';
            document.getElementById('histPanel').style.display = 'none';
            app.calcMap();
        } else {
            document.getElementById('simPanel').style.display = 'none';
            document.getElementById('histPanel').style.display = 'block';
            alert("Modo Histórico ainda não integrado neste demo (requer carregar JSONs antigos). Foco na Simulação 2026.");
        }
    }
};

app.init();
</script>
</body>
</html>
