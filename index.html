<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Eleitoral 2026 - Performance</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #050505; --panel: #111; --text: #eee; --pt: #c4122d; --pl: #002f6c; --border: #333; }
        body { margin:0; font-family:'Inter', sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; overflow:hidden; }
        
        #map { flex:1; background:#0a0a0a; z-index:1; }
        
        .sidebar { width:360px; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:1000; box-shadow:5px 0 20px #000; }
        .header { padding:20px; background:#000; border-bottom:1px solid var(--border); }
        .controls { padding:20px; flex:1; overflow-y:auto; }
        
        .scoreboard { display:flex; justify-content:space-between; align-items:center; background:#1a1a1a; padding:15px; border-radius:8px; border:1px solid #333; margin-bottom:20px; }
        .cand-val { font-size:1.6rem; font-weight:800; }
        
        input[type=range] { width:100%; margin:15px 0; cursor:pointer; }
        
        .legend { position:absolute; bottom:20px; right:20px; background:#000; padding:10px; border:1px solid #333; border-radius:6px; z-index:999; width:220px; }
        .grad-bar { height:10px; width:100%; background:linear-gradient(90deg, var(--pl), #fff, var(--pt)); margin-top:5px; }
        .labels { display:flex; justify-content:space-between; font-size:0.65rem; color:#888; margin-top:4px; }

        /* Loader Robusto */
        #loader { position:absolute; inset:0; background:rgba(0,0,0,0.98); z-index:2000; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align: center; }
        .loader-bar { width:250px; height:4px; background:#333; margin-top:15px; border-radius:2px; }
        .loader-fill { width:0%; height:100%; background:#fff; transition:width 0.2s; }
        #errorMsg { color: #ff5555; margin-top: 20px; max-width: 400px; font-size: 0.9rem; display: none; }
    </style>
</head>
<body>

<div id="loader">
    <h3 id="loadText" style="font-weight:400; letter-spacing:1px;">INICIANDO...</h3>
    <div class="loader-bar"><div class="loader-fill" id="loadFill"></div></div>
    <div id="errorMsg"></div>
</div>

<aside class="sidebar">
    <div class="header">
        <h1 style="margin:0; font-size:1.2rem">Simulador 2026</h1>
    </div>

    <div class="controls">
        <div class="scoreboard">
            <div style="text-align:center"><span style="color:var(--pl); font-size:0.8rem">DIREITA</span><br><span class="cand-val" id="dispPl">--%</span></div>
            <div style="color:#444">VS</div>
            <div style="text-align:center"><span style="color:var(--pt); font-size:0.8rem">ESQUERDA</span><br><span class="cand-val" id="dispPt">--%</span></div>
        </div>

        <label style="font-size:0.8rem; color:#888; font-weight:700">INTENÇÃO DE VOTO (ESQ)</label>
        <input type="range" id="simSlider" min="30" max="70" step="0.1" value="50.9">
        
        <div style="margin-top:10px; font-size:0.75rem; color:#666; text-align: center;">
            Arraste para recalcular o mapa em tempo real
        </div>

        <div style="margin-top:20px; padding:15px; border:1px solid #333; border-radius:6px; background:#161616">
            <div style="font-size:0.75rem; color:#aaa; margin-bottom:5px">MUNICÍPIOS VENCIDOS</div>
            <div style="display:flex; justify-content:space-between; font-weight:700">
                <span style="color:var(--pt)">Esq: <span id="countPt">0</span></span>
                <span style="color:var(--pl)">Dir: <span id="countPl">0</span></span>
            </div>
        </div>
    </div>
</aside>

<div id="map"></div>

<div class="legend">
    <div style="font-size:0.7rem; font-weight:700; color:#fff; text-align:center">INTENSIDADE</div>
    <div class="grad-bar"></div>
    <div class="labels"><span>100% Dir</span><span>Empate</span><span>100% Esq</span></div>
</div>

<script>
const app = {
    map: null,
    geoLayer: null,
    data: null, 
    basePct: 0.509,
    currentSwing: 0,

    init: async () => {
        // Mapa otimizado com Canvas
        app.map = L.map('map', {
            center: [-15, -50], 
            zoom: 4, 
            zoomControl: false, 
            background:'#0a0a0a', 
            preferCanvas: true // CRUCIAL PARA PERFORMANCE
        });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {opacity: 0.4}).addTo(app.map);
        
        // Slider com debounce (evita travar ao arrastar r\u00e1pido)
        const slider = document.getElementById('simSlider');
        slider.addEventListener('input', (e) => {
            requestAnimationFrame(() => app.updateSimulation(parseFloat(e.target.value)));
        });

        await app.loadFiles();
    },

    showError: (msg) => {
        const el = document.getElementById('errorMsg');
        el.style.display = 'block';
        el.innerText = msg;
        document.getElementById('loadText').innerText = "ERRO FATAL";
        document.getElementById('loadText').style.color = "#ff5555";
        document.getElementById('loadFill').style.backgroundColor = "#ff5555";
    },

    loadFiles: async () => {
        const bar = document.getElementById('loadFill');
        const txt = document.getElementById('loadText');

        try {
            // 1. Dados Eleitorais
            txt.innerText = "LENDO DADOS DE 2026...";
            bar.style.width = '30%';
            
            let res = await fetch('data/cenario_base_2026.json');
            if (!res.ok) res = await fetch('cenario_base_2026.json'); // Tenta raiz
            if (!res.ok) throw new Error("Arquivo cenario_base_2026.json n\u00e3o encontrado.");
            
            app.data = await res.json();
            
            if (!app.data.dados) throw new Error("JSON inv\u00e1lido: Falta campo 'dados'.");

            if (app.data.meta && app.data.meta.base_nacional) {
                app.basePct = app.data.meta.base_nacional;
                document.getElementById('simSlider').value = (app.basePct * 100).toFixed(1);
            }

            // 2. Mapa
            txt.innerText = "BAIXANDO MAPA...";
            bar.style.width = '60%';
            const geoRes = await fetch('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json');
            if (!geoRes.ok) throw new Error("Falha ao baixar mapa do GitHub.");
            const geoJson = await geoRes.json();

            // 3. Renderiza\u00e7\u00e3o Inicial (J\u00e1 pintado)
            txt.innerText = "DESENHANDO 5.570 CIDADES...";
            bar.style.width = '90%';
            
            // Pequena pausa para UI respirar
            await new Promise(r => setTimeout(r, 50));

            app.renderMap(geoJson);
            
            // Finaliza
            document.getElementById('loader').classList.add('hidden');
            app.updateSimulation(app.basePct * 100);

        } catch (e) {
            app.showError(e.message);
            console.error(e);
        }
    },

    // Fun\u00e7\u00e3o de Estilo Otimizada (Calcula cor direto)
    getFeatureStyle: (feature) => {
        const id = feature.ibge;
        const cityData = app.data.dados[id];
        
        let fillColor = '#222'; // Sem dados
        
        if (cityData) {
            // Calcula cor baseada no swing atual (inicialmente 0)
            const baseCityPct = cityData[0];
            let newPct = baseCityPct + app.currentSwing;
            newPct = Math.max(0, Math.min(1, newPct));
            fillColor = app.getColor(newPct);
            feature.simPct = newPct; // Cache para tooltip
        }

        return {
            fillColor: fillColor,
            weight: 0.5,
            color: '#000',
            fillOpacity: 1
        };
    },

    renderMap: (geoJson) => {
        app.geoLayer = L.geoJSON(geoJson, {
            // Normaliza IDs antes de estilizar
            onEachFeature: (f, l) => {
                f.ibge = (f.properties.id || f.properties.codarea).toString();
                l.bindTooltip(() => app.getTooltip(f.ibge), {sticky: true, direction: 'top'});
            },
            style: app.getFeatureStyle // Aplica estilo inicial
        }).addTo(app.map);
    },

    updateSimulation: (targetPct) => {
        // Atualiza estado global
        app.currentSwing = (targetPct / 100) - app.basePct;
        
        // Atualiza textos
        document.getElementById('dispPt').innerText = targetPct.toFixed(1) + '%';
        document.getElementById('dispPl').innerText = (100 - targetPct).toFixed(1) + '%';

        let cPt = 0, cPl = 0;

        // Loop de atualiza\u00e7\u00e3o visual
        app.geoLayer.eachLayer(layer => {
            const id = layer.feature.ibge;
            const cityData = app.data.dados[id];

            if (cityData) {
                let newPct = cityData[0] + app.currentSwing;
                newPct = Math.max(0, Math.min(1, newPct));
                
                // Atualiza cor
                layer.setStyle({ fillColor: app.getColor(newPct) });
                
                // Atualiza dados internos para tooltip
                layer.feature.simPct = newPct;
                
                if (newPct > 0.5) cPt++; else cPl++;
            }
        });

        document.getElementById('countPt').innerText = cPt.toLocaleString();
        document.getElementById('countPl').innerText = cPl.toLocaleString();
    },

    // Cores: Branco -> Puro
    getColor: (pct) => {
        if (pct > 0.5) {
            const intensity = (pct - 0.5) * 2;
            return app.mix('#ffffff', '#c4122d', intensity); // Vermelho
        } else {
            const intensity = (0.5 - pct) * 2;
            return app.mix('#ffffff', '#002f6c', intensity); // Azul
        }
    },

    mix: (c1, c2, ratio) => {
        const r1 = parseInt(c1.substring(1,3), 16);
        const g1 = parseInt(c1.substring(3,5), 16);
        const b1 = parseInt(c1.substring(5,7), 16);
        
        const r2 = parseInt(c2.substring(1,3), 16);
        const g2 = parseInt(c2.substring(3,5), 16);
        const b2 = parseInt(c2.substring(5,7), 16);

        const r = Math.round(r1 + (r2 - r1) * ratio);
        const g = Math.round(g1 + (g2 - g1) * ratio);
        const b = Math.round(b1 + (b2 - b1) * ratio);

        return `rgb(${r},${g},${b})`;
    },

    getTooltip: (id) => {
        const name = (app.data.nomes && app.data.nomes[id]) ? app.data.nomes[id] : id;
        // Pega do feature (j\u00e1 atualizado) ou do dados base
        let val = 0.5;
        let layer = null;
        
        // Forma eficiente de achar a layer sem loop
        // (O Leaflet n\u00e3o indexa por ID nativamente, ent\u00e3o usamos o dado salvo se poss\u00edvel)
        // Aqui assumimos que o loop updateSimulation j\u00e1 rodou
        const cityData = app.data.dados[id];
        if (cityData) {
            val = cityData[0] + app.currentSwing;
            val = Math.max(0, Math.min(1, val));
        } else {
            return `${name}: Sem dados`;
        }

        const winner = val > 0.5 ? "ESQUERDA" : "DIREITA";
        const color = val > 0.5 ? "var(--pt)" : "var(--pl)";
        const displayVal = val > 0.5 ? val : (1 - val);

        return `<div style="background:#000; color:#fff; padding:5px; border:1px solid #444;">
            <strong>${name}</strong><br>
            <span style="color:${color}">${winner}</span> ${(displayVal*100).toFixed(1)}%
        </div>`;
    }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
