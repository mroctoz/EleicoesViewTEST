<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Eleições View - 2026 Final</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<!-- Export Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    :root {
        --bg-primary: #0a0c10;
        --bg-card: rgba(20, 24, 32, 0.98);
        --accent-blue: #3b82f6;
        --text-primary: #ffffff;
        --text-muted: #94a3b8;
        --border-color: rgba(255, 255, 255, 0.1);
        --gradient-primary: linear-gradient(135deg, #3b82f6, #8b5cf6);
        --sidebar-width: 380px;
        --bottom-nav-height: 60px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    body {
        font-family: 'Inter', sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        overflow: hidden;
        height: 100vh;
        width: 100vw;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #0a0c10; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* --- LAYOUT DESKTOP (PADRÃO 3 COLUNAS) --- */
    #app { 
        width: 100%; height: 100%; 
        display: flex; 
        position: relative; background: #1a1a1a; 
    }

    #map { 
        flex: 1; 
        height: 100%; 
        background: #1a1a1a; 
        z-index: 1; 
        position: relative;
    }

    /* SIDEBARS NO PC: FIXAS LADO A LADO */
    .sidebar {
        width: var(--sidebar-width);
        min-width: var(--sidebar-width);
        background: var(--bg-card);
        display: flex; flex-direction: column;
        z-index: 100;
        border-right: 1px solid var(--border-color);
        height: 100%;
    }
    .sidebar-right {
        width: var(--sidebar-width);
        min-width: var(--sidebar-width);
        background: var(--bg-card);
        display: flex; flex-direction: column;
        z-index: 100;
        border-left: 1px solid var(--border-color);
        height: 100%;
    }

    /* BARRA DE NAVEGAÇÃO MOBILE (ESCONDIDA NO PC) */
    .mobile-nav { display: none; }

    /* --- MOBILE RESPONSIVE (LAYOUT BANDEJA/DRAWER) --- */
    @media (max-width: 1024px) { :root { --sidebar-width: 320px; } }

    @media (max-width: 768px) {
        #app { 
            display: block; /* Remove o Flexbox do PC */
            position: relative;
        }

        #map { 
            width: 100%; height: 100%; 
            padding-bottom: var(--bottom-nav-height); /* Espaço para a nav bar */
        }

        /* BARRA DE NAVEGAÇÃO INFERIOR */
        .mobile-nav {
            display: flex;
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--bottom-nav-height);
            background: #0d1117;
            border-top: 1px solid #333;
            z-index: 5000;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #666; font-size: 0.7rem; gap: 4px;
            width: 33%; height: 100%; cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item i { font-size: 1.2rem; }
        .nav-item.active { color: var(--accent-blue); }

        /* SIDEBARS TRANSFORMADAS EM GAVETAS (BOTTOM SHEETS) */
        .sidebar, .sidebar-right {
            position: absolute;
            bottom: var(--bottom-nav-height); /* Fica logo acima da nav bar */
            left: 0; right: 0; top: auto;
            width: 100%; height: auto; max-height: 80vh; /* Altura máxima */
            border: none; border-radius: 20px 20px 0 0;
            border-top: 1px solid rgba(255,255,255,0.15);
            background: #161b22;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
            z-index: 4000;
            
            /* Animação de Entrada/Saída */
            transform: translateY(110%); /* Escondido pra baixo */
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        }

        /* Classe para mostrar a gaveta */
        .sidebar.active, .sidebar-right.active {
            transform: translateY(0);
        }

        /* Ajustes de UI Mobile */
        .legend { display: none !important; } /* Remove legenda no mobile */
        
        .map-controls {
            top: 15px !important; bottom: auto; right: 15px !important;
            flex-direction: row !important; /* Botões lado a lado para economizar altura */
        }
        
        .header { padding: 12px 15px; }
        .header h1 { font-size: 1rem; }
        
        /* Botão "Voltar" não é necessário na visualização de gaveta com nav bar */
        #btnBack { display: none !important; }
    }

    /* --- ESTILOS GERAIS DE COMPONENTES --- */
    .header {
        padding: 15px;
        background: linear-gradient(180deg, rgba(10, 12, 16, 1) 0%, rgba(10, 12, 16, 0.9) 100%);
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }
    .header-top { display: flex; justify-content: space-between; align-items: center; }
    .header h1, .header h2 {
        font-size: 1.1rem; font-weight: 800; margin: 0;
        background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .controls { padding: 15px; flex: 1; overflow-y: auto; display:flex; flex-direction:column; gap:12px; }
    
    .io-buttons { display: flex; gap: 8px; margin-top: 10px; }
    .btn-io { flex: 1; padding: 10px; border: 1px solid #333; background: #151515; color: #aaa; border-radius: 6px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; }
    
    .mode-tabs { display: flex; gap: 8px; margin-top: 15px; }
    .mode-tab { flex: 1; padding: 10px; text-align: center; border-radius: 6px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); cursor: pointer; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); transition: all 0.2s; }
    .mode-tab.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }

    .control-group label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 6px; font-weight: 700; text-transform: uppercase; }
    select { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #333; background-color: #050505; color: white; font-family: inherit; font-size: 0.9rem; }
    
    button.btn-primary { width: 100%; padding: 14px; border-radius: 8px; background: var(--gradient-primary); border: none; font-weight: 700; color: white; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom:10px; font-size: 0.85rem; }
    button.btn-secondary { width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; cursor: pointer; font-weight: 600; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; }
    button.btn-back { width: 100%; padding: 12px; border-radius: 8px; background: #222; border: 1px solid #444; color: white; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; font-weight: 600; }

    .slider-box { margin-bottom: 12px; transition: opacity 0.3s; padding: 2px 0; }
    .slider-box.inactive { opacity: 0.4; filter: grayscale(1); }
    .slider-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; align-items: center; }
    .slider-check-group { display: flex; align-items: center; gap: 8px; }
    input[type=checkbox] { cursor: pointer; accent-color: var(--accent-blue); width: 16px; height: 16px; }
    input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; padding: 8px 0; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 5px; background: #333; border-radius: 3px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -6px; height: 18px; width: 18px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    input[type=range]:disabled { cursor: not-allowed; opacity: 0.5; }

    .switch-container { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
    .switch-label { font-size: 0.75rem; font-weight: 700; color: #ccc; }
    .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-blue); }
    input:checked + .slider:before { transform: translateX(18px); }

    .cand-row { display: flex; align-items: center; gap: 10px; padding: 12px; margin-bottom: 6px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 6px; }
    .cand-color { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
    .cand-info { flex: 1; min-width: 0; }
    .cand-head { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; }
    .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 4px; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.5s ease; }

    .map-controls { position: absolute; top: 20px; right: 410px; display: flex; flex-direction: column; gap: 8px; z-index: 900; }
    .map-btn { width: 44px; height: 44px; background: #0a0c10; border: 1px solid #333; color: #ddd; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-size: 1.2rem; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .map-btn-dl { color: var(--accent-blue); border-color: rgba(59, 130, 246, 0.4); }

    .legend { position: absolute; bottom: 30px; right: 410px; background: #0a0c10; padding: 15px; border: 1px solid #333; border-radius: 12px; z-index: 900; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    .legend-grid { display: flex; height: 20px; width: 225px; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
    .legend-item { flex: 1; border-right: 1px solid rgba(0,0,0,0.3); }

    .custom-tooltip { background: #0a0c10; border: 1px solid #333; color: white; border-radius: 8px; font-family: 'Inter', sans-serif; padding: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
    .tt-head { background: #151a23; padding: 10px; font-weight: 700; border-bottom: 1px solid #333; border-radius: 8px 8px 0 0; }
    .tt-body { padding: 10px; }

    .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 6000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: #11141a; border: 1px solid #333; width: 500px; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .modal-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1rem; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 15px; border-top: 1px solid #333; text-align: right; }
    .close-btn { cursor: pointer; padding: 10px; color: #888; font-size: 1.2rem; }

    #loader { position: absolute; inset: 0; background: rgba(5,5,5,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.3s; }
    .hidden { opacity: 0; pointer-events: none; }
    .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="loader">
<div class="spinner"></div>
<h3 id="loaderMsg">Carregando Dados...</h3>
</div>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modalTitle">Configuração</span>
            <span class="close-btn" onclick="app.closeModal()"><i class="fas fa-times"></i></span>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button class="btn-primary" style="width: auto; padding: 8px 24px;" onclick="app.closeModal()">Confirmar</button>
        </div>
    </div>
</div>

<div id="app">
    <!-- ESQUERDA (CONFIGURAÇÃO) -->
    <aside class="sidebar" id="sidebarConfig">
        <div class="header">
            <div class="header-top">
                <h1>Simulação 2026</h1>
            </div>
            <div class="io-buttons">
                <button class="btn-io" onclick="app.exportConfig()"><i class="fas fa-download"></i> Salvar</button>
                <button class="btn-io" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> Abrir</button>
                <input type="file" id="fileInput" style="display:none" onchange="app.importConfig(this)" accept=".json">
            </div>
            <div class="mode-tabs">
                <div class="mode-tab active" id="tab1" onclick="app.setTurn(1)">1º TURNO</div>
                <div class="mode-tab" id="tab2" onclick="app.setTurn(2)">2º TURNO</div>
            </div>
        </div>

        <div style="padding: 15px 15px 0 15px;">
            <div class="control-group">
                <label>VISUALIZAÇÃO</label>
                <select id="viewModeSelect" onchange="app.handleViewChange()">
                    <option value="states">Por Estados (Brasil)</option>
                    <option value="all_cities">Brasil Municipal</option>
                </select>
            </div>
        </div>
        
        <div class="controls" id="controlsT1">
            <div style="text-align:center;">
                <label>INTENÇÃO DE VOTOS (NACIONAL)</label>
                <div id="totalSimVal" style="font-size:1.3rem; font-weight:800; color:#4ade80; margin-bottom:10px;">100%</div>
            </div>
            <div id="slidersT1"></div>
            <button class="btn-secondary" onclick="app.openMatrixModal()"><span><i class="fas fa-network-wired"></i> Herança (2022)</span><i class="fas fa-chevron-right"></i></button>
            <button class="btn-secondary" onclick="app.openStateModal(1)"><span><i class="fas fa-map-marker-alt"></i> Multiplicadores Estaduais</span><i class="fas fa-chevron-right"></i></button>
            <button class="btn-primary" onclick="app.runSimulation()">CALCULAR 1º TURNO</button>
        </div>

        <div class="controls" id="controlsT2" style="display:none;">
            <div class="control-group">
                <label>FINALISTAS</label>
                <div style="display:flex; gap:5px;">
                    <select id="candFinal1" onchange="app.updateT2UI()"></select>
                    <div style="padding:8px; font-weight:bold;">X</div>
                    <select id="candFinal2" onchange="app.updateT2UI()"></select>
                </div>
            </div>

            <div class="switch-container">
                <span class="switch-label">MANUAL (%)</span>
                <label class="switch">
                    <input type="checkbox" id="t2ModeSwitch" onchange="app.toggleT2Mode(this.checked)">
                    <span class="slider"></span>
                </label>
                <span class="switch-label">ORGÂNICO</span>
            </div>
            <div style="padding:0 5px; font-size:0.65rem; color:#888; margin-bottom:10px; text-align:center;" id="t2ModeDesc">
                Você define as porcentagens finais, o sistema ajusta os votos.
            </div>

            <div style="text-align:center; border-top:1px solid #333; padding-top:10px;">
                <label id="lblT2Votes">INTENÇÃO DE VOTOS (2º TURNO)</label>
                <div id="totalSimValT2" style="font-size:1.3rem; font-weight:800; color:#4ade80; margin-bottom:10px;">100%</div>
                <div id="slidersT2"></div>
            </div>
            <button class="btn-secondary" onclick="app.openMigrationModal()"><span><i class="fas fa-exchange-alt"></i> Transferência de Votos</span><i class="fas fa-chevron-right"></i></button>
            <button class="btn-secondary" onclick="app.openStateModal(2)"><span><i class="fas fa-map-marker-alt"></i> Multiplicadores (T2)</span><i class="fas fa-chevron-right"></i></button>
            <button class="btn-primary" onclick="app.runSimulation()">CALCULAR 2º TURNO</button>
        </div>
    </aside>

    <!-- CENTRO (MAPA) -->
    <div id="map"></div>

    <!-- DIREITA (RESULTADOS) -->
    <aside class="sidebar-right" id="sidebarResults">
        <div class="header">
            <div class="header-top">
                <h2 id="regionName">Brasil</h2>
            </div>
            <div style="font-size: 0.8rem; color: var(--accent-blue); margin-top:2px;" id="regionType">Nacional</div>
        </div>
        <div style="padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color);">
            <button id="btnBack" class="btn-back" onclick="app.resetSelection()"><i class="fas fa-arrow-left"></i> Voltar para Visão Geral</button>
            <div style="font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700;">Votos Totais (Válidos)</div>
            <div id="totalVotesVal" style="font-size: 1.6rem; font-weight: 800; color: white;">-</div>
        </div>
        <div class="controls" id="resultsContainer"></div>
    </aside>

    <div class="map-controls">
        <div class="map-btn map-btn-dl" title="Baixar PNG" onclick="app.generateStaticMap('png')"><i class="fas fa-image"></i></div>
        <div class="map-btn map-btn-dl" title="Baixar Vetor SVG" onclick="app.generateStaticMap('svg')"><i class="fas fa-bezier-curve"></i></div>
        <div style="height:5px;"></div>
        <div class="map-btn" onclick="app.map.zoomIn()">+</div>
        <div class="map-btn" onclick="app.map.zoomOut()">-</div>
    </div>

    <div class="legend">
        <div style="font-size: 0.8rem; margin-bottom: 8px; font-weight: 700; color: white;">Percentual do Vencedor</div>
        <div class="legend-grid" id="legendColors"></div>
        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa; margin-top:5px;">
            <span>&le;20%</span><span>100%</span>
        </div>
    </div>

    <!-- NAV BAR MOBILE -->
    <div class="mobile-nav">
        <div class="nav-item active" id="navMap" onclick="app.mobileNav('map')">
            <i class="fas fa-map"></i>
            <span>Mapa</span>
        </div>
        <div class="nav-item" id="navConfig" onclick="app.mobileNav('config')">
            <i class="fas fa-sliders-h"></i>
            <span>Config</span>
        </div>
        <div class="nav-item" id="navResults" onclick="app.mobileNav('results')">
            <i class="fas fa-chart-bar"></i>
            <span>Resultados</span>
        </div>
    </div>
</div>

<script>
const STATES = [{sigla:'AC', nome:'Acre', id:'12'}, {sigla:'AL', nome:'Alagoas', id:'27'}, {sigla:'AP', nome:'Amapá', id:'16'}, {sigla:'AM', nome:'Amazonas', id:'13'}, {sigla:'BA', nome:'Bahia', id:'29'}, {sigla:'CE', nome:'Ceará', id:'23'}, {sigla:'DF', nome:'Distrito Federal', id:'53'}, {sigla:'ES', nome:'Espírito Santo', id:'32'}, {sigla:'GO', nome:'Goiás', id:'52'}, {sigla:'MA', nome:'Maranhão', id:'21'}, {sigla:'MT', nome:'Mato Grosso', id:'51'}, {sigla:'MS', nome:'Mato Grosso do Sul', id:'50'}, {sigla:'MG', nome:'Minas Gerais', id:'31'}, {sigla:'PA', nome:'Pará', id:'15'}, {sigla:'PB', nome:'Paraíba', id:'25'}, {sigla:'PR', nome:'Paraná', id:'41'}, {sigla:'PE', nome:'Pernambuco', id:'26'}, {sigla:'PI', nome:'Piauí', id:'22'}, {sigla:'RJ', nome:'Rio de Janeiro', id:'33'}, {sigla:'RN', nome:'Rio Grande do Norte', id:'24'}, {sigla:'RS', nome:'Rio Grande do Sul', id:'43'}, {sigla:'RO', nome:'Rondônia', id:'11'}, {sigla:'RR', nome:'Roraima', id:'14'}, {sigla:'SC', nome:'Santa Catarina', id:'42'}, {sigla:'SP', nome:'São Paulo', id:'35'}, {sigla:'SE', nome:'Sergipe', id:'28'}, {sigla:'TO', nome:'Tocantins', id:'17'}];

const CONFIG = {
    candidates: [
        { id: 'LULA', name: 'Lula', party: 'PT', val: 40, color: '#E12525', active: true },
        { id: 'FLAVIO', name: 'Flávio Bolsonaro', party: 'PL', val: 25, color: '#5756d6', active: true },
        { id: 'TARCISIO', name: 'Tarcísio', party: 'REP', val: 15, color: '#28a745', active: false }, 
        { id: 'RENAN', name: 'Renan Santos', party: 'MISSÃO', val: 3, color: '#D4AF37', active: true },
        { id: 'CAIADO', name: 'Ronaldo Caiado', party: 'UNIÃO', val: 8, color: '#009EE3', active: true },
        { id: 'ZEMA', name: 'Romeu Zema', party: 'NOVO', val: 6, color: '#F58220', active: true },
        { id: 'RATINHO', name: 'Ratinho Jr', party: 'PSD', val: 4, color: '#FAA21B', active: true },
        { id: 'CIRO', name: 'Ciro Gomes', party: 'PDT', val: 2, color: '#003399', active: true },
        { id: 'ALDO', name: 'Aldo Rebelo', party: 'DC', val: 1, color: '#006400', active: true }
    ],
    scheme: [
        { min: 0, mix: '#ffffff', ratio: 0.85, ref: '#E6E6E6' },
        { min: 20, mix: '#ffffff', ratio: 0.85, ref: '#E6E6E6' },
        { min: 30, mix: '#ffffff', ratio: 0.65, ref: '#CCCCCC' },
        { min: 40, mix: '#ffffff', ratio: 0.45, ref: '#B2B2B2' },
        { min: 50, mix: '#ffffff', ratio: 0.25, ref: '#999999' },
        { min: 60, mix: '#000000', ratio: 0.10, ref: '#808080' },
        { min: 70, mix: '#000000', ratio: 0.25, ref: '#666666' },
        { min: 80, mix: '#000000', ratio: 0.45, ref: '#4D4D4D' },
        { min: 90, mix: '#000000', ratio: 0.60, ref: '#343434' },
        { min: 100,mix: '#000000', ratio: 0.75, ref: '#202020' }
    ]
};

const DEFAULT_SCENARIO = {
  "t1_polls": {
    "LULA": 47,
    "FLAVIO": 32,
    "TARCISIO": 31,
    "RENAN": 4,
    "CAIADO": 9,
    "ZEMA": 6,
    "RATINHO": 7,
    "CIRO": 3,
    "ALDO": 1
  },
  "t1_matrix": {
    "LULA": {
      "LULA": 0.85,
      "FLAVIO": 0,
      "TARCISIO": 0.05,
      "RENAN": 0,
      "CAIADO": 0,
      "ZEMA": 0,
      "RATINHO": 0.02,
      "CIRO": 0.05,
      "ALDO": 0.03
    },
    "JAIR": {
      "LULA": 0,
      "FLAVIO": 0.75,
      "TARCISIO": 0.8,
      "RENAN": 0.02,
      "CAIADO": 0.05,
      "ZEMA": 0.04,
      "RATINHO": 0.03,
      "CIRO": 0,
      "ALDO": 0.01
    },
    "CIRO": {
      "LULA": 0.3,
      "FLAVIO": 0,
      "TARCISIO": 0.1,
      "RENAN": 0,
      "CAIADO": 0,
      "ZEMA": 0.1,
      "RATINHO": 0,
      "CIRO": 0.4,
      "ALDO": 0
    },
    "SIMONE": {
      "LULA": 0.3,
      "FLAVIO": 0,
      "TARCISIO": 0.15,
      "RENAN": 0,
      "CAIADO": 0.15,
      "ZEMA": 0.15,
      "RATINHO": 0,
      "CIRO": 0,
      "ALDO": 0.1
    }
  },
  "t1_matrix_state": {
    "12": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.75,
        "TARCISIO": 0.8,
        "RENAN": 0.02,
        "CAIADO": 0.05,
        "ZEMA": 0.04,
        "RATINHO": 0.03,
        "CIRO": 0,
        "ALDO": 0.01
      }
    },
    "27": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.75,
        "TARCISIO": 0.8,
        "RENAN": 0.02,
        "CAIADO": 0.05,
        "ZEMA": 0.04,
        "RATINHO": 0.03,
        "CIRO": 0,
        "ALDO": 0.01
      }
    },
    "31": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.85,
        "TARCISIO": 0.87,
        "RENAN": 0.02,
        "CAIADO": 0.03,
        "ZEMA": 0.4,
        "RATINHO": 0.03,
        "CIRO": 0,
        "ALDO": 0.01
      }
    },
    "33": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.88,
        "TARCISIO": 0.8,
        "RENAN": 0.02,
        "CAIADO": 0.04,
        "ZEMA": 0.04,
        "RATINHO": 0.03,
        "CIRO": 0,
        "ALDO": 0.01
      }
    },
    "35": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.83,
        "TARCISIO": 0.85,
        "RENAN": 0.06,
        "CAIADO": 0.04,
        "ZEMA": 0.04,
        "RATINHO": 0.03,
        "CIRO": 0,
        "ALDO": 0.01
      }
    },
    "41": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.86,
        "TARCISIO": 0.88,
        "RENAN": 0.02,
        "CAIADO": 0.03,
        "ZEMA": 0.03,
        "RATINHO": 0.15,
        "CIRO": 0,
        "ALDO": 0.01
      },
      "LULA": {
        "LULA": 0.8,
        "FLAVIO": 0,
        "TARCISIO": 0.05,
        "RENAN": 0,
        "CAIADO": 0,
        "ZEMA": 0,
        "RATINHO": 0.05,
        "CIRO": 0.05,
        "ALDO": 0.03
      },
      "SIMONE": {
        "LULA": 0.3,
        "FLAVIO": 0,
        "TARCISIO": 0.15,
        "RENAN": 0,
        "CAIADO": 0.15,
        "ZEMA": 0.15,
        "RATINHO": 0.5,
        "CIRO": 0,
        "ALDO": 0.1
      }
    },
    "42": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.85,
        "TARCISIO": 0.88,
        "RENAN": 0.02,
        "CAIADO": 0.05,
        "ZEMA": 0.04,
        "RATINHO": 0.16,
        "CIRO": 0,
        "ALDO": 0.01
      }
    },
    "50": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.83,
        "TARCISIO": 0.85,
        "RENAN": 0.02,
        "CAIADO": 0.08,
        "ZEMA": 0.03,
        "RATINHO": 0.02,
        "CIRO": 0,
        "ALDO": 0.01
      }
    },
    "52": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.93,
        "TARCISIO": 0.97,
        "RENAN": 0.02,
        "CAIADO": 0.11,
        "ZEMA": 0.02,
        "RATINHO": 0.02,
        "CIRO": 0,
        "ALDO": 0.01
      },
      "LULA": {
        "LULA": 0.8,
        "FLAVIO": 0,
        "TARCISIO": 0.05,
        "RENAN": 0,
        "CAIADO": 0.05,
        "ZEMA": 0,
        "RATINHO": 0.02,
        "CIRO": 0.05,
        "ALDO": 0.03
      },
      "CIRO": {
        "LULA": 0.3,
        "FLAVIO": 0,
        "TARCISIO": 0.1,
        "RENAN": 0,
        "CAIADO": 0.15,
        "ZEMA": 0.1,
        "RATINHO": 0,
        "CIRO": 0.4,
        "ALDO": 0
      },
      "SIMONE": {
        "LULA": 0.3,
        "FLAVIO": 0,
        "TARCISIO": 0.15,
        "RENAN": 0,
        "CAIADO": 0.34,
        "ZEMA": 0.15,
        "RATINHO": 0,
        "CIRO": 0,
        "ALDO": 0.1
      }
    },
    "53": {
      "JAIR": {
        "LULA": 0,
        "FLAVIO": 0.82,
        "TARCISIO": 0.8,
        "RENAN": 0.02,
        "CAIADO": 0.04,
        "ZEMA": 0.02,
        "RATINHO": 0.01,
        "CIRO": 0,
        "ALDO": 0.01
      }
    }
  },
  "t1_mults": {
    "21": {
      "LULA": 0.94
    },
    "23": {
      "CIRO": 1.1
    },
    "31": {
      "ZEMA": 1
    },
    "32": {
      "TARCISIO": 1.1
    },
    "33": {
      "FLAVIO": 1.1,
      "TARCISIO": 1.1
    },
    "35": {
      "TARCISIO": 1.15,
      "FLAVIO": 1.1
    },
    "41": {
      "RATINHO": 1,
      "TARCISIO": 1.1,
      "FLAVIO": 1.1
    },
    "50": {
      "TARCISIO": 1.1,
      "FLAVIO": 1.1
    },
    "51": {
      "TARCISIO": 1.1
    },
    "52": {
      "CAIADO": 1,
      "TARCISIO": 1.1
    }
  },
  "t2_migr": {
    "RENAN": 0.55,
    "CAIADO": 0.64,
    "ZEMA": 0.72,
    "RATINHO": 0.66,
    "CIRO": 0.21,
    "ALDO": 0.34,
    "FLAVIO": 0.9
  },
  "t2_mults": {
    "11": {
      "FLAVIO": 1.2,
      "TARCISIO": 1.1,
      "LULA": 0.9
    },
    "12": {
      "FLAVIO": 1.2,
      "TARCISIO": 1.1,
      "LULA": 0.9
    },
    "13": {
      "LULA": 0.9,
      "FLAVIO": 1.1
    },
    "14": {
      "FLAVIO": 1.2,
      "TARCISIO": 1.1,
      "LULA": 0.9
    },
    "15": {
      "FLAVIO": 1.1,
      "LULA": 0.9
    },
    "16": {
      "FLAVIO": 1.1,
      "LULA": 0.9
    },
    "17": {
      "FLAVIO": 1.1,
      "LULA": 0.9
    },
    "21": {
      "LULA": 0.95,
      "FLAVIO": 1.05
    },
    "23": {
      "LULA": 0.9
    },
    "29": {
      "LULA": 1.05
    },
    "31": {
      "FLAVIO": 1.05,
      "LULA": 0.95
    },
    "32": {
      "FLAVIO": 1.05,
      "LULA": 0.95
    },
    "33": {
      "FLAVIO": 1.05,
      "LULA": 0.9
    },
    "35": {
      "FLAVIO": 1.1,
      "LULA": 0.9
    },
    "41": {
      "FLAVIO": 1.1,
      "TARCISIO": 1.2,
      "LULA": 0.9
    },
    "42": {
      "FLAVIO": 1.2,
      "TARCISIO": 1.2,
      "LULA": 0.8
    },
    "43": {
      "FLAVIO": 1.1,
      "LULA": 0.95
    },
    "51": {
      "FLAVIO": 1.12,
      "TARCISIO": 1.2,
      "LULA": 0.88
    }
  },
  "active_candidates": {
    "LULA": true,
    "FLAVIO": true,
    "TARCISIO": false,
    "RENAN": true,
    "CAIADO": true,
    "ZEMA": false,
    "RATINHO": true,
    "CIRO": false,
    "ALDO": true
  },
  "t2_mode": "organic"
};

const app = {
    map: null,
    layers: { brazil: null, cities: null },
    data: { base22: null, round1: null, round2: null, geoJson: null, names: {}, brazilGeoJson: null },
    state: { turn: 1, view: 'states', selectedId: null, selectedName: "Brasil", t1_polls: {}, t1_matrix: {}, t1_matrix_state: {}, t1_mults: {}, t2_finalists: [], t2_polls: {}, t2_migr: {}, t2_mults: {}, active_candidates: {}, t2_mode: 'manual' },

    init: async () => {
        app.map = L.map('map', { center: [-15, -50], zoom: 4, zoomControl: false, preferCanvas: true, background: '#1a1a1a', renderer: L.canvas({ tolerance: 0, padding: 0.5 }) });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.4 }).addTo(app.map);
        if(typeof DEFAULT_SCENARIO !== 'undefined') app.loadScenario(DEFAULT_SCENARIO);
        else { CONFIG.candidates.forEach(c => { app.state.t1_polls[c.id] = c.val; app.state.active_candidates[c.id] = c.active; }); ['LULA','JAIR','CIRO','SIMONE'].forEach(src => { app.state.t1_matrix[src] = {}; CONFIG.candidates.forEach(dest => app.state.t1_matrix[src][dest.id] = 0); }); }
        app.renderLegend(); app.renderUI(); await app.loadData();
    },

    // --- MOBILE NAVIGATION LOGIC ---
    mobileNav: (tab) => {
        const left = document.getElementById('sidebarConfig');
        const right = document.getElementById('sidebarResults');
        const items = document.querySelectorAll('.nav-item');
        
        items.forEach(i => i.classList.remove('active'));
        document.getElementById('nav' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

        if(tab === 'map') {
            left.classList.remove('active');
            right.classList.remove('active');
        } else if(tab === 'config') {
            left.classList.add('active');
            right.classList.remove('active');
        } else if(tab === 'results') {
            right.classList.add('active');
            left.classList.remove('active');
        }
    },

    loadScenario: (config) => {
        ['t1_polls','t1_matrix','t1_matrix_state','t1_mults','t2_migr','t2_mults','active_candidates'].forEach(k => { if(config[k]) app.state[k] = JSON.parse(JSON.stringify(config[k])); });
        if(config.t2_mode) { app.state.t2_mode = config.t2_mode; if(document.getElementById('t2ModeSwitch')) document.getElementById('t2ModeSwitch').checked = (config.t2_mode === 'organic'); }
    },

    loadData: async () => {
        const loader = document.getElementById('loader');
        try { const res = await fetch('data/2022_president.json'); const json = await res.json(); app.data.base22 = json['1']; app.data.names = json['1'].meta_nomes || {}; await app.loadBrazilLayer(); app.runSimulation(); } catch(e) { console.error(e); alert("Erro dados. Verifique data/2022_president.json"); } finally { loader.classList.add('hidden'); }
    },

    exportConfig: () => { const config = { t1_polls: app.state.t1_polls, t1_matrix: app.state.t1_matrix, t1_matrix_state: app.state.t1_matrix_state, t1_mults: app.state.t1_mults, t2_migr: app.state.t2_migr, t2_mults: app.state.t2_mults, active_candidates: app.state.active_candidates, t2_mode: app.state.t2_mode }; saveAs(new Blob([JSON.stringify(config, null, 2)], {type: "application/json;charset=utf-8"}), "eleicoes_config.json"); },
    importConfig: (input) => { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { app.loadScenario(JSON.parse(e.target.result)); app.renderUI(); app.runSimulation(); alert("Configuração carregada com sucesso!"); } catch(err) { alert("Erro JSON: " + err.message); } }; reader.readAsText(file); input.value = ''; },

    setTurn: (t) => {
        app.state.turn = t;
        document.getElementById('tab1').className = `mode-tab ${t===1?'active':''}`; document.getElementById('tab2').className = `mode-tab ${t===2?'active':''}`;
        document.getElementById('controlsT1').style.display = t===1?'flex':'none'; document.getElementById('controlsT2').style.display = t===2?'flex':'none';
        if(t === 2 && app.state.t2_finalists.length === 0 && app.data.round1) {
            const nac = app.data.round1.nacional; const sorted = Object.entries(nac).sort((a,b)=>b[1]-a[1]);
            if(sorted.length >= 2) { app.state.t2_finalists = [sorted[0][0], sorted[1][0]]; app.updateT2UI(); }
        }
        app.runSimulation();
    },

    toggleT2Mode: (isOrganic) => {
        app.state.t2_mode = isOrganic ? 'organic' : 'manual';
        document.getElementById('t2ModeDesc').innerText = isOrganic ? "Resultado calculado apenas pela migração." : "Você define porcentagens, o sistema ajusta.";
        document.getElementById('lblT2Votes').innerText = isOrganic ? "RESULTADO (ORGÂNICO)" : "META (MANUAL)";
        app.updateT2UI(); app.runSimulation();
    },

    handleViewChange: async () => { app.state.view = document.getElementById('viewModeSelect').value; if(app.state.view === 'all_cities') await app.loadAllMunicipalities(); else app.resetMapToStates(); },
    getFeatureId: (feature, scope) => { const p = feature.properties; if (scope === 'municipios') return String(p.CD_MUN || p.id || p.geocodigo || ''); return String(p.CD_UF || (STATES.find(x => x.sigla === p.sigla)||{}).id || p.id || ''); },

    loadBrazilLayer: async () => { if(app.layers.brazil) { if(!app.map.hasLayer(app.layers.brazil)) app.layers.brazil.addTo(app.map); app.layers.brazil.setStyle((f) => app.getStyle(f, 'estados')); return; } const res = await fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson'); app.data.brazilGeoJson = await res.json(); app.layers.brazil = L.geoJSON(app.data.brazilGeoJson, { style: (f) => app.getStyle(f, 'estados'), onEachFeature: (f, l) => { l.on('click', () => { if(app.state.view === 'states') app.loadStateCities(app.getFeatureId(f,'estados'), f.properties.NM_UF || f.properties.name); }); app.bindTooltip(l, 'estados'); } }).addTo(app.map); },
    loadAllMunicipalities: async () => { const loader = document.getElementById('loader'); loader.classList.remove('hidden'); if(app.layers.brazil && app.map.hasLayer(app.layers.brazil)) app.map.removeLayer(app.layers.brazil); if(app.layers.cities) app.map.removeLayer(app.layers.cities); app.layers.cities = null; if(!app.data.geoJson) { const r = await fetch("https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json"); app.data.geoJson = await r.json(); } app.layers.cities = L.geoJSON(app.data.geoJson, { style: (f) => app.getStyle(f, 'municipios'), onEachFeature: (f, l) => { l.on('click', (e) => { L.DomEvent.stopPropagation(e); app.selectRegion(app.getFeatureId(f,'municipios'), f.properties.NM_MUN||f.properties.name); }); app.bindTooltip(l, 'municipios'); } }).addTo(app.map); if (app.layers.cities.getBounds().isValid()) app.map.fitBounds(app.layers.cities.getBounds()); loader.classList.add('hidden'); },
    loadStateCities: async (ufId, ufName) => { if(app.state.view === 'all_cities') return; const loader = document.getElementById('loader'); loader.classList.remove('hidden'); document.getElementById('loaderMsg').innerText = `Carregando ${ufName}...`; if(app.layers.cities) { app.map.removeLayer(app.layers.cities); app.layers.cities = null; } if(app.layers.brazil) app.map.removeLayer(app.layers.brazil); if(!app.data.geoJson) { const r = await fetch("https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json"); app.data.geoJson = await r.json(); } const feats = app.data.geoJson.features.filter(f => app.getFeatureId(f, 'municipios').startsWith(ufId)); app.layers.cities = L.geoJSON({ type:"FeatureCollection", features:feats }, { style: (f) => app.getStyle(f, 'municipios'), onEachFeature: (f, l) => { l.on('click', (e) => { L.DomEvent.stopPropagation(e); app.selectRegion(app.getFeatureId(f,'municipios'), f.properties.NM_MUN||f.properties.name); }); app.bindTooltip(l, 'municipios'); } }).addTo(app.map); if (app.layers.cities.getBounds().isValid()) app.map.fitBounds(app.layers.cities.getBounds()); app.selectRegion(ufId, ufName); loader.classList.add('hidden'); },
    resetMapToStates: () => { if(app.layers.cities) { app.map.removeLayer(app.layers.cities); app.layers.cities = null; } if(app.layers.brazil) { if(!app.map.hasLayer(app.layers.brazil)) app.layers.brazil.addTo(app.map); app.layers.brazil.setStyle((f) => app.getStyle(f, 'estados')); } else app.loadBrazilLayer(); app.map.setView([-15, -50], 4); app.resetSelection(); },
    getStyle: (feature, scope) => { const id = app.getFeatureId(feature, scope); return { fillColor: app.getColorForId(id, scope).fill, weight: scope === 'estados' ? 0.8 : 0.5, color: '#ffffff', opacity: 1, fillOpacity: 1 }; },
    getColorForId: (id, scope) => { if (!id) return { fill: '#333' }; const dataset = app.state.turn === 1 ? app.data.round1 : app.data.round2; if(!dataset) return { fill: '#333' }; const votes = (id.length === 2 && scope === 'estados') ? dataset.estados[id] : dataset.municipios[id]; if(!votes) return { fill: '#333' }; let max = -1, winner = null, total = 0; for(let c in votes) { total += votes[c]; if(votes[c] > max) { max = votes[c]; winner = c; } } const cand = CONFIG.candidates.find(c => c.id === winner); return { fill: app.getDiscreteColor(cand ? cand.color : '#555', total > 0 ? (max/total)*100 : 0) }; },
    generateStaticMap: async (format) => { const loader = document.getElementById('loader'); loader.classList.remove('hidden'); setTimeout(() => { try { let features = []; let scope = 'municipios'; if (app.state.view === 'states' && !app.state.selectedId) { features = app.data.brazilGeoJson.features; scope = 'estados'; } else if (app.state.selectedId && app.state.selectedId.length === 2) { features = app.data.geoJson.features.filter(f => app.getFeatureId(f, 'municipios').startsWith(app.state.selectedId)); scope = 'municipios'; } else if (app.state.view === 'all_cities') { features = app.data.geoJson.features; scope = 'municipios'; } else { features = app.data.brazilGeoJson.features; scope = 'estados'; } if (features.length === 0) throw new Error("Nenhum dado."); let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity; features.forEach(f => { const scan = (coords) => { coords.forEach(pt => { if(typeof pt[0]==='number'){ if(pt[0]<minX)minX=pt[0]; if(pt[0]>maxX)maxX=pt[0]; if(pt[1]<minY)minY=pt[1]; if(pt[1]>maxY)maxY=pt[1]; } else scan(pt); }); }; if(f.geometry.type.includes('Polygon')) scan(f.geometry.coordinates); }); const w = 4096, latD = maxY - minY, lonD = maxX - minX, h = w / (lonD/latD); const proj = (x,y) => [(x-minX)*(w/lonD), (maxY-y)*(h/latD)]; let svg = ''; features.forEach(f => { const id = app.getFeatureId(f, scope); const col = app.getColorForId(id, scope).fill; let d = ''; const draw = (r) => { let p=''; r.forEach((pt,i)=>{ const[px,py]=proj(pt[0],pt[1]); p+=(i===0?'M':'L')+px.toFixed(1)+','+py.toFixed(1); }); return p+'Z '; }; if(f.geometry.type==='Polygon') f.geometry.coordinates.forEach(r=>d+=draw(r)); else if(f.geometry.type==='MultiPolygon') f.geometry.coordinates.forEach(p=>p.forEach(r=>d+=draw(r))); svg+=`<path d="${d}" fill="${col}" stroke="#fff" stroke-width="${scope==='estados'?2:0.5}"/>`; }); const finalSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}">${svg}</svg>`; const fname = `mapa_${app.state.selectedName}_${scope}`; if(format==='svg') saveAs(new Blob([finalSvg],{type:"image/svg+xml;charset=utf-8"}), `${fname}.svg`); else { const img=new Image(); img.onload=()=>{const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0);c.toBlob(b=>saveAs(b,`${fname}.png`));}; img.src='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(finalSvg))); } } catch(e){ alert(e.message); } loader.classList.add('hidden'); }, 100); },
    getDiscreteColor: (hex, pct) => { let config = CONFIG.scheme[0]; for (let i = 0; i < CONFIG.scheme.length; i++) if (pct >= CONFIG.scheme[i].min) config = CONFIG.scheme[i]; return app.mixColor(hex, config.mix, config.ratio); },
    mixColor: (hex1, hex2, amount) => { const c1 = app.hexToRgb(hex1), c2 = app.hexToRgb(hex2); return `rgb(${Math.round(c1.r + (c2.r - c1.r) * amount)}, ${Math.round(c1.g + (c2.g - c1.g) * amount)}, ${Math.round(c1.b + (c2.b - c1.b) * amount)})`; },
    hexToRgb: (hex) => { let c = hex.substring(1).split(''); if(c.length==3) c= [c[0], c[0], c[1], c[1], c[2], c[2]]; c = '0x'+c.join(''); return { r: (c>>16)&255, g: (c>>8)&255, b: c&255 }; },
    bindTooltip: (l, s) => { l.bindTooltip(() => { const id = app.getFeatureId(l.feature, s); const dataset = app.state.turn === 1 ? app.data.round1 : app.data.round2; if(!dataset) return "Dados indisponíveis"; const votes = (id.length===2 && s==='estados') ? dataset.estados[id] : dataset.municipios[id]; if(!votes) return `Sem dados`; const sorted = Object.entries(votes).sort((a,b)=>b[1]-a[1]); const wObj = CONFIG.candidates.find(c=>c.id===sorted[0][0]); return `<div class="custom-tooltip"><div class="tt-head">${l.feature.properties.NM_MUN || l.feature.properties.NM_UF || l.feature.properties.name}</div><div class="tt-body"><div style="color:${wObj.color}; font-weight:800">${wObj.name}</div><div>${((sorted[0][1]/(sorted.reduce((a,b)=>a+b[1],0)||1))*100).toFixed(1)}%</div></div></div>`; }, { sticky: true }); },
    refreshMap: () => { if(app.layers.brazil) app.layers.brazil.setStyle((f) => app.getStyle(f, 'estados')); if(app.layers.cities) app.layers.cities.setStyle((f) => app.getStyle(f, 'municipios')); },
    renderLegend: () => { const el = document.getElementById('legendColors'); el.innerHTML = ''; CONFIG.scheme.forEach(s => { if(s.min >= 20) { const d = document.createElement('div'); d.className = 'legend-item'; d.style.background = s.ref; el.appendChild(d); } }); },
    
    renderUI: () => {
        const c = document.getElementById('slidersT1'); c.innerHTML = '';
        CONFIG.candidates.forEach(cand => {
            const isActive = app.state.active_candidates[cand.id] !== false;
            const div = document.createElement('div'); div.className = `slider-box ${isActive ? '' : 'inactive'}`;
            div.innerHTML = `<div class="slider-header"><div class="slider-check-group"><input type="checkbox" ${isActive ? 'checked' : ''} onchange="app.toggleCandidate('${cand.id}', this.checked)"><span style="color:${cand.color}; font-weight:700">${cand.name}</span></div><span id="val_t1_${cand.id}">${app.state.t1_polls[cand.id]}%</span></div><input type="range" min="0" max="100" value="${app.state.t1_polls[cand.id]}" ${isActive ? '' : 'disabled'} oninput="app.updateT1Poll('${cand.id}', this.value)">`;
            c.appendChild(div);
        });
        const c1 = document.getElementById('candFinal1'), c2 = document.getElementById('candFinal2');
        const activeCands = CONFIG.candidates.filter(c => app.state.active_candidates[c.id] !== false);
        const opts = activeCands.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); c1.innerHTML = opts; c2.innerHTML = opts;
        if(activeCands.length >= 2) { if(!activeCands.find(c=>c.id === app.state.t2_finalists[0])) app.state.t2_finalists[0] = activeCands[0].id; if(!activeCands.find(c=>c.id === app.state.t2_finalists[1])) app.state.t2_finalists[1] = activeCands[1].id; c1.value = app.state.t2_finalists[0]; c2.value = app.state.t2_finalists[1]; }
        app.updateTotalT1Label(); app.updateT2UI();
    },

    toggleCandidate: (id, checked) => { app.state.active_candidates[id] = checked; if(checked && app.state.t1_polls[id] === 0) app.state.t1_polls[id] = 5; app.renderUI(); app.runSimulation(); },
    updateT1Poll: (id, val) => { app.state.t1_polls[id] = parseInt(val); document.getElementById(`val_t1_${id}`).innerText = val + "%"; app.updateTotalT1Label(); },
    updateTotalT1Label: () => { const tot = CONFIG.candidates.filter(c => app.state.active_candidates[c.id]!==false).reduce((a,c) => a + (app.state.t1_polls[c.id]||0), 0); const el = document.getElementById('totalSimVal'); el.innerText = tot + "%"; el.style.color = tot===100?'#4ade80':'#facc15'; },

    updateT2UI: () => {
        const c1 = document.getElementById('candFinal1'), c2 = document.getElementById('candFinal2');
        if(!c1.value || !c2.value) return;
        if (c1.value === c2.value) { const active = CONFIG.candidates.filter(c => app.state.active_candidates[c.id]!==false); if(active.length > 1) c2.value = active.find(c => c.id !== c1.value).id; }
        app.state.t2_finalists = [c1.value, c2.value];
        const slidersDiv = document.getElementById('slidersT2'); slidersDiv.innerHTML = '';
        [CONFIG.candidates.find(c=>c.id===c1.value), CONFIG.candidates.find(c=>c.id===c2.value)].forEach(cand => {
            if(!cand) return;
            const current = app.state.t2_polls[cand.id] !== undefined ? app.state.t2_polls[cand.id] : 50;
            const div = document.createElement('div'); div.className = `slider-box ${app.state.t2_mode === 'organic' ? 'inactive' : ''}`;
            div.innerHTML = `<div class="slider-header"><span style="color:${cand.color}; font-weight:700">${cand.name}</span><span id="val_t2_${cand.id}">${current}%</span></div><input type="range" min="0" max="100" value="${current}" ${app.state.t2_mode === 'organic' ? 'disabled' : ''} oninput="app.state.t2_polls['${cand.id}'] = parseInt(this.value); document.getElementById('val_t2_${cand.id}').innerText=this.value+'%'; app.checkT2Total();">`;
            slidersDiv.appendChild(div);
        });
        app.checkT2Total();
    },
    checkT2Total: () => { const [id1, id2] = app.state.t2_finalists; const tot = (app.state.t2_polls[id1]||0) + (app.state.t2_polls[id2]||0); const el = document.getElementById('totalSimValT2'); el.innerText = tot + "%"; el.style.color = tot===100?'#4ade80':'#facc15'; },
    
    selectRegion: (id, name) => {
        app.state.selectedId = id; app.state.selectedName = name;
        document.getElementById('btnBack').style.display = 'flex';
        if(window.innerWidth <= 768) app.mobileNav('results'); // Mobile: Abre resultados
        app.updateSidebarRight();
    },
    resetSelection: () => {
        app.state.selectedId = null; app.state.selectedName = "Brasil";
        document.getElementById('btnBack').style.display = 'none';
        if (app.layers.cities) { app.map.removeLayer(app.layers.cities); app.layers.cities = null; }
        if (app.layers.brazil) { if (!app.map.hasLayer(app.layers.brazil)) app.layers.brazil.addTo(app.map); app.layers.brazil.setStyle((f) => app.getStyle(f, 'estados')); } else app.loadBrazilLayer();
        app.map.setView([-15, -50], 4);
        document.getElementById('viewModeSelect').value = 'states'; app.state.view = 'states';
        if(window.innerWidth <= 768) app.mobileNav('config'); // Mobile: Volta config
        app.updateSidebarRight();
    },
    updateSidebarRight: () => {
        const title = document.getElementById('regionName'), sub = document.getElementById('regionType'), list = document.getElementById('resultsContainer');
        title.innerText = app.state.selectedName; sub.innerText = app.state.selectedId ? (app.state.selectedId.length===2 ? "Estado" : "Município") : "Nacional";
        list.innerHTML = '';
        const dataset = app.state.turn === 1 ? app.data.round1 : app.data.round2; if(!dataset) return;
        let votes = {};
        if(app.state.selectedId) { if(app.state.selectedId.length === 2) votes = dataset.estados[app.state.selectedId]; else votes = dataset.municipios[app.state.selectedId]; } else votes = dataset.nacional;
        if(!votes) return;
        const sorted = Object.entries(votes).sort((a,b)=>b[1]-a[1]);
        const total = sorted.reduce((a,b)=>a+b[1],0); 
        
        if(document.getElementById('totalVotesVal')) document.getElementById('totalVotesVal').innerText = total.toLocaleString();

        sorted.forEach(([cid, v]) => {
            const cand = CONFIG.candidates.find(c=>c.id===cid); if(!cand) return;
            if(app.state.turn===1 && app.state.active_candidates[cand.id] === false && v === 0) return;
            const pct = total > 0 ? (v/total)*100 : 0;
            const row = document.createElement('div'); row.className = 'cand-row';
            row.innerHTML = `<div class="cand-color" style="background:${cand.color}"></div><div class="cand-info"><div class="cand-head"><span>${cand.name}</span><span style="color:${cand.color}">${pct.toFixed(2)}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%; background:${cand.color}"></div></div><div style="text-align:right; font-size:0.7rem; color:#666; margin-top:3px;">${v.toLocaleString()} votos</div></div>`;
            list.appendChild(row);
        });
    },

    openModal: (title, html) => { document.getElementById('modalTitle').innerText = title; document.getElementById('modalBody').innerHTML = html; document.getElementById('modalOverlay').classList.add('active'); },
    closeModal: () => { document.getElementById('modalOverlay').classList.remove('active'); },
    
    openMatrixModal: () => {
        const sources = ['LULA','JAIR','CIRO','SIMONE'];
        let html = `<div style="display:flex; gap:10px; margin-bottom:15px;"><div style="flex:1"><label style="color:#aaa; font-size:0.8rem">FONTE (2022):</label><select id="modalSrcSelect" onchange="app.renderModalMatrix()" style="width:100%">${sources.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div><div style="flex:1"><label style="color:#aaa; font-size:0.8rem">ESTADO:</label><select id="modalUfSelect" onchange="app.renderModalMatrix()" style="width:100%"><option value="">Nacional (Padrão)</option>${STATES.map(s => `<option value="${s.id}">${s.sigla}</option>`).join('')}</select></div></div><div id="modalMatrixContent"></div><div style="font-size:0.7rem; color:#666; margin-top:10px;">* Se um Estado for selecionado, os valores substituem a regra nacional para aquele estado.</div>`;
        app.openModal("Matriz de Herança", html); app.renderModalMatrix();
    },
    renderModalMatrix: () => {
        const src = document.getElementById('modalSrcSelect') ? document.getElementById('modalSrcSelect').value : 'LULA';
        const ufId = document.getElementById('modalUfSelect') ? document.getElementById('modalUfSelect').value : '';
        const c = document.getElementById('modalMatrixContent'); c.innerHTML = '';
        CONFIG.candidates.forEach(dest => {
            let val = ufId ? (app.state.t1_matrix_state[ufId] && app.state.t1_matrix_state[ufId][src] ? app.state.t1_matrix_state[ufId][src][dest.id] : app.state.t1_matrix[src][dest.id]) : app.state.t1_matrix[src][dest.id];
            val = (val||0) * 100;
            const div = document.createElement('div'); div.className = 'slider-box';
            div.innerHTML = `<div class="slider-header"><span style="color:${dest.color}; font-weight:bold">${dest.name}</span><span id="mod_mtx_${dest.id}">${Math.round(val)}%</span></div><input type="range" min="0" max="100" value="${val}" oninput="app.updateMatrixValue('${src}', '${ufId}', '${dest.id}', this.value); document.getElementById('mod_mtx_${dest.id}').innerText=this.value+'%';">`;
            c.appendChild(div);
        });
    },
    updateMatrixValue: (src, ufId, destId, val) => {
        const ratio = parseInt(val)/100;
        if(ufId) {
            if(!app.state.t1_matrix_state[ufId]) app.state.t1_matrix_state[ufId] = {};
            if(!app.state.t1_matrix_state[ufId][src]) app.state.t1_matrix_state[ufId][src] = {...app.state.t1_matrix[src]};
            app.state.t1_matrix_state[ufId][src][destId] = ratio;
        } else app.state.t1_matrix[src][destId] = ratio;
    },

    openStateModal: (turn) => {
        let html = `<div style="margin-bottom:15px"><label style="color:#aaa; font-size:0.8rem">ESTADO:</label><select id="modalStateSelect" onchange="app.renderModalStateMults(${turn}, this.value)" style="width:100%"><option value="">Selecione...</option>${STATES.map(s => `<option value="${s.id}">${s.nome} (${s.sigla})</option>`).join('')}</select></div><div id="modalStateContent"></div>`;
        app.openModal(turn === 1 ? "Multiplicadores (1º Turno)" : "Multiplicadores (2º Turno)", html);
    },
    renderModalStateMults: (turn, ufId) => {
        const c = document.getElementById('modalStateContent'); c.innerHTML = ''; if(!ufId) return;
        const store = turn===1 ? app.state.t1_mults : app.state.t2_mults; if(!store[ufId]) store[ufId] = {};
        (turn===1 ? CONFIG.candidates : app.state.t2_finalists.map(id => CONFIG.candidates.find(c=>c.id===id))).forEach(cand => {
            if(!cand || (turn===1 && app.state.active_candidates[cand.id] === false)) return;
            const val = store[ufId][cand.id] !== undefined ? store[ufId][cand.id] : 1.0;
            const div = document.createElement('div'); div.className = 'slider-box';
            div.innerHTML = `<div class="slider-header"><span style="color:${cand.color}; font-weight:bold">${cand.name}</span><span id="mod_mul_${cand.id}">x${val.toFixed(2)}</span></div><input type="range" min="0" max="300" value="${val*100}" oninput="app.updateMult(${turn}, '${ufId}', '${cand.id}', this.value); document.getElementById('mod_mul_${cand.id}').innerText='x'+(this.value/100).toFixed(2);">`;
            c.appendChild(div);
        });
    },
    updateMult: (turn, ufId, cid, val) => { const store = turn===1 ? app.state.t1_mults : app.state.t2_mults; store[ufId][cid] = parseInt(val)/100; },
    openMigrationModal: () => {
        const [id1, id2] = app.state.t2_finalists;
        let html = `<div style="text-align:center; font-size:0.8rem; color:#888; margin-bottom:15px">Configure para quem os eleitores migrarão.<br>Esquerda (0%): <b>${CONFIG.candidates.find(c=>c.id===id1).name}</b> | Direita (100%): <b>${CONFIG.candidates.find(c=>c.id===id2).name}</b></div><div id="modalMigContent"></div>`;
        app.openModal("Transferência de Votos", html);
        const c = document.getElementById('modalMigContent');
        CONFIG.candidates.forEach(cand => {
            if(cand.id === id1 || cand.id === id2 || app.state.active_candidates[cand.id] === false) return;
            const ratio = app.state.t2_migr[cand.id] !== undefined ? app.state.t2_migr[cand.id] : 0.5;
            const div = document.createElement('div'); div.className = 'slider-box';
            div.innerHTML = `<div class="slider-header"><span style="color:${cand.color}; font-weight:bold">Votos de ${cand.name}</span></div><div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#aaa; margin-bottom:5px;"><span style="color:${CONFIG.candidates.find(x=>x.id===id1).color}">${CONFIG.candidates.find(x=>x.id===id1).name}</span><span style="color:${CONFIG.candidates.find(x=>x.id===id2).color}">${CONFIG.candidates.find(x=>x.id===id2).name}</span></div><input type="range" min="0" max="100" value="${ratio*100}" oninput="app.state.t2_migr['${cand.id}'] = this.value/100;">`;
            c.appendChild(div);
        });
    },

    getMatrixValue: (ufId, src, destId) => { return (app.state.t1_matrix_state[ufId] && app.state.t1_matrix_state[ufId][src] && app.state.t1_matrix_state[ufId][src][destId] !== undefined) ? app.state.t1_matrix_state[ufId][src][destId] : (app.state.t1_matrix[src][destId] || 0); },

    runSimulation: () => {
        if(!app.data.base22) return; const loader = document.getElementById('loader'); loader.classList.remove('hidden'); document.getElementById('loaderMsg').innerText = "Calculando...";
        setTimeout(() => { if(app.state.turn === 1) app.calculateTurn1(); else { if(!app.data.round1) app.calculateTurn1(); app.calculateTurn2(); } app.refreshMap(); app.updateSidebarRight(); loader.classList.add('hidden'); }, 50);
    },

    calculateTurn1: () => {
        const base = app.data.base22.municipios;
        const activeIds = CONFIG.candidates.filter(c => app.state.active_candidates[c.id] !== false).map(c => c.id);
        const rawSliderTotal = activeIds.reduce((sum, id) => sum + (app.state.t1_polls[id]||0), 0);
        const targetPcts = {}; activeIds.forEach(id => { targetPcts[id] = (app.state.t1_polls[id]||0) / (rawSliderTotal || 1); });
        const res = { municipios: {}, estados: {}, nacional: {} }; let tempNacional = {}, grandTotal = 0;
        for(let ibge in base) {
            const votes22 = base[ibge], ufId = ibge.substring(0,2), mVotes = {};
            activeIds.forEach(candId => {
                let sum = 0;
                ['LULA','JAIR','CIRO','SIMONE'].forEach(srcKey => {
                    const rawVal = app.getMatrixValue(ufId, srcKey, candId);
                    let totalActiveWeight = 0; activeIds.forEach(cid => { totalActiveWeight += app.getMatrixValue(ufId, srcKey, cid); });
                    let finalFactor = 0; if(totalActiveWeight > 0) finalFactor = rawVal / totalActiveWeight;
                    sum += app.getVotes22(votes22, srcKey) * finalFactor;
                });
                if(app.state.t1_mults[ufId] && app.state.t1_mults[ufId][candId]) sum *= app.state.t1_mults[ufId][candId];
                mVotes[candId] = sum; tempNacional[candId] = (tempNacional[candId]||0) + sum; grandTotal += sum;
            });
            res.municipios[ibge] = mVotes;
        }
        const corrections = {}; activeIds.forEach(id => { const currPct = tempNacional[id] / (grandTotal||1); corrections[id] = (currPct > 0) ? targetPcts[id]/currPct : 1; });
        for(let ibge in res.municipios) {
            const ufId = ibge.substring(0,2); if(!res.estados[ufId]) res.estados[ufId] = {};
            for(let cid in res.municipios[ibge]) {
                let v = Math.round(res.municipios[ibge][cid] * corrections[cid]);
                res.municipios[ibge][cid] = v; res.estados[ufId][cid] = (res.estados[ufId][cid]||0) + v; res.nacional[cid] = (res.nacional[cid]||0) + v;
            }
        }
        app.data.round1 = res;
    },
    calculateTurn2: () => {
        if(!app.data.round1) app.calculateTurn1(); const r1 = app.data.round1;
        const [id1, id2] = app.state.t2_finalists; if(!id1 || !id2) return;
        const isOrganic = app.state.t2_mode === 'organic';
        const res = { municipios: {}, estados: {}, nacional: {} }; let tempNacional = {[id1]:0, [id2]:0}, grandTotal = 0;
        for(let ibge in r1.municipios) {
            const v1 = r1.municipios[ibge], ufId = ibge.substring(0,2); let vA = 0, vB = 0;
            for(let cid in v1) {
                const votos = v1[cid]; 
                if(cid === id1) vA += votos; else if(cid === id2) vB += votos;
                else { let ratio = app.state.t2_migr[cid] !== undefined ? app.state.t2_migr[cid] : 0.5; vA += votos * (1 - ratio); vB += votos * ratio; }
            }
            if(app.state.t2_mults[ufId]) { if(app.state.t2_mults[ufId][id1]) vA *= app.state.t2_mults[ufId][id1]; if(app.state.t2_mults[ufId][id2]) vB *= app.state.t2_mults[ufId][id2]; }
            // FIX BUG DECIMAIS
            vA = Math.round(vA); vB = Math.round(vB);
            tempNacional[id1] += vA; tempNacional[id2] += vB; grandTotal += (vA + vB); res.municipios[ibge] = { [id1]: vA, [id2]: vB };
        }
        if(!isOrganic) {
            const totalSlider = (app.state.t2_polls[id1]||0) + (app.state.t2_polls[id2]||0);
            const targetPcts = { [id1]: (app.state.t2_polls[id1]||0)/(totalSlider||1), [id2]: (app.state.t2_polls[id2]||0)/(totalSlider||1) };
            const corrections = {}; [id1, id2].forEach(id => { const currPct = tempNacional[id] / (grandTotal||1); corrections[id] = (app.state.t2_polls[id]<=0) ? 0 : (currPct>0 ? targetPcts[id]/currPct : 1); });
            res.nacional = {};
            for(let ibge in res.municipios) {
                const ufId = ibge.substring(0,2); if(!res.estados[ufId]) res.estados[ufId] = {};
                [id1, id2].forEach(id => { let v = Math.round(res.municipios[ibge][id] * corrections[id]); res.municipios[ibge][id] = v; res.estados[ufId][id] = (res.estados[ufId][id]||0) + v; res.nacional[id] = (res.nacional[id]||0) + v; });
            }
        } else {
            res.nacional = tempNacional;
            for(let ibge in res.municipios) { const ufId = ibge.substring(0,2); if(!res.estados[ufId]) res.estados[ufId] = {}; [id1, id2].forEach(id => { let v = res.municipios[ibge][id]; res.estados[ufId][id] = (res.estados[ufId][id]||0) + v; }); }
            const t = grandTotal || 1;
            app.state.t2_polls[id1] = Math.round((tempNacional[id1]/t)*100); app.state.t2_polls[id2] = Math.round((tempNacional[id2]/t)*100);
            if(document.getElementById(`val_t2_${id1}`)) document.getElementById(`val_t2_${id1}`).innerText = app.state.t2_polls[id1] + '%';
            if(document.getElementById(`val_t2_${id2}`)) document.getElementById(`val_t2_${id2}`).innerText = app.state.t2_polls[id2] + '%';
            app.checkT2Total();
        }
        app.data.round2 = res;
    },
    getVotes22: (obj, key) => { let sum = 0; for(let k in obj) { if(k.toUpperCase().includes(key)) sum += obj[k]; } return sum; }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
