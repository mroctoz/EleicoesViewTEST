<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Simulator 2026 - High Fidelity</title>
    
    <!-- Dependências -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <style>
        :root {
            --bg: #0f1115; --panel: #161b22; --border: #252b36;
            --accent: #2f81f7; --text: #f0f6fc; --text-dim: #8b949e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; outline: none; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* LAYOUT */
        aside { width: 380px; background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 20; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        .sidebar-right { border-left: 1px solid var(--border); border-right: none; width: 400px; }
        #map-container { flex: 1; position: relative; background: #050505; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* HEADER & TABS */
        .header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: linear-gradient(to bottom, #1c2128, #161b22); }
        .logo { font-size: 1.1rem; font-weight: 900; letter-spacing: -0.5px; color: white; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--accent); }
        .tabs { display: flex; gap: 5px; margin-top: 15px; background: rgba(0,0,0,0.3); padding: 3px; border-radius: 6px; }
        .tab { flex: 1; text-align: center; padding: 8px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border-radius: 4px; color: var(--text-dim); transition: 0.2s; }
        .tab.active { background: var(--accent); color: white; }
        .tab:hover:not(.active) { background: rgba(255,255,255,0.05); color: white; }

        /* SCROLL AREAS */
        .scroll-y { flex: 1; overflow-y: auto; padding: 20px; }
        .scroll-y::-webkit-scrollbar { width: 6px; }
        .scroll-y::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }

        /* CANDIDATE CARDS */
        .cand-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 10px; transition: 0.2s; }
        .cand-card:hover { border-color: #444; background: rgba(255,255,255,0.04); }
        .cc-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .cc-info { display: flex; align-items: center; gap: 8px; }
        .cc-color { width: 14px; height: 14px; border-radius: 3px; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); }
        .cc-name { font-weight: 700; font-size: 0.9rem; }
        .cc-party { font-size: 0.7rem; color: var(--text-dim); }
        .cc-val { font-family: monospace; font-weight: 700; color: var(--accent); }

        /* BUTTONS */
        .btn { width: 100%; padding: 12px; border-radius: 6px; font-weight: 700; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.85rem; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(47, 129, 247, 0.2); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-sec { background: transparent; border-color: var(--border); color: var(--text-dim); margin-top: 10px; }
        .btn-sec:hover { border-color: var(--text); color: var(--text); }
        
        .map-toggles { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 400; display: flex; gap: 10px; }
        .map-btn { background: var(--panel); border: 1px solid var(--border); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .map-btn.active { background: var(--accent); border-color: var(--accent); }

        /* LEGEND */
        .legend-box { position: absolute; bottom: 30px; left: 30px; background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); z-index: 400; width: 220px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .l-title { font-size: 0.7rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; }
        .l-grid { display: flex; gap: 1px; height: 12px; border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .l-step { flex: 1; opacity: 0.8; }
        .l-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: #888; }

        /* MODAL */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal { width: 850px; max-height: 90vh; background: #121418; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; }
        .m-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .m-body { padding: 25px; overflow-y: auto; }
        
        /* TRANSFER MATRIX */
        .matrix-grid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
        .matrix-group { background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .mg-title { font-size: 0.8rem; font-weight: 700; margin-bottom: 10px; color: var(--accent); display: flex; align-items: center; gap: 5px; }
        .mg-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.8rem; }
        .mg-input { width: 55px; background: #050505; border: 1px solid #333; color: white; padding: 4px; border-radius: 4px; text-align: center; }

        /* LOADER */
        #loader { position: absolute; inset: 0; background: #0f1115; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
    <div class="spinner"></div>
    <div style="font-size:0.9rem; font-weight:600; color:#888;">Gerando Malha Eleitoral (5570 Municípios)...</div>
</div>

<!-- MODAL DE TRANSFERÊNCIA -->
<div class="modal-bg" id="configModal">
    <div class="modal">
        <div class="m-head">
            <h3>Matriz de Transferência de Votos</h3>
            <button onclick="app.toggleModal(false)" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="m-body">
            <div id="matrix-t1" style="display:block;">
                <div style="margin-bottom:15px; color:#aaa; font-size:0.85rem;">
                    Defina a origem dos votos de 2026 com base no eleitorado de 2022. 
                    <br>Ex: Quantos % dos eleitores de <b>Lula (2022)</b> votarão em cada candidato agora?
                </div>
                <div class="matrix-grid" id="matrixContainerT1"></div>
            </div>
            <div id="matrix-t2" style="display:none;">
                <div style="margin-bottom:15px; color:#aaa; font-size:0.85rem;">
                    Defina para onde vão os votos dos candidatos eliminados no 1º Turno.
                </div>
                <div class="matrix-grid" id="matrixContainerT2"></div>
            </div>
        </div>
        <div style="padding:20px; border-top:1px solid var(--border); text-align:right;">
            <button class="btn btn-primary" style="width:auto; display:inline-flex;" onclick="app.applyTransfers()">Aplicar e Simular</button>
        </div>
    </div>
</div>

<!-- SIDEBAR ESQUERDA -->
<aside>
    <div class="header">
        <div class="logo"><i class="fas fa-chart-pie"></i> ATLAS <span>V25</span></div>
        <div class="tabs">
            <div class="tab active" id="btn-t1" onclick="app.setTurn(1)">1º TURNO</div>
            <div class="tab" id="btn-t2" onclick="app.setTurn(2)">2º TURNO</div>
        </div>
    </div>

    <div class="scroll-y">
        <!-- T2 SELECTORS -->
        <div id="t2-controls" style="display:none; margin-bottom:20px; padding:10px; background:rgba(255,255,255,0.03); border-radius:8px;">
            <label style="font-size:0.7rem; color:#888; font-weight:700;">FINALISTAS</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                <select id="sel-c1" onchange="app.updateT2()" style="width:100%; padding:8px; background:#050505; color:white; border:1px solid #333; border-radius:4px;"></select>
                <select id="sel-c2" onchange="app.updateT2()" style="width:100%; padding:8px; background:#050505; color:white; border:1px solid #333; border-radius:4px;"></select>
            </div>
        </div>

        <div id="cand-list"></div>

        <button class="btn btn-sec" onclick="app.toggleModal(true)">
            <i class="fas fa-exchange-alt"></i> Configurar Transferências
        </button>
        
        <div style="margin-top:20px; padding:15px; border-top:1px solid var(--border); text-align:center;">
             <div style="font-size:0.7rem; color:#666;">TOTAL DE VOTOS</div>
             <div id="total-sum" style="font-size:1.5rem; font-weight:800; color:var(--accent);">100%</div>
        </div>
    </div>
</aside>

<!-- MAPA -->
<div id="map-container">
    <div class="map-toggles">
        <div class="map-btn active" id="view-br-mun" onclick="app.setView('br-mun')">Brasil (Mun)</div>
        <div class="map-btn" id="view-states" onclick="app.setView('states')">Estados</div>
    </div>
    
    <div id="map"></div>

    <div class="legend-box">
        <div class="l-title">Dominância do Vencedor</div>
        <div class="l-grid" id="legend-colors">
            <!-- JS generates -->
        </div>
        <div class="l-labels">
            <span>+Competitivo</span>
            <span>+Hegemônico</span>
        </div>
    </div>
</div>

<!-- SIDEBAR DIREITA (RESULTADOS) -->
<aside class="sidebar-right">
    <div class="header">
        <div class="logo">RESULTADOS <span id="res-scope" style="font-size:0.7rem; margin-left:auto; color:#666; background:#050505; padding:2px 6px; border-radius:4px;">NACIONAL</span></div>
    </div>
    <div class="scroll-y" id="results-area"></div>
</aside>

<script>
// =============================================================================
// DADOS BASE 2022 (SIMPLIFICADO POR ESTADO PARA GERAÇÃO DA MALHA)
// =============================================================================
// L = Lula, B = Bolsonaro, O = Outros/Nulos/Brancos (Residual)
const BASE_2022 = {
    '12': {l: 29.3, b: 70.7}, '27': {l: 58.7, b: 41.3}, '13': {l: 51.1, b: 48.9},
    '16': {l: 45.1, b: 54.9}, '29': {l: 72.1, b: 27.9}, '23': {l: 69.9, b: 30.1},
    '53': {l: 41.2, b: 58.8}, '32': {l: 41.9, b: 58.1}, '52': {l: 41.3, b: 58.7},
    '21': {l: 71.1, b: 28.9}, '31': {l: 50.2, b: 49.8}, '50': {l: 40.5, b: 59.5},
    '51': {l: 34.9, b: 65.1}, '15': {l: 52.1, b: 47.9}, '25': {l: 66.6, b: 33.4},
    '26': {l: 66.9, b: 33.1}, '22': {l: 76.8, b: 23.2}, '41': {l: 37.6, b: 62.4},
    '33': {l: 43.5, b: 56.5}, '24': {l: 65.1, b: 34.9}, '11': {l: 29.4, b: 70.6},
    '14': {l: 24.0, b: 76.0}, '43': {l: 43.7, b: 56.3}, '42': {l: 30.7, b: 69.3},
    '28': {l: 67.2, b: 32.8}, '35': {l: 44.7, b: 55.3}, '17': {l: 51.3, b: 48.7}
};

const INITIAL_CANDS = [
    { id: 'LULA', name: 'Lula da Silva', party: 'PT', color: '#E12525', val: 40 },
    { id: 'FLAVIO', name: 'Flávio Bolsonaro', party: 'PL', color: '#0e2f73', val: 30 },
    { id: 'TARCISIO', name: 'Tarcísio Freitas', party: 'REP', color: '#2684FF', val: 10 },
    { id: 'CIRO', name: 'Ciro Gomes', party: 'PDT', color: '#9333EA', val: 5 },
    { id: 'CAIADO', name: 'Ronaldo Caiado', party: 'UNIÃO', color: '#0EA5E9', val: 5 },
    { id: 'ZEMA', name: 'Romeu Zema', party: 'NOVO', color: '#F97316', val: 5 },
    { id: 'RENAN', name: 'Renan Santos', party: 'MISSÃO', color: '#EAB308', val: 5 }
];

const app = {
    map: null,
    layers: { states: null, muns: null },
    data: { geo: null, simResults: {} },
    state: {
        turn: 1,
        view: 'br-mun', // 'br-mun', 'states', 'single-state'
        activeState: null,
        candidates: JSON.parse(JSON.stringify(INITIAL_CANDS)),
        t2_cands: ['LULA', 'FLAVIO'],
        // MATRIZES DE TRANSFERÊNCIA
        // T1: Origem 2022 -> Destino 2026. Chaves: L22 (Lula), B22 (Bolso), O22 (Outros)
        matrixT1: {}, 
        // T2: Origem T1 -> Destino T2.
        matrixT2: {}
    },

    init: async () => {
        app.initMatrixT1();
        
        // Setup Map
        app.map = L.map('map', { 
            center: [-15, -55], zoom: 4, 
            zoomControl: false, attributionControl: false,
            preferCanvas: true // CRUCIAL para performance com 5570 polígonos
        });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 1 }).addTo(app.map);

        // Fetch Data
        try {
            // Malha Municipal Otimizada
            const res = await fetch('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json');
            const data = await res.json();
            
            // Pré-processamento: Atribuir perfil de votação 2022 a cada município
            // Para criar realismo, adicionamos "Ruído" (Noise) baseado no ID da cidade
            // Isso simula diferença Capital x Interior x Cidades Vizinhas
            data.features.forEach(f => {
                const idStr = f.properties.id.toString();
                const ufId = idStr.substring(0, 2);
                const base = BASE_2022[ufId] || {l:50, b:50};
                
                // Deterministic noise (-10% a +10%)
                const seed = (parseInt(idStr) * 9301 + 49297) % 1000;
                const noise = (seed / 1000) * 20 - 10; 

                // Salva "Perfil Genético" do município
                f.properties.perfil22 = {
                    lula: Math.max(0, Math.min(100, base.l + noise)),
                    bolso: Math.max(0, Math.min(100, base.b - noise)),
                    // Residual assume-se neutro/nulo/branco ~5-10% na realidade, 
                    // aqui simplificamos para soma 100 baseada em L e B ponderados
                };
                // Normaliza para garantir 100% (L+B apenas como proxy de polarização)
                const tot = f.properties.perfil22.lula + f.properties.perfil22.bolso;
                f.properties.perfil22.lula = (f.properties.perfil22.lula / tot) * 100;
                f.properties.perfil22.bolso = (f.properties.perfil22.bolso / tot) * 100;
            });

            app.data.geo = data;
            
            // Estados (para zoom e view states)
            const resStates = await fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson');
            const stData = await resStates.json();
            // Map IDs
            const ufMap = {'AC':'12','AL':'27','AM':'13','AP':'16','BA':'29','CE':'23','DF':'53','ES':'32','GO':'52','MA':'21','MG':'31','MS':'50','MT':'51','PA':'15','PB':'25','PE':'26','PI':'22','PR':'41','RJ':'33','RN':'24','RO':'11','RR':'14','RS':'43','SC':'42','SE':'28','SP':'35','TO':'17'};
            stData.features.forEach(f => f.properties.id = ufMap[f.properties.sigla]);
            app.data.states = stData;

            app.renderUI();
            app.runSimulation();
            
            document.getElementById('loader').style.display = 'none';

        } catch (e) {
            console.error(e);
            alert("Erro ao carregar dados. Verifique a conexão.");
        }
    },

    // =========================================================================
    // LÓGICA DE TRANSFERÊNCIA (O CORAÇÃO DO SIMULADOR)
    // =========================================================================
    initMatrixT1: () => {
        // Inicializa matriz padrão baseada em "Afinidade Ideológica"
        // L22 -> Esquerda, B22 -> Direita
        app.state.candidates.forEach(c => {
            const isLeft = ['LULA', 'CIRO'].includes(c.id);
            const isRight = ['FLAVIO', 'CAIADO', 'ZEMA', 'TARCISIO'].includes(c.id);
            const isCenter = ['RENAN'].includes(c.id);

            app.state.matrixT1[c.id] = {
                l22: isLeft ? (c.id==='LULA'?0.8:0.1) : (isCenter?0.1:0.01),
                b22: isRight ? (c.id==='FLAVIO'?0.6:0.1) : (isCenter?0.1:0.01)
            };
        });
        // Normaliza para o usuário ajustar depois
    },

    runSimulation: () => {
        const results = {}; // { cityId: { votes: {}, winner: id, total: 100 } }
        const activeCands = app.getActiveCandidates();
        
        // 1. Calcular Votos por Município
        app.data.geo.features.forEach(f => {
            const pid = f.properties.id;
            const p22 = f.properties.perfil22; // {lula: %, bolso: %}
            
            let cityVotes = {};
            let totalWeight = 0;

            activeCands.forEach(c => {
                let rawScore = 0;
                
                if (app.state.turn === 1) {
                    // Lógica T1: Ancestralidade 2022
                    // Voto = (BaseLula * TransferL) + (BaseBolso * TransferB)
                    const mat = app.state.matrixT1[c.id];
                    // Usamos slider do candidato como "Energia da Campanha" (Multiplicador Global)
                    const campaignFactor = c.val / 10; // Fator arbitrário para escalar
                    
                    rawScore = (p22.lula * mat.l22) + (p22.bolso * mat.b22);
                    rawScore *= campaignFactor;
                    
                } else {
                    // Lógica T2: Transferência dos Eliminados
                    // Se o candidato já estava no T1, mantém sua base T1 + transferências
                    // Para simplificar: Recalculamos T1 para essa cidade e aplicamos matriz T2
                    // Esta lógica exigiria dois passos. 
                    // Simplificação Robusta:
                    // Voto = Perfil22 * MatrizT2_Direta (Calculada dinamicamente)
                    // Ou seja, definimos quem herda L22 e B22 neste cenário
                    
                    // Pega configuração da Matriz T2 (que define migração de Ciro, Tarcisio etc)
                    // Mas como não salvamos resultado T1 na memória persistente pra usar de input,
                    // Vamos usar uma aproximação baseada nos sliders do T1 (que representam a força nacional)
                    
                    // Vamos usar uma "Afinidade Derivada":
                    // Se é Lula vs Flavio: Lula herda Esquerda + % Centro. Flavio herda Direita + % Centro.
                    // Isso é controlado pelos sliders do T2 que funcionam como "Capacidade de atrair o eleitorado"
                    
                    const isLeft = ['LULA','CIRO'].includes(c.id);
                    // Bias geográfico simples para T2
                    const affinity = isLeft ? p22.lula : p22.bolso;
                    rawScore = affinity * c.val;
                }

                cityVotes[c.id] = rawScore;
                totalWeight += rawScore;
            });

            // Normalização e Vencedor
            let max = -1, winner = null;
            activeCands.forEach(c => {
                const pct = totalWeight > 0 ? (cityVotes[c.id] / totalWeight) * 100 : 0;
                cityVotes[c.id] = pct;
                if(pct > max) { max = pct; winner = c.id; }
            });

            results[pid] = { votes: cityVotes, winner: winner, max: max };
        });

        app.data.simResults = results;
        app.renderMap();
        app.renderResults();
    },

    // =========================================================================
    // RENDERIZAÇÃO DO MAPA
    // =========================================================================
    renderMap: () => {
        if(app.layers.muns) app.map.removeLayer(app.layers.muns);
        if(app.layers.states) app.map.removeLayer(app.layers.states);

        const isStateView = app.state.view === 'states';
        const activeCands = app.getActiveCandidates();

        // Style Function
        const getStyle = (feature, isStateLyr) => {
            let res, winnerId, maxPct;
            
            if (isStateLyr) {
                // Agregar votos do estado (Média simples das cidades para demo rápida)
                // O ideal seria ponderar por população, mas não temos pop no geojson simples
                // Vamos usar a cor do "Vencedor Estadual Calculado"
                // Hack: Usar o ID do estado para simular, já que temos BASE_2022 por estado
                // Mas precisamos dos dados agregados.
                
                // Agregação Real-time
                const ufId = feature.properties.id;
                let stVotes = {}; let count = 0;
                app.data.geo.features.forEach(f => {
                    if(f.properties.id.toString().startsWith(ufId)){
                        const r = app.data.simResults[f.properties.id];
                        if(r) {
                            activeCands.forEach(c => stVotes[c.id] = (stVotes[c.id]||0) + r.votes[c.id]);
                            count++;
                        }
                    }
                });
                
                let sMax = -1, sWin = null;
                activeCands.forEach(c => {
                    const avg = stVotes[c.id] / count;
                    if(avg > sMax) { sMax = avg; sWin = c.id; }
                });
                winnerId = sWin; maxPct = sMax;

            } else {
                res = app.data.simResults[feature.properties.id];
                if(!res) return {fillColor:'#333', stroke:false};
                winnerId = res.winner; maxPct = res.max;
            }

            const winner = activeCands.find(c => c.id === winnerId);
            if(!winner) return { fillColor:'#222', weight:0 };

            // Cor Sólida com "Degraus" (Buckets)
            // Atlas Style: 50-55, 55-60, 60-70, 70-80, 80+
            let opacity = 1;
            // Para criar os degraus, misturamos com branco ou preto ou alteramos a saturação
            // Aqui vamos usar uma função de mix de cor simples
            
            let shade = 0; // 0 = Cor Pura
            if(maxPct < 30) shade = 0.8;       // Muito fraco (multipolar)
            else if(maxPct < 40) shade = 0.6;
            else if(maxPct < 50) shade = 0.4;
            else if(maxPct < 55) shade = 0.3;
            else if(maxPct < 60) shade = 0.2;
            else if(maxPct < 70) shade = 0.1;
            else shade = 0; // Forte

            // Se for T2, a escala sobe (50% é empate)
            if(app.state.turn === 2) {
                if(maxPct < 52) shade = 0.6;
                else if(maxPct < 55) shade = 0.4;
                else if(maxPct < 60) shade = 0.2;
                else shade = 0;
            }

            return {
                fillColor: app.mixWhite(winner.color, shade),
                fillOpacity: 1,
                color: isStateLyr ? '#fff' : 'rgba(0,0,0,0.15)', // Bordas
                weight: isStateLyr ? 1.2 : 0.3
            };
        };

        if (isStateView) {
            app.layers.states = L.geoJSON(app.data.states, {
                style: (f) => getStyle(f, true),
                onEachFeature: (f, l) => {
                    l.bindTooltip(f.properties.name, {sticky:true, direction:'top'});
                    l.on('click', () => {
                        // Zoom in state
                        app.map.fitBounds(l.getBounds());
                    });
                }
            }).addTo(app.map);
        } else {
            // Municipal View (Heavy)
            app.layers.muns = L.geoJSON(app.data.geo, {
                style: (f) => getStyle(f, false),
                onEachFeature: (f, l) => {
                    // Detailed Tooltip
                    l.on('mouseover', (e) => {
                        const r = app.data.simResults[f.properties.id];
                        if(!r) return;
                        const sorted = activeCands.map(c=>({name:c.name, color:c.color, v:r.votes[c.id]})).sort((a,b)=>b.v-a.v);
                        
                        let html = `<div style="font-weight:700; border-bottom:1px solid #444; margin-bottom:5px;">${f.properties.name}</div>`;
                        sorted.forEach(c => {
                            html += `<div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                                <span style="color:${c.color}">${c.name}</span>
                                <span>${c.v.toFixed(1)}%</span>
                            </div>`;
                        });
                        l.bindTooltip(html, {sticky:true, className:'custom-tt'}).openTooltip();
                    });
                }
            }).addTo(app.map);
        }
    },

    mixWhite: (hex, ratio) => {
        // Mistura cor com branco para criar tintas (tints)
        const r = parseInt(hex.substring(1,3), 16);
        const g = parseInt(hex.substring(3,5), 16);
        const b = parseInt(hex.substring(5,7), 16);
        
        const nr = Math.round(r + (255 - r) * ratio);
        const ng = Math.round(g + (255 - g) * ratio);
        const nb = Math.round(b + (255 - b) * ratio);
        
        return `rgb(${nr},${ng},${nb})`;
    },

    // =========================================================================
    // UI & EVENTS
    // =========================================================================
    renderUI: () => {
        const div = document.getElementById('cand-list');
        div.innerHTML = '';
        const cands = app.getActiveCandidates();
        let total = 0;

        cands.forEach(c => {
            total += parseInt(c.val);
            const el = document.createElement('div');
            el.className = 'cand-card';
            el.innerHTML = `
                <div class="cc-head">
                    <div class="cc-info">
                        <div class="cc-color" style="background:${c.color}" id="cp-${c.id}"></div>
                        <div>
                            <div class="cc-name">${c.name}</div>
                            <div class="cc-party">${c.party}</div>
                        </div>
                    </div>
                    <div class="cc-val">${c.val}%</div>
                </div>
                <input type="range" min="0" max="100" value="${c.val}" 
                       oninput="app.updateVal('${c.id}', this.value)" style="width:100%; cursor:pointer;">
            `;
            div.appendChild(el);
            
            // Color Picker
            setTimeout(() => {
                const p = Pickr.create({
                    el: `#cp-${c.id}`, theme: 'nano', default: c.color,
                    components: { preview:true, hue:true, interaction:{save:true}}
                });
                p.on('save', (col) => {
                    c.color = col.toHEXA().toString();
                    el.querySelector('.cc-color').style.background = c.color;
                    app.runSimulation();
                });
            }, 0);
        });

        document.getElementById('total-sum').innerText = total + "%";
        
        // Update Legends
        const lDiv = document.getElementById('legend-colors');
        lDiv.innerHTML = '';
        const winner = cands.reduce((prev, curr) => (prev.val > curr.val) ? prev : curr);
        for(let i=0.8; i>=0; i-=0.2) {
            const step = document.createElement('div');
            step.className = 'l-step';
            step.style.background = app.mixWhite(winner.color, i);
            lDiv.appendChild(step);
        }

        // T2 Selectors
        if(app.state.turn === 2) {
            const s1 = document.getElementById('sel-c1');
            const s2 = document.getElementById('sel-c2');
            const opts = app.state.candidates.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if(s1.innerHTML === '') { s1.innerHTML=opts; s2.innerHTML=opts; s1.value=app.state.t2_cands[0]; s2.value=app.state.t2_cands[1]; }
        }
    },

    updateVal: (id, v) => {
        const c = app.state.candidates.find(x => x.id === id);
        c.val = parseInt(v);
        app.renderUI();
        app.runSimulation();
    },

    getActiveCandidates: () => {
        if(app.state.turn === 1) return app.state.candidates;
        return app.state.candidates.filter(c => app.state.t2_cands.includes(c.id));
    },

    setTurn: (t) => {
        app.state.turn = t;
        document.getElementById('btn-t1').className = t===1?'tab active':'tab';
        document.getElementById('btn-t2').className = t===2?'tab active':'tab';
        document.getElementById('t2-controls').style.display = t===2?'block':'none';
        document.getElementById('matrix-t1').style.display = t===1?'block':'none';
        document.getElementById('matrix-t2').style.display = t===2?'block':'none';
        app.renderUI();
        app.runSimulation();
    },

    updateT2: () => {
        app.state.t2_cands = [
            document.getElementById('sel-c1').value,
            document.getElementById('sel-c2').value
        ];
        app.renderUI();
        app.runSimulation();
    },

    setView: (v) => {
        app.state.view = v;
        document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(v==='br-mun'?'view-br-mun':'view-states').classList.add('active');
        app.renderMap();
    },

    renderResults: () => {
        const div = document.getElementById('results-area');
        const cands = app.getActiveCandidates();
        // Calculate National Weighted Average
        // Since GeoJSON doesn't have pop, we sum raw % * 1 (Simple)
        // OR better: use the slider values as the "National Result" truth 
        // and map only shows distribution.
        
        // Let's use the sliders for the Results Panel to match user expectation
        const sorted = [...cands].sort((a,b) => b.val - a.val);
        
        let html = '';
        sorted.forEach(c => {
            html += `
                <div style="margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-weight:700;">
                        <span>${c.name}</span>
                        <span>${c.val}%</span>
                    </div>
                    <div style="height:8px; background:#222; border-radius:4px; overflow:hidden;">
                        <div style="height:100%; width:${c.val}%; background:${c.color}; transition:width 0.5s;"></div>
                    </div>
                </div>
            `;
        });
        div.innerHTML = html;
    },

    // =========================================================================
    // MODAL & TRANSFER MATRIX UI
    // =========================================================================
    toggleModal: (show) => {
        document.getElementById('configModal').style.display = show ? 'flex' : 'none';
        if(show) app.renderMatrixInputs();
    },

    renderMatrixInputs: () => {
        const cT1 = document.getElementById('matrixContainerT1');
        cT1.innerHTML = '';
        
        // T1: 2022 -> 2026
        // Colunas: Lula 2022, Bolsonaro 2022
        app.state.candidates.forEach(c => {
            const m = app.state.matrixT1[c.id];
            cT1.innerHTML += `
                <div class="matrix-group">
                    <div class="mg-title"><div style="width:10px;height:10px;background:${c.color}"></div> ${c.name}</div>
                    <div class="mg-row">
                        <span>Recebe de Lula (22):</span>
                        <input type="number" step="0.1" class="mg-input i-l22" value="${m.l22}" data-id="${c.id}">
                    </div>
                    <div class="mg-row">
                        <span>Recebe de Bolso (22):</span>
                        <input type="number" step="0.1" class="mg-input i-b22" value="${m.b22}" data-id="${c.id}">
                    </div>
                </div>
            `;
        });
    },

    applyTransfers: () => {
        // Save Matrix
        document.querySelectorAll('.i-l22').forEach(i => {
            app.state.matrixT1[i.dataset.id].l22 = parseFloat(i.value);
        });
        document.querySelectorAll('.i-b22').forEach(i => {
            app.state.matrixT1[i.dataset.id].b22 = parseFloat(i.value);
        });
        
        app.toggleModal(false);
        app.runSimulation();
    }
};

// Start
app.init();
</script>
</body>
</html>
