<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Eleições 2026</title>
    
    <!-- Leaflet & Bibliotecas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* TEMA "WAR ROOM" */
        :root {
            --bg: #050505;
            --panel: #111;
            --text: #eee;
            --border: #333;
            --pt-color: #c4122d; /* Vermelho PT */
            --pl-color: #002f6c; /* Azul PL */
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        
        /* SIDEBAR DE CONTROLE */
        .sidebar {
            width: 380px; background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 1000;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }

        .header { padding: 25px; border-bottom: 1px solid var(--border); background: #000; }
        h1 { margin: 0; font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        .subtitle { font-size: 0.8rem; color: #777; margin-top: 5px; }

        /* PAINEL DE SIMULAÇÃO */
        .sim-panel { padding: 25px; flex: 1; overflow-y: auto; }
        
        .score-board {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333;
        }
        
        .candidate { text-align: center; width: 45%; }
        .cand-name { font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; display: block; }
        .cand-pct { font-size: 2rem; font-weight: 900; display: block; }
        
        /* SLIDER CUSTOMIZADO */
        .slider-container { margin-bottom: 40px; position: relative; }
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; border-radius: 4px;
            background: linear-gradient(90deg, var(--pl-color) 0%, #444 50%, var(--pt-color) 100%);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%;
            background: #fff; margin-top: -10px; box-shadow: 0 0 15px rgba(0,0,0,0.8); border: 2px solid #000;
        }

        /* RESULTADOS RÁPIDOS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .stat-box { background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: 700; display: block; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }

        /* MAPA */
        #map { flex: 1; background: #0a0a0a; }

        /* LOADING */
        #loader {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .progress-bar { width: 300px; height: 4px; background: #333; margin-top: 15px; border-radius: 2px; }
        .progress-fill { height: 100%; width: 0%; background: #fff; transition: width 0.2s; }

        /* TOOLTIP & LEGENDA */
        .map-tooltip { background: rgba(0,0,0,0.9); border: 1px solid #444; color: #fff; padding: 10px; border-radius: 6px; }
        .legend {
            position: absolute; bottom: 30px; right: 30px; z-index: 999;
            background: #000; padding: 15px; border: 1px solid #333; border-radius: 8px; width: 250px;
        }
        .grad-bar { height: 10px; width: 100%; background: linear-gradient(90deg, var(--pl-color), #222, var(--pt-color)); margin: 10px 0; border-radius: 5px; }
        .leg-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #aaa; }
    </style>
</head>
<body>

<div id="loader">
    <h2 style="font-weight: 300;">CARREGANDO DADOS DE 2022...</h2>
    <div class="progress-bar"><div class="progress-fill" id="loadBar"></div></div>
</div>

<aside class="sidebar">
    <div class="header">
        <h1>Simulador 2026</h1>
        <div class="subtitle">Baseado na Geografia Eleitoral de 2022</div>
    </div>

    <div class="sim-panel">
        <div style="text-align: center; font-size: 0.8rem; color: #888; margin-bottom: 10px;">
            RESULTADO NACIONAL PROJETADO
        </div>

        <div class="score-board">
            <div class="candidate">
                <span class="cand-name" style="color:var(--pl-color)">DIREITA</span>
                <span class="cand-pct" id="displayPL">49.1%</span>
            </div>
            <div style="font-size: 1.5rem; color: #444;">VS</div>
            <div class="candidate">
                <span class="cand-name" style="color:var(--pt-color)">ESQUERDA</span>
                <span class="cand-pct" id="displayPT">50.9%</span>
            </div>
        </div>

        <div class="slider-container">
            <input type="range" id="swingSlider" min="35" max="65" step="0.1" value="50.90">
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#666; margin-top:10px;">
                <span>Vitória Direita</span>
                <span>Empate</span>
                <span>Vitória Esquerda</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <span class="stat-val" id="countCitiesPT">0</span>
                <span class="stat-label">Cidades Esq.</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="countCitiesPL">0</span>
                <span class="stat-label">Cidades Dir.</span>
            </div>
        </div>

        <div style="margin-top: 30px; font-size: 0.8rem; color: #666; line-height: 1.6; border-top: 1px solid #222; padding-top: 20px;">
            <strong>Metodologia (Swing):</strong> O simulador aplica uma variação uniforme sobre os resultados reais de 2022. Se a esquerda cresce 2% no nacional, ela cresce 2% em cada um dos 5.570 municípios proporcionalmente.
        </div>
    </div>
</aside>

<div id="map"></div>

<div class="legend">
    <div style="font-size:0.7rem; font-weight:700; color:#fff; text-align:center">INTENSIDADE DA VITÓRIA</div>
    <div class="grad-bar"></div>
    <div class="leg-labels">
        <span>+ Direita</span>
        <span>Empate</span>
        <span>+ Esquerda</span>
    </div>
</div>

<script>
const app = {
    map: null,
    geoLayer: null,
    baseData: {}, // Dados originais 2022 { ibge: { pt_pct: 0.55, total: 1000 } }
    names: {},    // Nomes das cidades
    nationalBasePT: 0, // 50.9% em 2022
    
    init: async () => {
        app.map = L.map('map', {center: [-15, -50], zoom: 4, zoomControl: false, background:'#0a0a0a'});
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {opacity: 0.3}).addTo(app.map);
        
        // Evento do Slider
        document.getElementById('swingSlider').addEventListener('input', (e) => {
            app.updateSimulation(parseFloat(e.target.value));
        });

        await app.loadData();
    },

    loadData: async () => {
        const bar = document.getElementById('loadBar');
        
        try {
            // 1. Carregar Malha Municipal (Simplificada do GitHub)
            bar.style.width = '30%';
            const geoRes = await fetch('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json');
            const geoJson = await geoRes.json();
            
            // 2. Carregar Dados Reais 2022 (Do seu arquivo gerado antes)
            bar.style.width = '60%';
            const dataRes = await fetch('data/2022_president.json'); // Caminho importante!
            const rawData = await dataRes.json();
            
            // 3. Processar Dados (Extrair Baseline)
            bar.style.width = '80%';
            app.processBaseline(rawData);
            
            // 4. Renderizar Mapa
            bar.style.width = '95%';
            app.geoLayer = L.geoJSON(geoJson, {
                style: app.getStyle,
                onEachFeature: (f, l) => {
                    // Normaliza ID (alguns geojsons usam id, outros codarea)
                    f.id = f.properties.id || f.properties.codarea;
                    l.bindTooltip(() => app.getTooltipContent(f.id), {sticky: true, className: 'map-tooltip'});
                }
            }).addTo(app.map);
            
            // Atualiza UI inicial
            app.updateSimulation(app.nationalBasePT * 100);
            document.getElementById('swingSlider').value = (app.nationalBasePT * 100).toFixed(2);
            
            setTimeout(() => document.getElementById('loader').classList.add('hidden'), 500);

        } catch(e) {
            console.error(e);
            alert("Erro ao carregar dados. Verifique se 'data/2022_president.json' existe.");
        }
    },

    processBaseline: (json) => {
        // Pega dados do 2º Turno
        const turno2 = json['2'];
        if (!turno2) throw new Error("Sem dados de 2º turno");

        let totalPT = 0;
        let totalValidos = 0;

        // Itera sobre municípios
        Object.entries(turno2.municipios).forEach(([ibge, votos]) => {
            // Identifica chaves (Lula/Bolsonaro podem variar a string dependendo do script que gerou)
            // Procura chaves que contenham "LULA" ou "13" e "BOLSONARO" ou "22"
            let vPT = 0, vPL = 0;
            
            Object.entries(votos).forEach(([candName, numVotos]) => {
                const upper = candName.toUpperCase();
                if (upper.includes('LULA') || upper.includes('(PT)') || upper.includes('13')) vPT += numVotos;
                else if (upper.includes('BOLSONARO') || upper.includes('(PL)') || upper.includes('22')) vPL += numVotos;
            });

            const totalMun = vPT + vPL;
            
            if (totalMun > 0) {
                app.baseData[ibge] = {
                    pctPT: vPT / totalMun,
                    total: totalMun
                };
                totalPT += vPT;
                totalValidos += totalMun;
            }
        });
        
        // Carrega Nomes
        app.names = turno2.meta_nomes || {};

        // Calcula média nacional real de 2022
        app.nationalBasePT = totalPT / totalValidos; // Deve dar ~0.509
    },

    updateSimulation: (targetPtPct) => {
        // targetPtPct vem do slider (ex: 52.0)
        const targetDecimal = targetPtPct / 100;
        
        // Swing: Diferença entre o cenário desejado e o real de 2022
        const swing = targetDecimal - app.nationalBasePT;
        
        // Atualiza textos
        document.getElementById('displayPT').textContent = targetPtPct.toFixed(1) + '%';
        document.getElementById('displayPL').textContent = (100 - targetPtPct).toFixed(1) + '%';
        
        // Contadores
        let winsPT = 0, winsPL = 0;

        // Atualiza cores do mapa
        app.geoLayer.eachLayer(layer => {
            const id = layer.feature.id;
            const base = app.baseData[id];
            
            if (base) {
                // Aplica o Swing: %Nova = %Base2022 + SwingNacional
                let newPctPT = base.pctPT + swing;
                // Limita entre 0 e 1
                newPctPT = Math.max(0, Math.min(1, newPctPT));
                
                // Contagem
                if (newPctPT > 0.5) winsPT++; else winsPL++;
                
                // Define cor
                layer.setStyle({
                    fillColor: app.getColor(newPctPT),
                    fillOpacity: 1,
                    weight: 0.5,
                    color: '#000'
                });
                
                // Guarda valor simulado na feature para o tooltip usar
                layer.feature.simPctPT = newPctPT;
            } else {
                layer.setStyle({fillColor: '#333', weight:0});
            }
        });

        document.getElementById('countCitiesPT').textContent = winsPT.toLocaleString();
        document.getElementById('countCitiesPL').textContent = winsPL.toLocaleString();
    },

    getColor: (pctPT) => {
        // Escala Divergente: Azul (0) -> Preto/Cinza (0.5) -> Vermelho (1)
        // Mas queremos ALTO CONTRASTE e Brilho
        
        if (pctPT > 0.5) {
            // Lado ESQUERDA (Vermelho)
            // Intensidade vai de 0 (50%) a 1 (100%)
            const intensity = (pctPT - 0.5) * 2; 
            // Interpola entre Cinza Escuro (#333) e Vermelho Vivo (#c4122d)
            return app.interpolateColor('#444444', '#ff0000', intensity);
        } else {
            // Lado DIREITA (Azul)
            // Intensidade vai de 0 (50%) a 1 (0%)
            const intensity = (0.5 - pctPT) * 2;
            // Interpola entre Cinza Escuro (#333) e Azul Vivo (#002f6c)
            return app.interpolateColor('#444444', '#0044ff', intensity);
        }
    },

    interpolateColor: (c1, c2, factor) => {
        // Função auxiliar simples para misturar cores hex
        const hex = (x) => parseInt(x.replace('#',''), 16);
        const r1 = (hex(c1) >> 16) & 255;
        const g1 = (hex(c1) >> 8) & 255;
        const b1 = hex(c1) & 255;
        
        const r2 = (hex(c2) >> 16) & 255;
        const g2 = (hex(c2) >> 8) & 255;
        const b2 = hex(c2) & 255;
        
        const r = Math.round(r1 + (r2 - r1) * factor);
        const g = Math.round(g1 + (g2 - g1) * factor);
        const b = Math.round(b1 + (b2 - b1) * factor);
        
        return `rgb(${r},${g},${b})`;
    },

    getTooltipContent: (id) => {
        const base = app.baseData[id];
        const name = app.data.names[id] || id;
        
        if (!base) return `${name}: Sem dados`;
        
        // Pega valor simulado (salvo durante updateSimulation) ou base
        // Precisamos acessar a layer, mas aqui no tooltip function é difícil.
        // Recalculamos rápido baseado no estado atual
        const currentSwing = (app.state?.targetPt || 50.9) / 100 - app.nationalBasePT;
        let simPct = base.pctPT + currentSwing;
        simPct = Math.max(0, Math.min(1, simPct));
        
        const winner = simPct > 0.5 ? "ESQUERDA" : "DIREITA";
        const pctWin = simPct > 0.5 ? simPct : (1 - simPct);
        const color = simPct > 0.5 ? 'var(--pt-color)' : 'var(--pl-color)';

        return `
            <div style="font-weight:800; border-bottom:1px solid #555; margin-bottom:5px">${name}</div>
            Vencedor: <strong style="color:${color}">${winner}</strong><br>
            Votos: ${(pctWin*100).toFixed(1)}%
        `;
    }
};

// Inicia
// Estado inicial para simulação (targetPt)
app.state = { targetPt: 50.9 };
document.addEventListener('DOMContentLoaded', app.init);

</script>
</body>
</html>
