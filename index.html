<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Simulador 2026 - Ultimate</title>
    
    <!-- Bibliotecas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Color Picker -->
    <link href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <style>
        :root {
            --bg-dark: #0a0c10;
            --bg-panel: #14181f;
            --border: #2a303b;
            --accent: #3b82f6;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; }
        body { background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* LAYOUT */
        aside { width: 380px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
        .sidebar-right { border-left: 1px solid var(--border); border-right: none; width: 420px; }
        #map-wrapper { flex: 1; position: relative; background: #050505; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* HEADER */
        .header { padding: 20px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, #14181f 0%, #0f1218 100%); }
        .brand { font-size: 1.3rem; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--accent); }

        /* TABS */
        .tabs { display: flex; gap: 5px; margin-top: 15px; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 8px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border-radius: 6px; color: var(--text-muted); transition: 0.2s; }
        .tab.active { background: var(--accent); color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3); }

        /* CONTROLS AREA */
        .controls { padding: 20px; overflow-y: auto; flex: 1; }
        
        /* CANDIDATE ROW */
        .cand-row { background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 12px; transition: 0.2s; }
        .cand-row:hover { border-color: #444; background: rgba(255,255,255,0.04); }
        
        .cand-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .cand-info { display: flex; align-items: center; gap: 10px; }
        .color-dot { width: 18px; height: 18px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); }
        .cand-name { font-weight: 700; font-size: 0.9rem; }
        .cand-party { font-size: 0.75rem; color: var(--text-muted); }
        
        .cand-input { width: 60px; background: #0a0c10; border: 1px solid var(--border); color: var(--accent); font-weight: 700; text-align: center; padding: 6px; border-radius: 6px; font-size: 0.9rem; }
        .cand-input:focus { border-color: var(--accent); }

        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; height: 6px; cursor: pointer; margin-top: 5px; }
        input[type=range]::-webkit-slider-runnable-track { background: #333; height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; background: white; border-radius: 50%; margin-top: -6px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* BUTTONS */
        .btn { width: 100%; padding: 14px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-sec:hover { border-color: white; color: white; }

        /* MAP TOGGLES */
        .map-controls { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 500; background: rgba(20,24,31,0.9); padding: 5px; border-radius: 30px; border: 1px solid var(--border); backdrop-filter: blur(10px); }
        .map-toggle { padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .map-toggle.active { background: var(--accent); color: white; }

        /* LEGEND */
        .legend { position: absolute; bottom: 30px; left: 30px; background: var(--bg-panel); padding: 15px; border-radius: 10px; border: 1px solid var(--border); width: 220px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 400; }
        .leg-title { font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
        .leg-bar { display: flex; height: 12px; border-radius: 4px; overflow: hidden; margin-bottom: 5px; }
        .leg-seg { flex: 1; opacity: 0.9; }
        .leg-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: #666; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal { width: 900px; max-height: 90vh; background: #11141a; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .modal-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; overflow-y: auto; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        
        .state-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .state-name { font-size: 0.8rem; font-weight: 800; color: var(--text-muted); margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .st-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.75rem; }
        .st-input { width: 45px; background: black; border: 1px solid #333; color: white; padding: 2px; text-align: center; border-radius: 4px; }

        /* RESULTS PANEL */
        .res-header { margin-bottom: 20px; }
        .res-title { font-size: 1.4rem; font-weight: 800; }
        .res-row { margin-bottom: 15px; }
        .res-meta { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; font-weight: 700; }
        .prog-track { height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
        .prog-fill { height: 100%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* LOADER */
        #loader { position: absolute; inset: 0; background: #0a0c10; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div style="font-weight:700; color:#888;">PROCESSANDO MALHA MUNICIPAL (5.570 CIDADES)...</div>
</div>

<!-- MODAL FORÇA REGIONAL -->
<div class="modal-overlay" id="regionalModal">
    <div class="modal">
        <div class="modal-head">
            <h3>Força Regional (Multiplicadores)</h3>
            <button onclick="app.toggleModal(false)" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div style="padding:10px 25px; font-size:0.8rem; color:#888;">
            Ajuste a força de cada candidato por estado. 1.0 = Normal. 2.0 = Dobro da força.
        </div>
        <div class="modal-body" id="statesGrid"></div>
        <div style="padding:20px; border-top:1px solid var(--border); text-align:right;">
            <button class="btn btn-primary" style="width:auto; display:inline-flex;" onclick="app.saveRegional()">APLICAR E SIMULAR</button>
        </div>
    </div>
</div>

<aside>
    <div class="header">
        <div class="brand"><i class="fas fa-globe-americas"></i> ATLAS <span>ULTIMATE</span></div>
        <div class="tabs">
            <div class="tab active" id="tab1" onclick="app.setTurn(1)">1º TURNO</div>
            <div class="tab" id="tab2" onclick="app.setTurn(2)">2º TURNO</div>
        </div>
    </div>

    <div class="controls">
        <!-- T2 SELECTORS -->
        <div id="t2-config" style="display:none; margin-bottom:20px; background:rgba(255,255,255,0.03); padding:10px; border-radius:8px;">
            <label style="font-size:0.7rem; color:#888; font-weight:700;">CENÁRIO DE 2º TURNO</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                <select id="sel-c1" onchange="app.updateT2()" style="width:100%; padding:8px; background:black; color:white; border:1px solid #333; border-radius:4px;"></select>
                <select id="sel-c2" onchange="app.updateT2()" style="width:100%; padding:8px; background:black; color:white; border:1px solid #333; border-radius:4px;"></select>
            </div>
        </div>

        <div id="candList"></div>

        <button class="btn btn-sec" onclick="app.toggleModal(true)">
            <i class="fas fa-map-marked-alt"></i> AJUSTAR FORÇA REGIONAL
        </button>
        
        <div style="margin-top:20px; text-align:center; padding:15px; border-top:1px solid var(--border);">
            <div style="font-size:0.7rem; color:#666;">TOTAL DA INTENÇÃO DE VOTO</div>
            <div id="totalSum" style="font-size:1.6rem; font-weight:900; color:var(--accent);">100%</div>
        </div>
    </div>
</aside>

<div id="map-wrapper">
    <div class="map-controls">
        <div class="map-toggle active" id="view-mun" onclick="app.setView('mun')">MUNICÍPIOS (BR)</div>
        <div class="map-toggle" id="view-uf" onclick="app.setView('uf')">ESTADOS</div>
    </div>

    <div id="map"></div>

    <div class="legend">
        <div class="leg-title">Intensidade (Vencedor)</div>
        <div class="leg-bar" id="leg-colors"></div>
        <div class="leg-labels">
            <span>Competitivo</span>
            <span>Hegemônico</span>
        </div>
    </div>
</div>

<aside class="sidebar-right">
    <div class="header">
        <div class="brand">RESULTADOS</div>
    </div>
    <div class="controls" id="resultsArea"></div>
</aside>

<script>
// =============================================================================
// DADOS DE BASE 2022 (PARA GEOGRAFIA VEROSSÍMIL)
// =============================================================================
// Definimos o perfil de cada estado: [Voto Esquerda%, Voto Direita%]
// O algoritmo aplicará ruído municipal para criar o "mosaico" realista.
const BASE_PROFILE = {
    '12': {l: 29, r: 71}, // AC
    '27': {l: 59, r: 41}, // AL
    '13': {l: 51, r: 49}, // AM
    '16': {l: 45, r: 55}, // AP
    '29': {l: 72, r: 28}, // BA (Forte PT)
    '23': {l: 70, r: 30}, // CE (Forte PT)
    '53': {l: 41, r: 59}, // DF
    '32': {l: 42, r: 58}, // ES
    '52': {l: 41, r: 59}, // GO
    '21': {l: 71, r: 29}, // MA
    '31': {l: 50, r: 50}, // MG (Swing State Perfeito)
    '50': {l: 40, r: 60}, // MS
    '51': {l: 35, r: 65}, // MT
    '15': {l: 52, r: 48}, // PA
    '25': {l: 67, r: 33}, // PB
    '26': {l: 67, r: 33}, // PE
    '22': {l: 77, r: 23}, // PI (Fortissimo PT)
    '41': {l: 37, r: 63}, // PR
    '33': {l: 43, r: 57}, // RJ
    '24': {l: 65, r: 35}, // RN
    '11': {l: 29, r: 71}, // RO
    '14': {l: 24, r: 76}, // RR (Fortissimo Direita)
    '43': {l: 43, r: 57}, // RS
    '42': {l: 30, r: 70}, // SC (Forte Direita)
    '28': {l: 67, r: 33}, // SE
    '35': {l: 45, r: 55}, // SP
    '17': {l: 51, r: 49}  // TO
};

const STATES_LIST = [
    {id:'12',n:'Acre'},{id:'27',n:'Alagoas'},{id:'13',n:'Amazonas'},{id:'16',n:'Amapá'},
    {id:'29',n:'Bahia'},{id:'23',n:'Ceará'},{id:'53',n:'Distrito Federal'},{id:'32',n:'Espírito Santo'},
    {id:'52',n:'Goiás'},{id:'21',n:'Maranhão'},{id:'31',n:'Minas Gerais'},{id:'50',n:'Mato Grosso do Sul'},
    {id:'51',n:'Mato Grosso'},{id:'15',n:'Pará'},{id:'25',n:'Paraíba'},{id:'26',n:'Pernambuco'},
    {id:'22',n:'Piauí'},{id:'41',n:'Paraná'},{id:'33',n:'Rio de Janeiro'},{id:'24',n:'Rio Grande do Norte'},
    {id:'11',n:'Rondônia'},{id:'14',n:'Roraima'},{id:'43',n:'Rio Grande do Sul'},{id:'42',n:'Santa Catarina'},
    {id:'28',n:'Sergipe'},{id:'35',n:'São Paulo'},{id:'17',n:'Tocantins'}
];

// Lista Inicial Solicitada
const INITIAL_CANDS = [
    { id: 'LULA', name: 'Lula da Silva', party: 'PT', color: '#E12525', t1: 35, t2: 45, align: 'L' },
    { id: 'FLAVIO', name: 'Flávio Bolsonaro', party: 'PL', color: '#1a418a', t1: 25, t2: 40, align: 'R' },
    { id: 'CAIADO', name: 'Ronaldo Caiado', party: 'UNIÃO', color: '#0EA5E9', t1: 8, t2: 0, align: 'R' },
    { id: 'RATINHO', name: 'Ratinho Jr', party: 'PSD', color: '#109176', t1: 6, t2: 0, align: 'R' },
    { id: 'RENAN', name: 'Renan Santos', party: 'MISSÃO', color: '#EAB308', t1: 4, t2: 0, align: 'C' },
    { id: 'ZEMA', name: 'Romeu Zema', party: 'NOVO', color: '#F97316', t1: 7, t2: 0, align: 'R' },
    { id: 'CIRO', name: 'Ciro Gomes', party: 'PDT', color: '#9333EA', t1: 5, t2: 0, align: 'L' },
    { id: 'ALDO', name: 'Aldo Rebelo', party: 'MDB', color: '#006400', t1: 2, t2: 0, align: 'C' }
];

const app = {
    map: null,
    layers: { mun: null, uf: null },
    data: { geo: null, ufs: null, sim: {} },
    state: {
        turn: 1,
        view: 'mun',
        cands: JSON.parse(JSON.stringify(INITIAL_CANDS)),
        t2_pair: ['LULA', 'FLAVIO'],
        multipliers: {} // { turn: { candId: { stateId: val } } }
    },

    init: async () => {
        // Init Multipliers Structure
        [1, 2].forEach(t => {
            app.state.multipliers[t] = {};
            app.state.cands.forEach(c => {
                app.state.multipliers[t][c.id] = {};
                STATES_LIST.forEach(s => app.state.multipliers[t][c.id][s.id] = 1.0);
            });
        });

        // Setup Map
        app.map = L.map('map', { center: [-15, -55], zoom: 4, zoomControl: false, preferCanvas: true });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 1 }).addTo(app.map);

        try {
            // Load Heavy GeoJSON
            const [munRes, ufRes] = await Promise.all([
                fetch('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json'),
                fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson')
            ]);
            
            const munData = await munRes.json();
            const ufData = await ufRes.json();

            // Fix UF IDs
            const ufMap = {}; STATES_LIST.forEach(s => ufMap[s.n] = s.id); // Simple mapping by name, data source uses sigla mostly but lets map sigla manually if needed.
            // Map Sigla from UF data
            const siglaMap = {'AC':'12','AL':'27','AM':'13','AP':'16','BA':'29','CE':'23','DF':'53','ES':'32','GO':'52','MA':'21','MG':'31','MS':'50','MT':'51','PA':'15','PB':'25','PE':'26','PI':'22','PR':'41','RJ':'33','RN':'24','RO':'11','RR':'14','RS':'43','SC':'42','SE':'28','SP':'35','TO':'17'};
            ufData.features.forEach(f => f.properties.id = siglaMap[f.properties.sigla]);

            // PRE-PROCESS GEOGRAPHY (The "Verossímil" Engine)
            // Assign a "Political DNA" to each municipality based on its state and a random seed
            munData.features.forEach(f => {
                const id = f.properties.id.toString();
                const ufId = id.substring(0, 2);
                const base = BASE_PROFILE[ufId] || {l:50, r:50};

                // Deterministic Noise (Pseudo-random based on ID)
                // Creates variance within state (+/- 15%)
                const seed = (parseInt(id) * 12345) % 100; 
                const noise = (seed - 50) * 0.3; // -15 to +15

                f.properties.dna = {
                    l: Math.max(10, Math.min(90, base.l + noise)),
                    r: Math.max(10, Math.min(90, base.r - noise))
                };
            });

            app.data.geo = munData;
            app.data.ufs = ufData;

            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);

            app.renderUI();
            app.runSimulation();

        } catch (e) {
            alert("Erro ao carregar dados geográficos.");
            console.error(e);
        }
    },

    // =========================================================================
    // CORE SIMULATION LOGIC
    // =========================================================================
    runSimulation: () => {
        const t = app.state.turn;
        const activeCands = app.getActiveCands();
        const results = {}; // { cityId: { winner: id, max: pct } }

        // Calculate Municipality Results
        app.data.geo.features.forEach(f => {
            const id = f.properties.id;
            const ufId = id.toString().substring(0, 2);
            const dna = f.properties.dna; // {l: %, r: %}

            let votes = {};
            let totalW = 0;

            activeCands.forEach(c => {
                // 1. BASE: Alignment with Geography
                // Left candidates grab from dna.l, Right from dna.r, Center splits
                let geoScore = 0;
                if (c.align === 'L') geoScore = dna.l;
                else if (c.align === 'R') geoScore = dna.r;
                else geoScore = 50; // Center neutral

                // 2. INPUT: User Slider (National Strength)
                // Slider acts as "Campaign Energy". 
                // Formula: GeoScore * (Slider / Normalizer)
                // Simplified: Base * UserStrength
                let raw = geoScore * c.val;

                // 3. REGIONAL: Multiplier
                const mult = app.state.multipliers[t][c.id][ufId] || 1.0;
                raw *= mult;

                votes[c.id] = raw;
                totalW += raw;
            });

            // Normalize & Find Winner
            let max = -1, winner = null;
            activeCands.forEach(c => {
                const pct = totalW > 0 ? (votes[c.id] / totalW) * 100 : 0;
                if (pct > max) { max = pct; winner = c.id; }
            });

            results[id] = { w: winner, m: max };
        });

        app.data.sim = results;
        app.renderMap();
        app.renderResults();
    },

    // =========================================================================
    // RENDER MAP
    // =========================================================================
    renderMap: () => {
        if(app.layers.mun) app.map.removeLayer(app.layers.mun);
        if(app.layers.uf) app.map.removeLayer(app.layers.uf);

        const isMun = app.state.view === 'mun';
        const cands = app.getActiveCands();
        const getCand = (id) => cands.find(c => c.id === id);

        const getStyle = (id, isState) => {
            let winId, pct;

            if (isState) {
                // Aggregation Hack: Use base profile + multipliers to simulate state winner color
                // Ideally we sum up city results, but for speed we estimate
                const ufId = id;
                let scores = {}; let tot = 0;
                cands.forEach(c => {
                    const base = (c.align==='L' ? BASE_PROFILE[ufId].l : (c.align==='R' ? BASE_PROFILE[ufId].r : 50));
                    const v = base * c.val * (app.state.multipliers[app.state.turn][c.id][ufId]||1);
                    scores[c.id] = v; tot += v;
                });
                let max = -1;
                cands.forEach(c => {
                    let p = (scores[c.id]/tot)*100;
                    if(p>max){max=p; winId=c.id;}
                });
                pct = max;
            } else {
                const r = app.data.sim[id];
                if(!r) return {fillColor:'#222', weight:0};
                winId = r.w; pct = r.m;
            }

            const c = getCand(winId);
            if(!c) return {fillColor:'#222', weight:0};

            // High-Res Gradient (Atlas Style: Solid + Darkness)
            // Steps: <30, <40, <50, <60, >60
            let shade = 0;
            if(pct < 35) shade = 0.7; // Very Weak (Multipolar)
            else if(pct < 45) shade = 0.5;
            else if(pct < 50) shade = 0.3;
            else if(pct < 55) shade = 0.2; // Competitive
            else if(pct < 65) shade = 0.1;
            else shade = 0; // Strong

            // In Turn 2, 50 is the floor
            if(app.state.turn === 2) {
                if(pct < 52) shade = 0.5;
                else if(pct < 55) shade = 0.3;
                else if(pct < 60) shade = 0.15;
                else shade = 0;
            }

            return {
                fillColor: app.mixBlack(c.color, shade),
                fillOpacity: 1,
                color: isState ? '#fff' : 'rgba(0,0,0,0.1)',
                weight: isState ? 1 : 0.3
            };
        };

        if (isMun) {
            app.layers.mun = L.geoJSON(app.data.geo, {
                style: (f) => getStyle(f.properties.id, false),
                onEachFeature: (f, l) => {
                    const r = app.data.sim[f.properties.id];
                    if(r) {
                        const w = getCand(r.w);
                        l.bindTooltip(`<b>${f.properties.name}</b><br>${w.name}: ${r.m.toFixed(1)}%`, {sticky:true});
                    }
                }
            }).addTo(app.map);
        } else {
            app.layers.uf = L.geoJSON(app.data.ufs, {
                style: (f) => getStyle(f.properties.id, true),
                onEachFeature: (f, l) => {
                    l.bindTooltip(`<b>${f.properties.name}</b>`, {sticky:true});
                    l.on('click', () => app.map.fitBounds(l.getBounds()));
                }
            }).addTo(app.map);
        }
    },

    mixBlack: (hex, ratio) => {
        // Darkens color for "Weak" support (Atlas Logic: Weak = Darker/Muddy, Strong = Pure Neon)
        // OR: Lighten for weak? Atlas usually uses Saturation. 
        // Let's use simple Mix with Black for depth.
        // Actually, user requested "Degrade de cores igual site original".
        // Let's mix with #1a1a1a (background) to fade out.
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        
        // Mix with #222
        const tr = Math.round(r * (1-ratio) + 34 * ratio);
        const tg = Math.round(g * (1-ratio) + 34 * ratio);
        const tb = Math.round(b * (1-ratio) + 34 * ratio);
        
        return `rgb(${tr},${tg},${tb})`;
    },

    // =========================================================================
    // UI HANDLERS
    // =========================================================================
    renderUI: () => {
        const div = document.getElementById('candList');
        div.innerHTML = '';
        const cands = app.getActiveCands();
        let total = 0;

        cands.forEach(c => {
            total += c.val;
            const el = document.createElement('div');
            el.className = 'cand-row';
            el.innerHTML = `
                <div class="cand-top">
                    <div class="cand-info">
                        <div class="color-dot" style="background:${c.color}" id="cp-${c.id}"></div>
                        <div>
                            <div class="cand-name">${c.name}</div>
                            <div class="cand-party">${c.party}</div>
                        </div>
                    </div>
                    <input type="number" class="cand-input" value="${c.val}" onchange="app.upVal('${c.id}', this.value)">
                </div>
                <input type="range" min="0" max="100" value="${c.val}" oninput="app.upVal('${c.id}', this.value)">
            `;
            div.appendChild(el);

            setTimeout(() => {
                const p = Pickr.create({
                    el: `#cp-${c.id}`, theme: 'nano', default: c.color,
                    components: { preview:true, hue:true, interaction:{save:true}}
                });
                p.on('save', (col) => {
                    c.color = col.toHEXA().toString();
                    el.querySelector('.color-dot').style.background = c.color;
                    app.runSimulation();
                });
            }, 0);
        });

        const sumEl = document.getElementById('totalSum');
        sumEl.innerText = total + "%";
        sumEl.style.color = (total > 99 && total < 101) ? '#4ade80' : '#f87171';

        // T2 Config
        if(app.state.turn === 2) {
            const s1 = document.getElementById('sel-c1');
            const s2 = document.getElementById('sel-c2');
            if(s1.options.length === 0) {
                const ops = app.state.cands.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                s1.innerHTML = ops; s2.innerHTML = ops;
                s1.value = app.state.t2_pair[0]; s2.value = app.state.t2_pair[1];
            }
        }
        
        // Legends
        const lBar = document.getElementById('leg-colors');
        lBar.innerHTML = '';
        const win = cands.reduce((p, c) => (p.val > c.val ? p : c));
        [0.7, 0.5, 0.3, 0.1, 0].forEach(r => {
            const d = document.createElement('div');
            d.className = 'leg-seg';
            d.style.background = app.mixBlack(win.color, r);
            lBar.appendChild(d);
        });
    },

    upVal: (id, v) => {
        const val = parseInt(v) || 0;
        const c = app.state.cands.find(x => x.id === id);
        if(app.state.turn === 1) c.t1 = val;
        else c.t2 = val;
        
        // Update View Model
        app.getActiveCands().find(x=>x.id===id).val = val; 
        
        app.renderUI(); // Re-render numbers
        app.runSimulation();
    },

    getActiveCands: () => {
        if(app.state.turn === 1) {
            return app.state.cands.map(c => ({...c, val: c.t1}));
        } else {
            return app.state.cands
                .filter(c => app.state.t2_pair.includes(c.id))
                .map(c => ({...c, val: c.t2}));
        }
    },

    setTurn: (t) => {
        app.state.turn = t;
        document.getElementById('tab1').className = t===1?'tab active':'tab';
        document.getElementById('tab2').className = t===2?'tab active':'tab';
        document.getElementById('t2-config').style.display = t===2?'block':'none';
        app.renderUI();
        app.runSimulation();
    },

    updateT2: () => {
        app.state.t2_pair = [
            document.getElementById('sel-c1').value,
            document.getElementById('sel-c2').value
        ];
        app.renderUI();
        app.runSimulation();
    },

    setView: (v) => {
        app.state.view = v;
        document.getElementById('view-mun').className = v==='mun'?'map-toggle active':'map-toggle';
        document.getElementById('view-uf').className = v==='uf'?'map-toggle active':'map-toggle';
        app.renderMap();
    },

    renderResults: () => {
        const box = document.getElementById('resultsArea');
        const cands = app.getActiveCands().sort((a,b) => b.val - a.val);
        
        // Use National Average (Inputs) as the summary results
        let html = `<div class="res-header"><div class="res-title">BRASIL</div><div style="font-size:0.8rem; color:#888;">PROJEÇÃO NACIONAL</div></div>`;
        
        cands.forEach(c => {
            html += `
                <div class="res-row">
                    <div class="res-meta">
                        <span>${c.name}</span>
                        <span style="color:${c.color}">${c.val}%</span>
                    </div>
                    <div class="prog-track">
                        <div class="prog-fill" style="width:${c.val}%; background:${c.color}"></div>
                    </div>
                </div>
            `;
        });
        box.innerHTML = html;
    },

    // =========================================================================
    // MODAL REGIONAL
    // =========================================================================
    toggleModal: (show) => {
        document.getElementById('regionalModal').style.display = show ? 'flex' : 'none';
        if(show) app.renderRegionalGrid();
    },

    renderRegionalGrid: () => {
        const grid = document.getElementById('statesGrid');
        grid.innerHTML = '';
        const t = app.state.turn;
        const cands = app.getActiveCands();

        STATES_LIST.forEach(s => {
            const box = document.createElement('div');
            box.className = 'state-box';
            let rows = '';
            cands.forEach(c => {
                const val = app.state.multipliers[t][c.id][s.id];
                rows += `
                    <div class="st-input-row">
                        <span style="color:${c.color}">${c.name}</span>
                        <input class="st-input i-reg" type="number" step="0.1" value="${val}" data-cid="${c.id}" data-sid="${s.id}">
                    </div>
                `;
            });
            box.innerHTML = `<div class="state-name">${s.n}</div>${rows}`;
            grid.appendChild(box);
        });
    },

    saveRegional: () => {
        const t = app.state.turn;
        document.querySelectorAll('.i-reg').forEach(inp => {
            app.state.multipliers[t][inp.dataset.cid][inp.dataset.sid] = parseFloat(inp.value);
        });
        app.toggleModal(false);
        app.runSimulation();
    }
};

app.init();
</script>
</body>
</html>
