<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas V30 - Alto Contraste</title>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Dependências -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <style>
        /* ESTILO ESCURO DE ALTO CONTRASTE */
        :root {
            --bg-main: #000000;
            --bg-panel: #111111;
            --text-main: #ffffff;
            --text-muted: #888888;
            --border: #333333;
            --highlight: #ffffff;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-main); color: var(--text-main); height: 100vh; overflow: hidden; }
        #app { display: flex; height: 100%; width: 100%; }
        
        /* MAPA */
        #map { flex: 1; background: #000; }

        /* SIDEBARS */
        .sidebar {
            width: 350px; background: var(--bg-panel); 
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            z-index: 1000; box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }
        .sidebar-right { border-left: 1px solid var(--border); border-right: none; width: 400px; }

        .header { padding: 20px; border-bottom: 1px solid var(--border); background: #050505; }
        .header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }

        /* CONTROLES */
        .controls { padding: 20px; flex: 1; overflow-y: auto; }
        select, button {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: #000; border: 1px solid #444; color: white;
            font-family: inherit; cursor: pointer; text-transform: uppercase; font-size: 0.8rem;
        }
        button.btn-primary { background: white; color: black; font-weight: 800; border: none; }
        button.btn-primary:hover { background: #ddd; }

        /* LISTA RESULTADOS */
        .cand-row {
            display: flex; align-items: center; padding: 10px; 
            border-bottom: 1px solid #222; gap: 10px;
        }
        .cand-color { width: 15px; height: 15px; border: 1px solid #555; cursor: pointer; }
        .cand-name { flex: 1; font-weight: 700; font-size: 0.85rem; }
        .cand-pct { font-weight: 700; }
        .cand-votes { font-size: 0.75rem; color: var(--text-muted); text-align: right; }
        
        /* LEGENDA */
        .legend {
            position: absolute; bottom: 30px; right: 430px;
            background: black; border: 1px solid #333; padding: 10px;
            z-index: 999; width: 200px;
        }
        .grad-bar { height: 15px; width: 100%; display: flex; }
        .grad-step { flex: 1; }
        .leg-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; margin-top: 5px; }

        /* LOADER */
        #loader {
            position: absolute; inset: 0; background: black; z-index: 2000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
    </style>
</head>
<body>

<div id="loader">
    <h2 style="color:white">CARREGANDO DADOS...</h2>
</div>

<div id="app">
    <!-- ESQUERDA -->
    <aside class="sidebar">
        <div class="header"><h1>Atlas Eleitoral</h1></div>
        <div class="controls">
            <label>ANO</label>
            <select id="yearSelect">
                <option value="2022">2022</option>
                <option value="2018">2018</option>
                <option value="2014">2014</option>
                <option value="2010">2010</option>
                <option value="2006">2006</option>
                <option value="2002">2002</option>
                <option value="1998">1998</option>
                <option value="1994">1994</option>
            </select>
            
            <label>TURNO</label>
            <select id="turnSelect">
                <option value="1">1º Turno</option>
                <option value="2">2º Turno</option>
            </select>

            <label>CARGO</label>
            <select id="roleSelect">
                <option value="president">Presidente</option>
                <option value="governor">Governador</option>
                <option value="senator">Senador</option>
            </select>

            <label>MODO</label>
            <select id="viewModeSelect">
                <option value="states">Estados</option>
                <option value="all_cities">Municípios</option>
            </select>

            <button class="btn-primary" onclick="app.loadData()">ATUALIZAR MAPA</button>
        </div>
    </aside>

    <div id="map"></div>

    <!-- DIREITA -->
    <aside class="sidebar sidebar-right">
        <div class="header"><h1 id="regionName">Brasil</h1></div>
        <div style="padding:15px; border-bottom:1px solid #333; display:none" id="backBox">
            <button onclick="app.resetView()">VOLTAR AO BRASIL</button>
        </div>
        <div class="controls" id="resultsList"></div>
    </aside>

    <div class="legend">
        <div class="grad-bar" id="legendBar"></div>
        <div class="leg-labels"><span>0% (Branco)</span><span>100% (Cor)</span></div>
    </div>
</div>

<script>
const CONFIG = {
    colors: {
        'PT': '#ff0000', 'PL': '#0000ff', 'PSDB': '#0055aa', 'MDB': '#00aa00',
        'PDT': '#ff6600', 'PSB': '#ffcc00', 'DEM': '#008888', 'PFL': '#008888',
        'PRONA': '#004400', 'DEFAULT': '#555555'
    }
};

const app = {
    map: null,
    layers: {},
    data: { current: null, names: {} },
    state: { selectedId: null, colors: JSON.parse(localStorage.getItem('v30_cols')||'{}') },

    init: () => {
        app.map = L.map('map', { center: [-15, -50], zoom: 4, zoomControl: false, background:'#000' });
        
        // LEGENDA EXEMPLO (Cinza)
        const leg = document.getElementById('legendBar');
        for(let i=0; i<10; i++) {
            const d = document.createElement('div');
            d.className = 'grad-step';
            d.style.background = app.getColor('#555555', (i*10)+5);
            leg.appendChild(d);
        }
        
        app.loadData();
    },

    // --- NOVA LÓGICA DE COR (BRANCO -> COR) ---
    getColor: (hex, pct) => {
        // Interpolação Linear Simples
        // 0% = Branco (255,255,255)
        // 100% = Hex
        const factor = pct / 100;
        const c = app.hex2rgb(hex);
        
        const r = Math.round(255 + (c.r - 255) * factor);
        const g = Math.round(255 + (c.g - 255) * factor);
        const b = Math.round(255 + (c.b - 255) * factor);
        
        return `rgb(${r},${g},${b})`;
    },

    hex2rgb: (hex) => {
        let c = hex.replace('#','');
        if(c.length===3) c=c[0]+c[0]+c[1]+c[1]+c[2]+c[2];
        const n = parseInt(c,16);
        return {r: (n>>16)&255, g: (n>>8)&255, b: n&255};
    },

    loadData: async () => {
        document.getElementById('loader').classList.remove('hidden');
        const year = document.getElementById('yearSelect').value;
        const role = document.getElementById('roleSelect').value;
        const turn = document.getElementById('turnSelect').value;
        const mode = document.getElementById('viewModeSelect').value;

        try {
            // Carrega GeoJSON
            if(!app.layers.geo) {
                const geoUrl = mode === 'states' 
                    ? 'https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson'
                    : 'https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json';
                
                const geoRes = await fetch(geoUrl);
                const geoData = await geoRes.json();
                
                // Normaliza IDs
                const ufMap = {'AC':'12','AL':'27','AM':'13','AP':'16','BA':'29','CE':'23','DF':'53','ES':'32','GO':'52','MA':'21','MG':'31','MS':'50','MT':'51','PA':'15','PB':'25','PE':'26','PI':'22','PR':'41','RJ':'33','RN':'24','RO':'11','RR':'14','RS':'43','SC':'42','SE':'28','SP':'35','TO':'17'};
                
                geoData.features.forEach(f => {
                    if(mode==='states') f.id = ufMap[f.properties.sigla];
                    else f.id = (f.properties.id || f.properties.codarea).toString();
                });

                if(app.layers.map) app.map.removeLayer(app.layers.map);
                
                app.layers.map = L.geoJSON(geoData, {
                    style: f => app.style(f),
                    onEachFeature: (f, l) => {
                        l.on('click', () => app.select(f.id, app.getName(f.id)));
                        l.bindTooltip(() => app.tooltip(f.id), {sticky:true, direction:'top'});
                    }
                }).addTo(app.map);
            }

            // Carrega Votos
            const res = await fetch(`data/${year}_${role}.json`);
            if(!res.ok) throw new Error("Sem dados");
            const json = await res.json();
            
            if(!json[turn]) throw new Error("Turno vazio");
            app.data.current = json[turn];
            app.data.names = json[turn].meta_nomes || {};
            
            app.updateUI();
            
        } catch(e) {
            console.error(e);
            alert("Dados indisponíveis para esta seleção.");
        } finally {
            document.getElementById('loader').classList.add('hidden');
        }
    },

    style: (f) => {
        const stats = app.getStats(f.id);
        if(!stats) return {fillColor:'#222', color:'#000', weight:1, fillOpacity:1};
        
        const party = stats.winner.match(/\((.*?)\)/)?.[1] || 'DEFAULT';
        const baseColor = app.state.colors[party] || CONFIG.colors[party] || '#555';
        
        return {
            fillColor: app.getColor(baseColor, stats.pct),
            color: '#000000', weight: 1, fillOpacity: 1
        };
    },

    getStats: (id) => {
        if(!app.data.current) return null;
        
        // Se for modo estadual, agrega municípios
        let votes = {};
        
        if(id.length === 2) { // Estado
             // Filtra municipios que começam com esse UF
             Object.entries(app.data.current.municipios).forEach(([mid, vals]) => {
                 if(mid.startsWith(id) || (mid.startsWith('9000') && mid.includes(id))) { // Fallback para fake IDs
                     Object.entries(vals).forEach(([c,v]) => votes[c] = (votes[c]||0)+v);
                 }
             });
        } else {
            votes = app.data.current.municipios[id] || {};
        }

        if(Object.keys(votes).length === 0) return null;

        let total = 0, max = -1, win = null;
        let rank = [];
        Object.entries(votes).forEach(([c,v]) => {
            total+=v;
            if(v>max){max=v; win=c;}
            rank.push({c,v});
        });
        
        rank.sort((a,b)=>b.v-a.v);
        return {winner:win, pct:(max/total)*100, rank, total};
    },

    select: (id, name) => {
        app.state.selectedId = id;
        document.getElementById('regionName').textContent = name || id;
        document.getElementById('backBox').style.display = 'block';
        app.updateUI();
    },

    resetView: () => {
        app.state.selectedId = null;
        document.getElementById('regionName').textContent = "Brasil";
        document.getElementById('backBox').style.display = 'none';
        app.updateUI();
        app.map.setView([-15, -50], 4);
    },

    updateUI: () => {
        // Atualiza Mapa
        app.layers.map.setStyle(f => app.style(f));
        
        // Atualiza Barra
        const list = document.getElementById('resultsList');
        list.innerHTML = '';
        
        let stats;
        if(app.state.selectedId) {
            stats = app.getStats(app.state.selectedId);
        } else {
            // Nacional (Soma tudo)
            let agg = {};
            Object.values(app.data.current.municipios).forEach(m => {
                Object.entries(m).forEach(([c,v]) => agg[c]=(agg[c]||0)+v);
            });
            let total=0, rank=[];
            Object.entries(agg).forEach(([c,v]) => {total+=v; rank.push({c,v})});
            rank.sort((a,b)=>b.v-a.v);
            stats = {total, rank};
        }

        if(stats) {
            list.innerHTML = `<div style="padding:10px;text-align:center;border-bottom:1px solid #333;margin-bottom:10px">TOTAL: ${stats.total.toLocaleString()}</div>`;
            stats.rank.forEach(r => {
                const party = r.c.match(/\((.*?)\)/)?.[1] || 'DEFAULT';
                const color = app.state.colors[party] || CONFIG.colors[party] || '#555';
                const pct = (r.v/stats.total*100).toFixed(2);
                
                list.innerHTML += `
                    <div class="cand-row">
                        <div class="cand-color" style="background:${color}" onclick="app.pickColor('${party}', this)"></div>
                        <div class="cand-name">${r.c}</div>
                        <div style="text-align:right">
                            <div class="cand-pct" style="color:${color}">${pct}%</div>
                            <div class="cand-votes">${r.v.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
        }
    },

    getName: (id) => app.data.names[id] || id,
    
    tooltip: (id) => {
        const stats = app.getStats(id);
        const name = app.getName(id);
        if(!stats) return name;
        return `<div style="background:black;color:white;padding:5px;border:1px solid #555">
            <strong>${name}</strong><br>
            ${stats.winner.split('(')[0]}<br>
            ${stats.pct.toFixed(1)}%
        </div>`;
    },

    pickColor: (party, el) => {
        const p = Pickr.create({
            el: el, theme: 'nano', 
            default: app.state.colors[party] || CONFIG.colors[party],
            components: {preview:true, hue:true, interaction:{save:true}}
        });
        p.on('save', c => {
            app.state.colors[party] = c.toHEXA().toString();
            localStorage.setItem('v30_cols', JSON.stringify(app.state.colors));
            app.updateUI();
            p.destroyAndRemove();
        });
    }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
