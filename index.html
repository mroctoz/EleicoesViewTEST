<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Eleitoral V26 - Simulador</title>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Fonts/Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Color Picker -->
    <link href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <style>
        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #11141a;
            --bg-card: rgba(20, 24, 32, 0.98);
            --accent-blue: #3b82f6;
            --text-primary: #ffffff;
            --text-muted: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --gradient-primary: linear-gradient(135deg, #3b82f6, #8b5cf6);
            --sim-highlight: #e11d48;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; height: 100vh; }

        #app { width: 100vw; height: 100vh; display: flex; position: relative; }
        
        /* MAPA */
        #map { flex: 1; height: 100%; background: #1a1a1a; z-index: 1; }

        /* SIDEBARS */
        .sidebar {
            width: 380px; background: var(--bg-card); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; z-index: 1000;
            border-right: 1px solid var(--border-color);
            box-shadow: 5px 0 30px rgba(0,0,0,0.5);
        }
        .sidebar-right { border-left: 1px solid var(--border-color); border-right: none; width: 420px; }

        .header {
            padding: 24px;
            background: linear-gradient(180deg, rgba(10, 12, 16, 1) 0%, rgba(10, 12, 16, 0.8) 100%);
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 {
            font-size: 1.4rem; font-weight: 800;
            background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* CONTROLS & TABS */
        .controls { padding: 20px; flex: 1; overflow-y: auto; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; font-weight: 700; text-transform: uppercase; }
        
        select {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333;
            background-color: #050505; color: white; font-family: inherit; font-size: 0.9rem;
            appearance: none; cursor: pointer;
        }
        
        button.btn-primary { 
            width: 100%; padding: 12px; border-radius: 8px;
            background: var(--gradient-primary); border: none; 
            font-weight: 700; color: white; cursor: pointer; margin-top: 10px;
        }

        /* SIMULATOR STYLES */
        .sim-container { background: rgba(255, 0, 60, 0.05); border: 1px solid var(--sim-highlight); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .sim-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.8rem; font-weight: 700; color: var(--sim-highlight); }
        .sim-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .sim-label { width: 100px; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .sim-slider { flex: 1; accent-color: var(--sim-highlight); cursor: pointer; height: 4px; }
        .sim-val { width: 45px; text-align: right; font-family: monospace; font-size: 0.85rem; color: #fff; }
        
        .total-box { 
            margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; 
            display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700;
        }
        .total-box.ok { color: #4ade80; border: 1px solid #4ade80; }
        .total-box.error { color: #f87171; border: 1px solid #f87171; }

        .btn-second-turn {
            width: 100%; padding: 10px; margin-top: 10px; background: #222; border: 1px solid #444; color: #ddd;
            border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-second-turn:hover { background: #333; }
        .btn-second-turn.active { background: var(--sim-highlight); border-color: var(--sim-highlight); color: white; }

        .st-controls { margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.4); border-radius: 6px; display: none; }
        .st-controls.show { display: block; animation: fadeIn 0.3s; }
        .st-selects { display: flex; gap: 5px; margin-top: 5px; }

        /* LIST & MAP */
        .cand-row {
            display: flex; align-items: center; gap: 10px; padding: 12px; margin-bottom: 8px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .cand-color { width: 12px; height: 12px; border-radius: 50%; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 6px; flex: 1; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }

        .legend {
            position: absolute; bottom: 30px; right: 450px;
            background: #0a0c10; padding: 15px; border: 1px solid #333;
            border-radius: 12px; z-index: 999;
        }
        .legend-grid { display: flex; height: 15px; width: 200px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .legend-item { flex: 1; }

        #loader {
            position: absolute; inset: 0; background: rgba(5,5,5,0.95); z-index: 9999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            color: white;
        }
        .hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loader">
    <div style="margin-bottom: 10px; font-weight: 700;">Carregando Atlas...</div>
    <div style="width: 200px; height: 4px; background: #333; border-radius: 2px;">
        <div id="loadBar" style="width: 0%; height: 100%; background: var(--accent-blue); transition: width 0.3s;"></div>
    </div>
</div>

<div id="app">
    <!-- SIDEBAR ESQUERDA -->
    <aside class="sidebar">
        <div class="header">
            <h1>Atlas V25</h1>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Simulador & Histórico</div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>MODO</label>
                <select id="modeSelect" onchange="app.switchMode()">
                    <option value="sim2026">★ SIMULADOR 2026</option>
                    <option value="hist">HISTÓRICO (1994-2022)</option>
                </select>
            </div>

            <!-- SIMULADOR -->
            <div id="simContainer" class="sim-container">
                <div class="sim-header">
                    <span>INTENÇÃO DE VOTO</span>
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div id="slidersList"></div>
                
                <div class="total-box" id="simTotalBox">
                    <span>TOTAL</span>
                    <span id="simTotalVal">100%</span>
                </div>

                <button class="btn-second-turn" id="btnST" onclick="app.toggleSecondTurn()">
                    <i class="fas fa-vote-yea"></i> Simular 2º Turno
                </button>

                <div class="st-controls" id="stPanel">
                    <label>QUEM AVANÇA?</label>
                    <div class="st-selects">
                        <select id="stC1" onchange="app.calcMap()"></select>
                        <select id="stC2" onchange="app.calcMap()"></select>
                    </div>
                </div>
            </div>

            <!-- HISTÓRICO (Escondido por padrão) -->
            <div id="histControls" style="display: none;">
                <div class="control-group">
                    <label>ANO</label>
                    <select id="histYear"><option value="2022">2022</option><option value="2018">2018</option></select>
                </div>
                <div class="control-group">
                    <label>CARGO</label>
                    <select id="histRole"><option value="president">Presidente</option></select>
                </div>
                <button class="btn-primary" onclick="app.loadHistorical()">Carregar</button>
            </div>
        </div>
    </aside>

    <div id="map"></div>

    <!-- SIDEBAR DIREITA -->
    <aside class="sidebar sidebar-right">
        <div class="header">
            <h2 id="regionName">Brasil</h2>
            <div style="font-size: 0.8rem; color: var(--accent-blue);">Resultado Projetado</div>
        </div>
        <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
            <button id="btnBack" class="btn-primary" style="display:none; background:#222; margin-bottom:10px;" onclick="app.resetSelection()">Voltar ao Nacional</button>
            <div style="font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted);">Votos Totais (Est. 2022)</div>
            <div id="totalVotesVal" style="font-size: 1.4rem; font-weight: 800; color: white;">-</div>
        </div>
        <div class="controls" id="resultsList"></div>
    </aside>

    <div class="legend">
        <div style="font-size: 0.75rem; font-weight: 700; color: white; margin-bottom: 4px;">Percentual do Vencedor</div>
        <div class="legend-grid" id="legendColors"></div>
        <div style="display: flex; justify-content: space-between; font-size: 0.6rem; color: #aaa; margin-top: 4px;">
            <span>&le;35% (Claro)</span><span>&ge;65% (Saturado)</span>
        </div>
    </div>
</div>

<script>
// ================= CONFIGURAÇÃO DO SIMULADOR =================
// Base: Esquerda(L), Direita(R), Centro(C)
// Home: Código IBGE UF
// Boost: Força no estado natal
const CANDIDATES = [
    { id: 'LULA', name: 'Lula (PT)', color: '#E12525', base: 'L', home: '26', default: 45.0, homeBoost: 1.2 },
    { id: 'FLAVIO', name: 'Flávio (PL)', color: '#0E345D', base: 'R', home: '33', default: 30.0, homeBoost: 2.0 },
    { id: 'RATINHO', name: 'Ratinho Jr (PSD)', color: '#FAA21B', base: 'R', home: '41', default: 6.0, homeBoost: 8.0 },
    { id: 'CAIADO', name: 'Caiado (UNIÃO)', color: '#009EE3', base: 'R', home: '52', default: 6.0, homeBoost: 8.0 },
    { id: 'RENAN', name: 'Renan Santos (M)', color: '#FCD303', base: 'C', home: '35', default: 5.0, homeBoost: 2.0 }, // MBL forte SP Capital
    { id: 'CIRO', name: 'Ciro Gomes (PSDB)', color: '#008000', base: 'C', home: '23', default: 5.0, homeBoost: 5.0 },
    { id: 'ALDO', name: 'Aldo Rabelo (DC)', color: '#800080', base: 'C', home: '27', default: 2.0, homeBoost: 2.0 },
    { id: 'ZEMA', name: 'Romeu Zema (NOVO)', color: '#FF5722', base: 'R', home: '31', default: 1.0, homeBoost: 5.0 }
];

const app = {
    map: null,
    layers: { mun: null },
    data: { base2026: null, geoJson: null, simResults: null },
    state: { mode: 'sim2026', selectedId: null, selectedName: 'Brasil', secondTurn: false },

    init: async () => {
        // Inicializar Mapa
        app.map = L.map('map', { center: [-15, -50], zoom: 4, zoomControl: false, preferCanvas: true, background: '#1a1a1a' });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.3 }).addTo(app.map);
        
        app.createLegend();
        app.buildSliders();
        
        // Carregar Dados
        try {
            app.setLoad(20);
            const geo = await fetch("https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json");
            app.data.geoJson = await geo.json();
            
            app.setLoad(60);
            // IMPORTANTE: Certifique-se que o Python gerou este arquivo em data/
            const base = await fetch("data/2026_base.json");
            if(!base.ok) throw new Error("JSON Base não encontrado em data/");
            const json = await base.json();
            app.data.base2026 = json["1"].base_inteligencia;
            
            app.setLoad(100);
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
                app.calcMap();
            }, 500);
        } catch(e) {
            alert("Erro ao carregar dados: " + e.message);
        }
    },

    setLoad: (pct) => document.getElementById('loadBar').style.width = pct + '%',

    createLegend: () => {
        const el = document.getElementById('legendColors');
        // Gradiente cinza para representar intensidade
        for(let i=3; i<=10; i++) {
            const div = document.createElement('div');
            div.className = 'legend-item';
            const val = Math.round(255 - (i * 20));
            div.style.background = `rgb(${val},${val},${val})`;
            el.appendChild(div);
        }
    },

    buildSliders: () => {
        const c = document.getElementById('slidersList');
        const s1 = document.getElementById('stC1');
        const s2 = document.getElementById('stC2');
        
        CANDIDATES.forEach(cand => {
            const div = document.createElement('div');
            div.className = 'sim-row';
            div.innerHTML = `
                <div style="width:4px; height:20px; background:${cand.color}; border-radius:2px;"></div>
                <div class="sim-label">${cand.name}</div>
                <input type="range" class="sim-slider" id="sl_${cand.id}" min="0" max="100" step="0.5" value="${cand.default}" oninput="app.updateSlider('${cand.id}', this.value)">
                <div class="sim-val" id="val_${cand.id}">${cand.default}%</div>
            `;
            c.appendChild(div);
            
            s1.add(new Option(cand.name, cand.id));
            s2.add(new Option(cand.name, cand.id));
        });
        s1.value = 'LULA'; s2.value = 'FLAVIO';
        app.checkTotal();
    },

    updateSlider: (id, val) => {
        document.getElementById(`val_${id}`).innerText = parseFloat(val).toFixed(1) + '%';
        app.checkTotal();
        if(app.calcTimer) clearTimeout(app.calcTimer);
        app.calcTimer = setTimeout(app.calcMap, 200); // Debounce
    },

    checkTotal: () => {
        let sum = 0;
        CANDIDATES.forEach(c => sum += parseFloat(document.getElementById(`sl_${c.id}`).value));
        const box = document.getElementById('simTotalBox');
        document.getElementById('simTotalVal').innerText = sum.toFixed(1) + '%';
        
        box.className = 'total-box';
        if(sum > 100.1) box.classList.add('error');
        else if(sum > 99.0) box.classList.add('ok');
    },

    toggleSecondTurn: () => {
        app.state.secondTurn = !app.state.secondTurn;
        document.getElementById('stPanel').classList.toggle('show', app.state.secondTurn);
        document.getElementById('btnST').classList.toggle('active', app.state.secondTurn);
        app.calcMap();
    },

    // --- CÉREBRO DA SIMULAÇÃO ---
    calcMap: () => {
        const result = {};
        const munData = app.data.base2026;
        
        // 1. Ler Inputs Nacionais
        const targets = {};
        let sumTargets = 0;
        CANDIDATES.forEach(c => {
            targets[c.id] = parseFloat(document.getElementById(`sl_${c.id}`).value);
            sumTargets += targets[c.id];
        });
        
        // Normalização matemática para cálculos internos (base 1)
        if(sumTargets > 0) Object.keys(targets).forEach(k => targets[k] /= sumTargets);

        // 2. Definir Espectros Nacionais (Quanto % cada bloco tem no total)
        const spectrumStats = { L: 0, R: 0, C: 0 };
        const spectrumWeights = { L: {}, R: {}, C: {} }; // Pesos relativos de cada candidato dentro do bloco
        
        CANDIDATES.forEach(c => {
            spectrumStats[c.base] += targets[c.id];
            spectrumWeights[c.base][c.id] = targets[c.id];
        });

        // 3. Processar cada município
        for(const [ibge, prof] of Object.entries(munData)) {
            const votes = {};
            const totalPop = prof.TOT;
            const uf = prof.UF;

            // Fator de Swing: Comparar o Nacional Desejado vs Histórico 2022
            // Ex: Se Esquerda tinha 48% em 2022 e usuário quer 40%, reduzimos 17% de todos os potes L
            // Valores aprox 2022: L=0.48, R=0.43, C=0.09
            const swingL = spectrumStats.L / 0.48; 
            const swingR = spectrumStats.R / 0.43;
            // Centro é residual

            // Tamanho dos Potes Locais Ajustados
            let potL = (prof.L * totalPop) * swingL;
            let potR = (prof.R * totalPop) * swingR;
            let potC = totalPop - potL - potR; 
            if(potC < 0) { // Normaliza se estourar
                const f = totalPop / (potL + potR);
                potL *= f; potR *= f; potC = 0;
            }

            // Função para distribuir o pote entre candidatos do mesmo espectro
            const distribute = (baseType, potSize) => {
                let localWeights = {};
                let sumW = 0;
                
                // Calcula peso local de cada candidato (considerando Home State)
                Object.keys(spectrumWeights[baseType]).forEach(candId => {
                    const cand = CANDIDATES.find(x => x.id === candId);
                    let w = spectrumWeights[baseType][candId]; // Peso nacional
                    if(cand.home === uf) w *= cand.homeBoost; // Boost
                    localWeights[candId] = w;
                    sumW += w;
                });

                // Atribui votos
                if(sumW > 0) {
                    Object.entries(localWeights).forEach(([cid, w]) => {
                        votes[cid] = potSize * (w / sumW);
                    });
                }
            };

            distribute('L', potL);
            distribute('R', potR);
            distribute('C', potC);

            // SEGUNDO TURNO
            if(app.state.secondTurn) {
                const c1 = document.getElementById('stC1').value;
                const c2 = document.getElementById('stC2').value;
                let v1 = votes[c1] || 0;
                let v2 = votes[c2] || 0;

                // Redistribuir perdedores
                Object.keys(votes).forEach(cid => {
                    if(cid !== c1 && cid !== c2) {
                        const v = votes[cid];
                        const cand = CANDIDATES.find(x => x.id === cid);
                        const cand1 = CANDIDATES.find(x => x.id === c1);
                        
                        // Transferência Ideológica Simples
                        // Mesma base: 90% vai pro aliado
                        // Base oposta: 10% vai pro rival
                        let probC1 = 0.5;
                        if(cand.base === cand1.base) probC1 = 0.90;
                        else if(cand.base !== 'C' && cand1.base !== 'C' && cand.base !== cand1.base) probC1 = 0.10;
                        
                        v1 += v * probC1;
                        v2 += v * (1 - probC1);
                    }
                });
                result[ibge] = { [c1]: v1, [c2]: v2, TOTAL: v1+v2 };
            } else {
                votes.TOTAL = totalPop;
                result[ibge] = votes;
            }
        }

        app.data.simResults = result;
        app.renderMap();
        app.updateRightPanel();
    },

    renderMap: () => {
        if(app.layers.mun) app.map.removeLayer(app.layers.mun);
        if(!app.data.simResults) return;

        app.layers.mun = L.geoJSON(app.data.geoJson, {
            smoothFactor: 0.5,
            style: (feature) => {
                const id = feature.properties.id || feature.properties.codarea;
                const res = app.data.simResults[id];
                if(!res || res.TOTAL === 0) return { fillColor: '#333', weight: 0 };

                // Achar vencedor
                let winner = null, max = -1;
                Object.entries(res).forEach(([k,v]) => { if(k!=='TOTAL' && v>max){ max=v; winner=k; }});
                
                const pct = (max / res.TOTAL) * 100;
                const cObj = CANDIDATES.find(c => c.id === winner);
                const color = cObj ? cObj.color : '#555';

                return {
                    fillColor: app.getGradient(color, pct),
                    weight: app.state.selectedId == id ? 1.5 : 0.2,
                    color: app.state.selectedId == id ? '#fff' : '#000',
                    fillOpacity: 1
                };
            },
            onEachFeature: (f, l) => l.on('click', () => app.selectRegion(f.properties.id || f.properties.codarea, f.properties.name))
        }).addTo(app.map);
    },

    getGradient: (hex, pct) => {
        // Mistura branco com a cor para simular intensidade
        // 35% = Muito Branco, 65% = Cor Pura
        let mix = 0;
        if(pct < 35) mix = 0.7;
        else if(pct < 45) mix = 0.5;
        else if(pct < 55) mix = 0.3;
        else if(pct < 65) mix = 0.1;
        
        const c = parseInt(hex.replace('#',''), 16);
        const r = (c >> 16) & 255;
        const g = (c >> 8) & 255;
        const b = c & 255;
        
        const nr = Math.round(r + (255-r)*mix);
        const ng = Math.round(g + (255-g)*mix);
        const nb = Math.round(b + (255-b)*mix);
        
        return `rgb(${nr},${ng},${nb})`;
    },

    updateRightPanel: () => {
        const list = document.getElementById('resultsList');
        const totalVal = document.getElementById('totalVotesVal');
        const regionName = document.getElementById('regionName');
        list.innerHTML = '';

        const ids = app.state.selectedId ? [app.state.selectedId] : Object.keys(app.data.simResults);
        regionName.innerText = app.state.selectedName;
        
        // Agregar
        let agg = {}, grandTotal = 0;
        ids.forEach(id => {
            const d = app.data.simResults[id];
            if(d) {
                Object.keys(d).forEach(k => { if(k!=='TOTAL') agg[k] = (agg[k]||0)+d[k]; });
                grandTotal += d.TOTAL;
            }
        });
        
        totalVal.innerText = grandTotal.toLocaleString('pt-BR');
        
        // Ordenar
        const sorted = Object.entries(agg).sort((a,b) => b[1] - a[1]);
        
        sorted.forEach(([cid, votes]) => {
            const pct = (votes / grandTotal) * 100;
            const cObj = CANDIDATES.find(c => c.id === cid);
            const div = document.createElement('div');
            div.className = 'cand-row';
            div.innerHTML = `
                <div class="cand-color" style="background:${cObj.color}"></div>
                <div style="flex:1">
                    <div style="display:flex; justify-content:space-between; font-weight:700;">
                        <span>${cObj.name}</span>
                        <span style="color:${cObj.color}">${pct.toFixed(2)}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%; background:${cObj.color}"></div></div>
                </div>
            `;
            list.appendChild(div);
        });
    },

    selectRegion: (id, name) => {
        app.state.selectedId = id; app.state.selectedName = name;
        document.getElementById('btnBack').style.display = 'block';
        app.updateRightPanel();
        app.renderMap();
    },
    resetSelection: () => {
        app.state.selectedId = null; app.state.selectedName = 'Brasil';
        document.getElementById('btnBack').style.display = 'none';
        app.updateRightPanel();
        app.renderMap();
    },
    switchMode: () => {
        const m = document.getElementById('modeSelect').value;
        document.getElementById('simContainer').style.display = m === 'sim2026' ? 'block' : 'none';
        document.getElementById('histControls').style.display = m === 'hist' ? 'block' : 'none';
        if(m==='sim2026') app.calcMap();
    }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
