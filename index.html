<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Eleições 2026</title>
    
    <!-- Leaflet & Dependências -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* TEMA ESCURO DE ALTO CONTRASTE */
        :root {
            --bg: #050505;
            --panel: #111;
            --text: #eee;
            --border: #333;
            --pt: #c4122d; /* Vermelho PT */
            --pl: #002f6c; /* Azul PL */
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        
        #map { flex: 1; background: #0a0a0a; z-index: 1; }

        /* SIDEBAR */
        .sidebar {
            width: 380px; background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 1000;
            box-shadow: 10px 0 30px #000;
        }

        .header { padding: 25px; background: #000; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        
        .controls { padding: 20px; flex: 1; overflow-y: auto; }

        /* SCOREBOARD (PLACAR) */
        .scoreboard {
            display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 25px;
        }
        .cand-box { text-align: center; width: 45%; }
        .cand-val { font-size: 1.8rem; font-weight: 800; display: block; }
        .cand-label { font-size: 0.8rem; color: #888; font-weight: 600; }

        /* SLIDER */
        .slider-group { margin-bottom: 30px; }
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer; margin: 15px 0;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; background: linear-gradient(90deg, var(--pl), #fff, var(--pt)); border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 26px; width: 26px; border-radius: 50%;
            background: #fff; margin-top: -9px; box-shadow: 0 0 10px rgba(0,0,0,0.8); border: 2px solid #000;
        }

        /* RESULTADOS */
        .stats-box { background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .stats-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .stats-val { font-weight: 700; }

        /* LEGENDA */
        .legend {
            position: absolute; bottom: 25px; right: 25px; z-index: 999;
            background: #000; padding: 15px; border: 1px solid #333; border-radius: 8px; width: 240px;
        }
        .grad-bar { height: 12px; width: 100%; background: linear-gradient(90deg, var(--pl), #fff, var(--pt)); margin-top: 5px; border-radius: 2px; }
        .leg-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: #888; margin-top: 4px; font-weight: 600; }

        /* TOOLTIP */
        .map-tooltip {
            background: rgba(0,0,0,0.95); border: 1px solid #555; color: #fff; 
            padding: 8px 12px; border-radius: 4px; font-family: 'Inter', sans-serif; font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* LOADER */
        #loader {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .loader-bar { width: 200px; height: 3px; background: #333; margin-top: 15px; border-radius: 2px; }
        .loader-fill { width: 0%; height: 100%; background: var(--pt); transition: width 0.3s; }
    </style>
</head>
<body>

<div id="loader">
    <h3 id="loadText" style="font-weight: 400; letter-spacing: 1px;">INICIANDO SISTEMA...</h3>
    <div class="loader-bar"><div class="loader-fill" id="loadFill"></div></div>
</div>

<aside class="sidebar">
    <div class="header">
        <h1>Simulador 2026</h1>
        <div style="font-size:0.75rem; color:#666; margin-top:5px">Cenário Base: Eleiçòes 2022</div>
    </div>

    <div class="controls">
        <!-- PLACAR -->
        <div class="scoreboard">
            <div class="cand-box">
                <span class="cand-label" style="color:var(--pl)">DIREITA</span>
                <span class="cand-val" id="dispPl">49.1%</span>
            </div>
            <div style="font-size:1.2rem; color:#444">VS</div>
            <div class="cand-box">
                <span class="cand-label" style="color:var(--pt)">ESQUERDA</span>
                <span class="cand-val" id="dispPt">50.9%</span>
            </div>
        </div>

        <!-- SLIDER -->
        <div class="slider-group">
            <label style="font-size:0.8rem; color:#888; font-weight:700; display:block; margin-bottom:10px;">
                INTENÇÃO DE VOTO NACIONAL (ESQUERDA)
            </label>
            <input type="range" id="simSlider" min="30" max="70" step="0.1" value="50.9">
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#555;">
                <span>Vitória Direita</span>
                <span>Empate</span>
                <span>Vitória Esquerda</span>
            </div>
        </div>

        <!-- ESTATÍSTICAS -->
        <div class="stats-box">
            <div style="font-size:0.75rem; color:#666; margin-bottom:12px; font-weight:700">PROJEÇÃO DE MUNICÍPIOS</div>
            <div class="stats-row">
                <span>Vitórias Esquerda:</span>
                <span class="stats-val" style="color:var(--pt)" id="countPt">0</span>
            </div>
            <div class="stats-row">
                <span>Vitórias Direita:</span>
                <span class="stats-val" style="color:var(--pl)" id="countPl">0</span>
            </div>
        </div>
        
        <div style="margin-top:20px; padding: 15px; border: 1px solid #333; border-radius: 8px; font-size:0.75rem; color:#666; line-height:1.5">
            <i class="fas fa-info-circle"></i> <strong>Swing Uniforme:</strong> 
            A variação nacional é aplicada proporcionalmente ao histórico de cada cidade, preservando a identidade política regional.
        </div>
    </div>
</aside>

<div id="map"></div>

<!-- LEGENDA DE ALTO CONTRASTE -->
<div class="legend">
    <div style="font-size:0.7rem; font-weight:700; color:#fff; text-align:center; margin-bottom:5px">INTENSIDADE DO VOTO</div>
    <div class="grad-bar"></div>
    <div class="leg-labels">
        <span>100% Dir</span>
        <span>Empate (Branco)</span>
        <span>100% Esq</span>
    </div>
</div>

<script>
const app = {
    map: null,
    geoLayer: null,
    data: null, // Será carregado do JSON
    basePct: 0.509, // Valor padrão de 2022

    init: async () => {
        // Inicializa Mapa (Fundo Escuro)
        app.map = L.map('map', {center: [-15, -50], zoom: 4, zoomControl: false, background:'#0a0a0a', preferCanvas: true});
        
        // Camada Base Leve (CartoDB Dark)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {opacity: 0.4}).addTo(app.map);
        
        // Listener do Slider
        document.getElementById('simSlider').addEventListener('input', (e) => app.simulate(parseFloat(e.target.value)));
        
        await app.loadFiles();
    },

    loadFiles: async () => {
        const bar = document.getElementById('loadFill');
        const txt = document.getElementById('loadText');

        try {
            // 1. Carregar Malha Municipal (GeoJSON Simplificado)
            txt.innerText = "BAIXANDO MAPA...";
            bar.style.width = '30%';
            const geoRes = await fetch('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json');
            if (!geoRes.ok) throw new Error("Falha ao baixar mapa.");
            const geoJson = await geoRes.json();

            // 2. Carregar Dados do Cenário (JSON Externo)
            txt.innerText = "LENDO DADOS DE 2026...";
            bar.style.width = '60%';
            
            // Tenta carregar da pasta data/
            const dataRes = await fetch('data/cenario_base_2026.json');
            if (!dataRes.ok) throw new Error("Arquivo 'data/cenario_base_2026.json' não encontrado. Verifique se o script Python rodou corretamente.");
            
            app.data = await dataRes.json();
            
            // Configurar Base com dados reais do arquivo
            if (app.data.meta && app.data.meta.base_nacional) {
                app.basePct = app.data.meta.base_nacional;
            }
            
            // Atualizar Slider para posição inicial
            const startVal = (app.basePct * 100).toFixed(1);
            document.getElementById('simSlider').value = startVal;

            // 3. Renderizar Mapa
            txt.innerText = "RENDERIZANDO...";
            bar.style.width = '90%';
            
            // Pequeno delay para a UI atualizar
            await new Promise(r => setTimeout(r, 50));

            app.renderMap(geoJson);
            
            // Rodar simulação inicial
            app.simulate(parseFloat(startVal));
            
            document.getElementById('loader').classList.add('hidden');

        } catch (e) {
            console.error(e);
            alert("ERRO DE CARREGAMENTO:\n" + e.message + "\n\nCertifique-se de estar rodando em um servidor local (python -m http.server).");
            txt.innerText = "ERRO FATAL";
            txt.style.color = "red";
        }
    },

    renderMap: (geoJson) => {
        app.geoLayer = L.geoJSON(geoJson, {
            style: { fillColor: '#333', weight: 0.5, color: '#000', fillOpacity: 1 }, 
            onEachFeature: (f, l) => {
                // Normaliza ID do município
                const id = (f.properties.id || f.properties.codarea).toString();
                f.ibge = id; 
                l.bindTooltip(() => app.getTooltip(f.ibge), {sticky: true, direction: 'top', className: 'map-tooltip'});
            }
        }).addTo(app.map);
    },

    simulate: (targetPtPct) => {
        // Cálculo do Swing (Variação)
        const swing = (targetPtPct / 100) - app.basePct;
        
        // Atualiza Placar
        document.getElementById('dispPt').innerText = targetPtPct.toFixed(1) + '%';
        document.getElementById('dispPl').innerText = (100 - targetPtPct).toFixed(1) + '%';

        let cPt = 0, cPl = 0;

        app.geoLayer.eachLayer(layer => {
            const id = layer.feature.ibge;
            // Busca dados do município no JSON carregado [pct_2022, total_votos]
            const cityData = app.data.dados[id]; 

            if (cityData) {
                const baseCityPct = cityData[0];
                
                // Aplica Swing
                let newPct = baseCityPct + swing;
                // Trava entre 0% e 100%
                newPct = Math.max(0, Math.min(1, newPct));
                
                layer.feature.simPct = newPct; // Salva para tooltip

                // Contagem
                if (newPct > 0.5) cPt++; else cPl++;

                // Define Cor (Opaca + Contorno Preto)
                layer.setStyle({
                    fillColor: app.getColor(newPct),
                    fillOpacity: 1,
                    weight: 0.5,
                    color: '#000000'
                });
            } else {
                // Sem dados (Cinza Escuro)
                layer.setStyle({fillColor: '#222', color:'#000'});
            }
        });

        document.getElementById('countPt').innerText = cPt.toLocaleString();
        document.getElementById('countPl').innerText = cPl.toLocaleString();
    },

    // --- NOVA LÓGICA DE COR (ALTO CONTRASTE) ---
    // 0.5 = Branco Puro (#FFFFFF)
    // 1.0 = Vermelho Puro
    // 0.0 = Azul Puro
    getColor: (pct) => {
        if (pct > 0.5) {
            // ESQUERDA (0.5 a 1.0)
            const intensity = (pct - 0.5) * 2;
            return app.mixWhite('#c4122d', intensity); 
        } else {
            // DIREITA (0.5 a 0.0)
            const intensity = (0.5 - pct) * 2;
            return app.mixWhite('#002f6c', intensity);
        }
    },

    // Mistura Branco (255) com Cor (r,g,b)
    // Intensity 0 = Branco, Intensity 1 = Cor
    mixWhite: (hex, intensity) => {
        const n = parseInt(hex.replace('#',''), 16);
        const r = (n >> 16) & 255;
        const g = (n >> 8) & 255;
        const b = n & 255;

        const nr = Math.round(255 + (r - 255) * intensity);
        const ng = Math.round(255 + (g - 255) * intensity);
        const nb = Math.round(255 + (b - 255) * intensity);

        return `rgb(${nr},${ng},${nb})`;
    },

    getTooltip: (id) => {
        const name = (app.data.nomes && app.data.nomes[id]) ? app.data.nomes[id] : id;
        const simPct = app.geoLayer.getLayers().find(l => l.feature.ibge == id)?.feature?.simPct;
        
        if (simPct === undefined) return `${name}: Sem dados`;

        const winner = simPct > 0.5 ? "ESQUERDA" : "DIREITA";
        const color = simPct > 0.5 ? "var(--pt)" : "var(--pl)";
        const val = simPct > 0.5 ? simPct : (1 - simPct);

        return `
            <div style="font-weight:700; border-bottom:1px solid #555; margin-bottom:5px; padding-bottom:3px">${name}</div>
            <div style="display:flex; justify-content:space-between; gap:15px">
                <span>Vencedor:</span>
                <strong style="color:${color}">${winner}</strong>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:3px">
                <span>Votos:</span>
                <strong>${(val*100).toFixed(1)}%</strong>
            </div>
        `;
    }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
