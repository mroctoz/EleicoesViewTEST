<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas 2026 - Simulador Realista</title>
    
    <!-- Leaflet & Bibliotecas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0a0c10; --bg-card: rgba(20, 24, 32, 0.98);
            --accent-blue: #3b82f6; --text-primary: #ffffff; --text-muted: #94a3b8;
            --sim-highlight: #ff0055;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; height: 100vh; }
        
        #app { display: flex; width: 100vw; height: 100vh; }
        #map { flex: 1; background: #1a1a1a; z-index: 1; }

        .sidebar { width: 380px; background: var(--bg-card); display: flex; flex-direction: column; z-index: 1000; border-right: 1px solid rgba(255,255,255,0.1); box-shadow: 5px 0 30px rgba(0,0,0,0.5); overflow: hidden; }
        .sidebar-right { border-left: 1px solid rgba(255,255,255,0.1); border-right: none; width: 420px; }

        .header { padding: 20px; background: linear-gradient(180deg, #0a0c10 0%, rgba(10,12,16,0.9) 100%); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { font-size: 1.2rem; font-weight: 800; color: white; margin-bottom: 2px; }
        
        /* SIMULATOR STYLES */
        .sim-panel { background: rgba(255, 0, 85, 0.05); border-bottom: 1px solid var(--sim-highlight); padding: 15px; overflow-y: auto; flex: 1; }
        .sim-header { font-size: 0.75rem; color: var(--sim-highlight); font-weight: 800; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .sim-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .sim-label { flex: 1; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sim-slider { flex: 1; height: 4px; accent-color: var(--sim-highlight); cursor: pointer; }
        .sim-val { width: 42px; font-family: monospace; font-size: 0.9rem; text-align: right; color: var(--sim-highlight); }
        
        .sim-total { 
            margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; 
            display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700;
        }
        .sim-total.error { color: #ff3333; border: 1px solid #ff3333; }
        .sim-total.ok { color: #00ff88; border: 1px solid #00ff88; }

        .controls { padding: 15px; overflow-y: auto; flex: 1; }
        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 700; letter-spacing: 0.5px; }
        select { width: 100%; padding: 8px; background: #050505; color: white; border: 1px solid #333; border-radius: 6px; }

        .btn-action { width: 100%; padding: 10px; background: #222; color: white; border: 1px solid #444; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 5px; transition: 0.2s; }
        .btn-action:hover { background: #333; border-color: white; }
        .btn-action.active { background: var(--sim-highlight); border-color: var(--sim-highlight); }

        /* RESULTS LIST */
        .cand-row { display: flex; align-items: center; padding: 8px; margin-bottom: 4px; background: rgba(255,255,255,0.03); border-radius: 6px; }
        .cand-bar-bg { flex: 1; height: 6px; background: #333; margin: 0 10px; border-radius: 3px; overflow: hidden; }
        .cand-bar-fill { height: 100%; }

        #loader { position: absolute; inset: 0; background: #0a0c10; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.5s; }
        .hidden { opacity: 0; pointer-events: none; }
        
        /* Map Overrides */
        .legend { position: absolute; bottom: 20px; right: 440px; background: #000; padding: 10px; border-radius: 8px; border: 1px solid #333; z-index: 999; }
        .legend-grad { width: 200px; height: 10px; background: linear-gradient(to right, #eee 0%, #222 100%); margin-top: 5px; }
    </style>
</head>
<body>

<div id="loader">
    <h3 style="color:white; margin-bottom:10px;">Carregando Inteligência Eleitoral...</h3>
    <div style="width: 200px; height: 4px; background: #333; border-radius: 2px;"><div id="loadBar" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div></div>
</div>

<div id="app">
    <!-- ESQUERDA: CONTROLES -->
    <aside class="sidebar">
        <div class="header">
            <h1>Atlas Eleitoral</h1>
            <div style="font-size:0.8rem; color:#888;">Simulador de Cenários & Histórico</div>
        </div>

        <div style="padding: 15px 15px 0 15px;">
            <div class="control-group">
                <label>MODO</label>
                <select id="modeSelect" onchange="app.toggleMode()">
                    <option value="sim2026" selected>★ SIMULADOR 2026</option>
                    <option value="hist">HISTÓRICO (1994-2022)</option>
                </select>
            </div>
        </div>

        <!-- PAINEL SIMULADOR -->
        <div id="simPanel" class="sim-panel">
            <div class="sim-header">
                <span>INTENÇÃO DE VOTO (NACIONAL)</span>
                <button onclick="app.normalizeSliders()" style="background:transparent; border:none; color:#aaa; cursor:pointer; font-size:0.7rem; text-decoration:underline;">Normalizar (100%)</button>
            </div>
            
            <div id="slidersContainer"></div>

            <div class="sim-total" id="simTotalBox">
                <span>TOTAL</span>
                <span id="simTotalVal">100%</span>
            </div>

            <button id="btnSecondTurn" class="btn-action" onclick="app.toggleSecondTurn()">
                <i class="fas fa-random"></i> SIMULAR 2º TURNO
            </button>
            
            <div id="secondTurnControls" style="display:none; margin-top:10px; background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; border:1px solid #444;">
                <label style="font-size:0.7rem; font-weight:700; color:#aaa;">QUEM AVANÇA?</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <select id="stCand1" onchange="app.calcMap()"></select>
                    <select id="stCand2" onchange="app.calcMap()"></select>
                </div>
            </div>
        </div>

        <!-- PAINEL HISTORICO (Escondido no inicio) -->
        <div id="histPanel" class="controls" style="display:none;">
            <div class="control-group">
                <label>ANO</label>
                <select id="yearSelect">
                    <option value="2022">2022</option>
                    <option value="2018">2018</option>
                    <option value="2014">2014</option>
                    <option value="2010">2010</option>
                    <option value="2006">2006</option>
                    <option value="2002">2002</option>
                    <option value="1998">1998</option>
                    <option value="1994">1994</option>
                </select>
            </div>
            <div class="control-group">
                <label>CARGO</label>
                <select id="roleSelect">
                    <option value="president">Presidente</option>
                    <option value="governor">Governador</option>
                </select>
            </div>
            <button class="btn-action" onclick="app.loadHistoricalData()">Carregar Mapa Histórico</button>
        </div>
    </aside>

    <div id="map"></div>

    <!-- DIREITA: RESULTADOS -->
    <aside class="sidebar sidebar-right">
        <div class="header">
            <h2 id="regionName">Brasil</h2>
            <div style="font-size:0.8rem; color:#3b82f6;">Projeção do Cenário</div>
        </div>
        <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <button id="btnBack" class="btn-action" style="display:none; margin-bottom:10px;" onclick="app.resetSelection()">Voltar ao Nacional</button>
            <div style="font-size:0.7rem; color:#888; text-transform:uppercase;">Votos Totais (Est. 2022)</div>
            <div id="totalVotes" style="font-size:1.5rem; font-weight:800;">-</div>
        </div>
        <div id="resultsList" style="padding:15px; overflow-y:auto;"></div>
    </aside>

    <!-- LEGENDA -->
    <div class="legend">
        <div style="font-size:0.75rem; font-weight:700; color:#fff; margin-bottom:5px;">Percentual do Vencedor</div>
        <div style="display:flex; height:10px; border-radius:4px; overflow:hidden;">
            <div style="flex:1; background:#ffffff;"></div> <!-- 30% -->
            <div style="flex:1; background:#cccccc;"></div>
            <div style="flex:1; background:#999999;"></div>
            <div style="flex:1; background:#666666;"></div>
            <div style="flex:1; background:#333333;"></div>
            <div style="flex:1; background:#111111;"></div> <!-- 70%+ -->
        </div>
        <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:#aaa; margin-top:3px;">
            <span>~30% (Claro)</span><span>+70% (Escuro)</span>
        </div>
    </div>
</div>

<script>
// ==========================================
// CONFIGURAÇÃO DOS CANDIDATOS (CENÁRIO BASE)
// ==========================================
// homeBoost: Multiplicador de força no estado natal (ex: Ratinho x7 no PR)
const CANDIDATES = [
    { id: 'LULA', name: 'Lula da Silva', party: 'PT', color: '#E12525', default: 45.0, base: 'L', home: '26' },
    { id: 'FLAVIO', name: 'Flávio Bolsonaro', party: 'PL', color: '#0056A8', default: 30.0, base: 'R', home: '33' },
    { id: 'RATINHO', name: 'Ratinho Jr', party: 'PSD', color: '#FAA21B', default: 6.0, base: 'R', home: '41', homeBoost: 7.0 }, 
    { id: 'CAIADO', name: 'Ronaldo Caiado', party: 'UNIÃO', color: '#009EE3', default: 6.0, base: 'R', home: '52', homeBoost: 6.0 }, 
    { id: 'ZEMA', name: 'Romeu Zema', party: 'NOVO', color: '#F58220', default: 4.0, base: 'R', home: '31', homeBoost: 3.5 }, 
    { id: 'RENAN', name: 'Renan Santos', party: 'MISSÃO', color: '#333333', default: 5.0, base: 'C', home: '35', homeBoost: 1.5 }, 
    { id: 'CIRO', name: 'Ciro Gomes', party: 'PSDB', color: '#008000', default: 4.0, base: 'C', home: '23', homeBoost: 4.0 }
];

const app = {
    map: null,
    layers: { mun: null, states: null },
    data: { 
        base2022: null, 
        currentSim: null,
        geoJson: null
    },
    state: {
        mode: 'sim2026',
        secondTurn: false,
        selectedId: null,
        selectedName: "Brasil"
    },

    init: async () => {
        app.map = L.map('map', { center: [-15, -55], zoom: 4, zoomControl: false, preferCanvas: true, background: '#1a1a1a' });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.3 }).addTo(app.map);
        
        app.renderSliders();
        
        try {
            document.getElementById('loadBar').style.width = "30%";
            // Cache da malha municipal
            const geoRes = await fetch("https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json");
            app.data.geoJson = await geoRes.json();
            document.getElementById('loadBar').style.width = "60%";

            // Carrega a base gerada pelo Python (Na pasta data/)
            const baseRes = await fetch("data/2026_president.json"); 
            if(!baseRes.ok) throw new Error("Arquivo data/2026_president.json não encontrado");
            
            const json = await baseRes.json();
            app.data.base2022 = json["1"].base_inteligencia;
            document.getElementById('loadBar').style.width = "100%";
            
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
                app.calcMap(); 
            }, 500);

        } catch(e) {
            document.getElementById('loader').innerHTML = `<h3 style='color:red; text-align:center;'>Erro ao carregar dados.<br>${e.message}</h3><p style='color:#ccc; text-align:center;'>Verifique se rodou o script Python e se está usando um Local Server.</p>`;
            console.error(e);
        }
    },

    renderSliders: () => {
        const c = document.getElementById('slidersContainer');
        c.innerHTML = '';
        const s1 = document.getElementById('stCand1');
        const s2 = document.getElementById('stCand2');
        s1.innerHTML = ''; s2.innerHTML = '';

        CANDIDATES.forEach(cand => {
            const div = document.createElement('div');
            div.className = 'sim-row';
            div.innerHTML = `
                <div style="width:4px; height:24px; background:${cand.color}; border-radius:2px;"></div>
                <div class="sim-label">${cand.name}</div>
                <input type="range" class="sim-slider" id="sl_${cand.id}" 
                       min="0" max="100" step="0.5" value="${cand.default}" 
                       oninput="app.updateSlider('${cand.id}', this.value)">
                <div class="sim-val" id="val_${cand.id}">${cand.default}%</div>
            `;
            c.appendChild(div);

            s1.add(new Option(cand.name, cand.id));
            s2.add(new Option(cand.name, cand.id));
        });
        
        s1.value = 'LULA'; s2.value = 'FLAVIO';
        app.checkTotal();
    },

    updateSlider: (id, val) => {
        document.getElementById(`val_${id}`).textContent = parseFloat(val).toFixed(1) + '%';
        app.checkTotal();
        if(app.calcTimeout) clearTimeout(app.calcTimeout);
        app.calcTimeout = setTimeout(app.calcMap, 100); 
    },

    checkTotal: () => {
        let sum = 0;
        CANDIDATES.forEach(c => sum += parseFloat(document.getElementById(`sl_${c.id}`).value));
        const el = document.getElementById('simTotalBox');
        document.getElementById('simTotalVal').textContent = sum.toFixed(1) + '%';
        
        el.className = 'sim-total';
        if(sum > 100.1) el.classList.add('error');
        else if(sum > 99.0) el.classList.add('ok');
    },

    normalizeSliders: () => {
        let sum = 0;
        const vals = {};
        CANDIDATES.forEach(c => {
            let v = parseFloat(document.getElementById(`sl_${c.id}`).value);
            vals[c.id] = v;
            sum += v;
        });
        
        if(sum === 0) return;
        const factor = 100 / sum;
        
        CANDIDATES.forEach(c => {
            const newVal = vals[c.id] * factor;
            document.getElementById(`sl_${c.id}`).value = newVal;
            document.getElementById(`val_${c.id}`).textContent = newVal.toFixed(1) + '%';
        });
        app.checkTotal();
        app.calcMap();
    },

    toggleSecondTurn: () => {
        app.state.secondTurn = !app.state.secondTurn;
        const btn = document.getElementById('btnSecondTurn');
        const painel = document.getElementById('secondTurnControls');
        
        if(app.state.secondTurn) {
            btn.classList.add('active');
            painel.style.display = 'block';
        } else {
            btn.classList.remove('active');
            painel.style.display = 'none';
        }
        app.calcMap();
    },

    // --- CÁLCULO ELEITORAL (LÓGICA REALISTA BASEADA NO PERFIL 2022) ---
    calcMap: () => {
        const resultCache = {}; 
        const munData = app.data.base2022;
        
        // Targets Nacionais (Sliders)
        const targets = {};
        let sumTargets = 0;
        CANDIDATES.forEach(c => {
            targets[c.id] = parseFloat(document.getElementById(`sl_${c.id}`).value);
            sumTargets += targets[c.id];
        });
        
        // Normaliza targets para garantir matemática correta (base 100%)
        if(sumTargets > 0) Object.keys(targets).forEach(k => targets[k] = (targets[k]/sumTargets));

        // Define espectros e pesos nacionais (Quem divide qual bolo)
        const weights = { L: {}, R: {}, C: {} };
        const spectrumTotals = { L: 0, R: 0, C: 0 }; // Tamanho do bolo nacional desejado (ex: Direita = 50%)

        CANDIDATES.forEach(c => {
            weights[c.base][c.id] = targets[c.id]; 
            spectrumTotals[c.base] += targets[c.id];
        });

        // Loop nos Municípios
        for (const [id, prof] of Object.entries(munData)) {
            const cityVotes = {};
            const state = prof.UF;
            const totalVoters = prof.TOT; // Peso total do município

            // === FASE 1: Distribuição Intra-Espectro (Racha da Direita/Esquerda Local) ===
            // O perfil "R" (Bolso 22) local será dividido entre os candidatos R (Flávio, Caiado, etc)
            // baseado na força nacional deles + força local (Home Boost).
            
            const calcLocalWeights = (baseType) => {
                let localW = {}; 
                let sumW = 0;
                Object.keys(weights[baseType]).forEach(candId => {
                    const cand = CANDIDATES.find(x => x.id === candId);
                    let w = weights[baseType][candId]; // Peso Nacional
                    
                    if(cand.home === state && cand.homeBoost) w *= cand.homeBoost; // Boost Estadual
                    
                    localW[candId] = w;
                    sumW += w;
                });
                // Normaliza
                if(sumW > 0) Object.keys(localW).forEach(k => localW[k] /= sumW);
                return localW;
            };

            const localWeightsL = calcLocalWeights('L');
            const localWeightsR = calcLocalWeights('R');
            const localWeightsC = calcLocalWeights('C');

            // === FASE 2: Tamanho dos Bolos Locais (Swing) ===
            // Se a Esquerda nacional caiu (Target L < Real 2022 L), o bolo L local encolhe
            // e os votos vazam para o Centro (ou Direita).
            
            // Fator de Swing Nacional (Ex: Se Direita subiu de 43% pra 50%, fator = 1.16)
            // Usamos constantes aprox de 2022: L=48%, R=43%, C=9%
            const swingL = spectrumTotals.L / 0.48; 
            const swingR = spectrumTotals.R / 0.43;
            // Centro é "resíduo" elástico

            // Tamanho original dos potes no município (votos absolutos)
            let potL = prof.L * totalVoters;
            let potR = prof.R * totalVoters;
            let potC = prof.C * totalVoters;

            // Aplica Swing (Ajusta tamanho dos potes)
            let finalPotL = potL * swingL;
            let finalPotR = potR * swingR;
            
            // O que sobrar/faltar ajusta o Centro (ou normaliza tudo se estourar)
            // Se L+R > 100%, normaliza.
            let sumPot = finalPotL + finalPotR;
            if (sumPot > totalVoters) {
                const fix = totalVoters / sumPot;
                finalPotL *= fix;
                finalPotR *= fix;
                finalPotC = 0;
            } else {
                finalPotC = totalVoters - finalPotL - finalPotR;
            }

            // === FASE 3: Atribuição Final ===
            // Distribui os potes ajustados segundo os pesos locais calculados na Fase 1
            
            // Distribui Pote L
            Object.keys(localWeightsL).forEach(cid => cityVotes[cid] = (cityVotes[cid]||0) + (finalPotL * localWeightsL[cid]));
            
            // Distribui Pote R
            Object.keys(localWeightsR).forEach(cid => cityVotes[cid] = (cityVotes[cid]||0) + (finalPotR * localWeightsR[cid]));
            
            // Distribui Pote C
            Object.keys(localWeightsC).forEach(cid => cityVotes[cid] = (cityVotes[cid]||0) + (finalPotC * localWeightsC[cid]));

            // === SEGUNDO TURNO ===
            if(app.state.secondTurn) {
                const c1 = document.getElementById('stCand1').value;
                const c2 = document.getElementById('stCand2').value;
                let v1 = cityVotes[c1] || 0;
                let v2 = cityVotes[c2] || 0;

                // Transferência
                Object.keys(cityVotes).forEach(cid => {
                    if(cid !== c1 && cid !== c2) {
                        const votes = cityVotes[cid];
                        const cand = CANDIDATES.find(x => x.id === cid);
                        const cand1Obj = CANDIDATES.find(x => x.id === c1);
                        
                        // Afinidade Ideológica (90% se mesma base, 10% se oposta)
                        let p1 = 0.5;
                        if(cand.base === cand1Obj.base) p1 = 0.9;
                        else if(cand.base !== cand1Obj.base) p1 = 0.1;
                        // Centro pende pra quem? 50/50 neutro por enquanto
                        
                        v1 += votes * p1;
                        v2 += votes * (1-p1);
                    }
                });
                resultCache[id] = { [c1]: v1, [c2]: v2, TOTAL: v1+v2 };
            } else {
                cityVotes.TOTAL = Object.values(cityVotes).reduce((a,b)=>a+b,0);
                resultCache[id] = cityVotes;
            }
        }
        
        app.data.currentSim = resultCache;
        app.renderMap();
        app.updateSidePanel();
    },

    renderMap: () => {
        if(app.layers.mun) app.map.removeLayer(app.layers.mun);
        if(!app.data.currentSim) return;

        app.layers.mun = L.geoJSON(app.data.geoJson, {
            smoothFactor: 0.5,
            style: (feature) => {
                const id = feature.properties.id || feature.properties.codarea;
                const res = app.data.currentSim[id];
                
                if(!res || res.TOTAL === 0) return { fillColor: '#222', weight: 0, fillOpacity:1 };
                
                let winner = null, max = -1;
                Object.entries(res).forEach(([k, v]) => { if(k!=='TOTAL' && v>max) { max=v; winner=k; } });
                
                const pct = (max / res.TOTAL) * 100;
                const candObj = CANDIDATES.find(c => c.id === winner);
                const colorHex = candObj ? candObj.color : '#333';
                
                return {
                    fillColor: app.getGradientColor(colorHex, pct),
                    weight: app.state.selectedId == id ? 1.5 : 0.2,
                    color: app.state.selectedId == id ? '#fff' : '#000',
                    fillOpacity: 1
                };
            },
            onEachFeature: (f, l) => l.on('click', () => app.selectRegion(f.properties.id || f.properties.codarea, f.properties.name))
        }).addTo(app.map);
    },

    getGradientColor: (hex, pct) => {
        const c = app.hexToRgb(hex);
        // Lógica de "Mistura com Branco" conforme pedido anteriormente (Claro <-> Saturado)
        // <35% (Muito Claro), >65% (Saturado)
        let f = 0; 
        if (pct < 35) f = 0.6;
        else if (pct < 45) f = 0.4;
        else if (pct < 55) f = 0.2;
        else if (pct < 65) f = 0.1;
        else f = 0; // Pura
        
        const r = Math.round(c.r + (255 - c.r) * f);
        const g = Math.round(c.g + (255 - c.g) * f);
        const b = Math.round(c.b + (255 - c.b) * f);
        return `rgb(${r},${g},${b})`;
    },

    hexToRgb: (hex) => {
        const n = parseInt(hex.replace('#',''), 16);
        return { r: (n>>16)&255, g: (n>>8)&255, b: n&255 };
    },

    updateSidePanel: () => {
        const list = document.getElementById('resultsList');
        const regionName = document.getElementById('regionName');
        const totalEl = document.getElementById('totalVotes');
        list.innerHTML = '';
        
        const ids = app.state.selectedId ? [app.state.selectedId] : Object.keys(app.data.currentSim);
        regionName.textContent = app.state.selectedName;
        
        let agg = {}, total = 0;
        ids.forEach(id => {
            const d = app.data.currentSim[id];
            if(d) {
                Object.keys(d).forEach(k => { if(k!=='TOTAL') agg[k] = (agg[k]||0)+d[k]; });
                total += d.TOTAL;
            }
        });
        
        totalEl.textContent = total.toLocaleString('pt-BR');
        
        Object.entries(agg).sort((a,b)=>b[1]-a[1]).forEach(([cid, votes]) => {
            const pct = (votes/total)*100;
            const cObj = CANDIDATES.find(c=>c.id===cid);
            const row = document.createElement('div');
            row.className = 'cand-row';
            row.innerHTML = `
                <div style="width:4px; height:30px; background:${cObj.color}; margin-right:8px;"></div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; font-weight:700; font-size:0.9rem;">
                        <span>${cObj.name}</span><span style="color:${cObj.color}">${pct.toFixed(2)}%</span>
                    </div>
                    <div class="cand-bar-bg"><div class="cand-bar-fill" style="width:${pct}%; background:${cObj.color}"></div></div>
                </div>
            `;
            list.appendChild(row);
        });
    },

    selectRegion: (id, name) => {
        app.state.selectedId = id; app.state.selectedName = name;
        document.getElementById('btnBack').style.display = 'block';
        app.updateSidePanel();
        app.renderMap();
    },
    resetSelection: () => {
        app.state.selectedId = null; app.state.selectedName = "Brasil";
        document.getElementById('btnBack').style.display = 'none';
        app.updateSidePanel();
        app.renderMap();
    },

    // Modo Histórico (Placeholder simples redirecionando lógica)
    loadHistoricalData: async () => {
        alert("Modo histórico requer os JSONs antigos na pasta data/. O foco desta demo é o Simulador 2026.");
    },
    toggleMode: () => {
        const m = document.getElementById('modeSelect').value;
        document.getElementById('simPanel').style.display = m === 'sim2026' ? 'flex' : 'none';
        document.getElementById('histPanel').style.display = m === 'hist' ? 'block' : 'none';
    }
};

app.init();
</script>
</body>
</html>
