<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador 2026 - Otimizado</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* CSS OTIMIZADO PARA PERFORMANCE */
        :root { --bg: #050505; --panel: #111; --text: #eee; --pt: #c4122d; --pl: #002f6c; }
        body { margin:0; font-family:'Inter', sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; overflow:hidden; }
        
        #map { flex:1; background:#0a0a0a; z-index:1; }
        
        .sidebar { width:360px; background:var(--panel); border-right:1px solid #333; display:flex; flex-direction:column; z-index:1000; box-shadow:5px 0 20px #000; }
        .header { padding:20px; background:#000; border-bottom:1px solid #333; }
        .header h1 { margin:0; font-size:1.2rem; letter-spacing:1px; }
        
        .controls { padding:20px; flex:1; overflow-y:auto; }
        
        /* PLACAR */
        .scoreboard { display:flex; justify-content:space-between; margin-bottom:30px; background:#1a1a1a; padding:15px; border-radius:8px; border:1px solid #333; }
        .cand-score { text-align:center; }
        .big-pct { font-size:1.8rem; font-weight:800; display:block; }
        .cand-label { font-size:0.8rem; font-weight:600; color:#888; }
        
        /* SLIDER */
        input[type=range] { width:100%; cursor:pointer; margin:20px 0; }
        
        /* LEGENDA */
        .legend { position:absolute; bottom:20px; right:20px; background:#000; padding:10px; border:1px solid #333; border-radius:6px; z-index:999; width:200px; }
        .grad-bar { height:10px; width:100%; background:linear-gradient(90deg, #fff, var(--pt)); margin-top:5px; border-radius:2px; }
        .labels-leg { display:flex; justify-content:space-between; font-size:0.6rem; color:#888; }

        /* LOADER */
        #loader { position:absolute; inset:0; background:rgba(0,0,0,0.95); z-index:2000; display:flex; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="loader"><h2 id="loadText">CARREGANDO SIMULADOR...</h2></div>

<aside class="sidebar">
    <div class="header">
        <h1>Simulador 2026</h1>
        <div style="font-size:0.7rem; color:#666; margin-top:5px">Base: <span id="baseOrigin">...</span></div>
    </div>

    <div class="controls">
        <!-- PLACAR -->
        <div class="scoreboard">
            <div class="cand-score">
                <span class="cand-label" style="color:var(--pl)">DIREITA</span>
                <span class="big-pct" id="txtPl">49.1%</span>
            </div>
            <div class="cand-score">
                <span class="cand-label" style="color:var(--pt)">ESQUERDA</span>
                <span class="big-pct" id="txtPt">50.9%</span>
            </div>
        </div>

        <label style="font-size:0.8rem; color:#888; text-transform:uppercase;">Intenção de Voto Nacional (Esq)</label>
        <input type="range" id="simSlider" min="30" max="70" step="0.1">
        
        <div style="margin-top:20px; padding:15px; background:#1a1a1a; border-radius:6px; font-size:0.8rem;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>Cidades Esquerda:</span>
                <strong id="countPt" style="color:var(--pt)">0</strong>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span>Cidades Direita:</span>
                <strong id="countPl" style="color:var(--pl)">0</strong>
            </div>
        </div>
    </div>
</aside>

<div id="map"></div>

<div class="legend">
    <div style="font-size:0.7rem; font-weight:700; color:#fff; text-align:center">INTENSIDADE (VENCEDOR)</div>
    <div style="display:flex; gap:5px; margin-top:5px">
        <div style="flex:1">
            <div style="height:8px; background:linear-gradient(90deg, #fff, var(--pl));"></div>
            <div style="font-size:0.6rem; color:#888; text-align:center">Direita</div>
        </div>
        <div style="flex:1">
            <div style="height:8px; background:linear-gradient(90deg, #fff, var(--pt));"></div>
            <div style="font-size:0.6rem; color:#888; text-align:center">Esquerda</div>
        </div>
    </div>
</div>

<script>
const app = {
    map: null,
    geoLayer: null,
    data: null, // cenario_base_2026.json
    basePct: 0, // Ponto de partida (Ex: 0.509)

    init: async () => {
        app.map = L.map('map', {center: [-15, -50], zoom: 4, zoomControl: false, background:'#0a0a0a', preferCanvas: true});
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {opacity: 0.3}).addTo(app.map);
        
        document.getElementById('simSlider').addEventListener('input', (e) => app.simulate(parseFloat(e.target.value)));
        
        await app.loadFiles();
    },

    loadFiles: async () => {
        try {
            // 1. Carregar Malha
            document.getElementById('loadText').innerText = "BAIXANDO MAPA...";
            const geoRes = await fetch('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json');
            const geoJson = await geoRes.json();

            // 2. Carregar Dados Processados
            document.getElementById('loadText').innerText = "CALIBRANDO MODELO...";
            const dataRes = await fetch('cenario_base_2026.json');
            app.data = await dataRes.json();

            // Configurar Base
            app.basePct = app.data.meta.base_nacional;
            document.getElementById('baseOrigin').innerText = app.data.meta.origem;
            
            // Configurar Slider Inicial
            const startVal = (app.basePct * 100).toFixed(1);
            document.getElementById('simSlider').value = startVal;

            // Renderizar Mapa
            app.renderMap(geoJson);
            
            // Primeira Simulação
            app.simulate(parseFloat(startVal));
            
            document.getElementById('loader').classList.add('hidden');

        } catch (e) {
            alert("Erro: Gere o arquivo 'cenario_base_2026.json' com o script Python primeiro!");
            console.error(e);
        }
    },

    renderMap: (geoJson) => {
        app.geoLayer = L.geoJSON(geoJson, {
            style: { fillColor: '#333', weight: 0.5, color: '#000', fillOpacity: 1 }, // Estilo base
            onEachFeature: (f, l) => {
                // Tenta achar ID (codarea ou id)
                const id = (f.properties.id || f.properties.codarea).toString();
                f.ibge = id; // Salva para acesso rápido
                
                l.bindTooltip(() => app.getTooltip(f.ibge), {sticky: true, direction: 'top'});
            }
        }).addTo(app.map);
    },

    simulate: (targetPtPct) => {
        // Swing = Diferença entre o cenário desejado e a base de 2022
        const swing = (targetPtPct / 100) - app.basePct;
        
        // Atualiza textos
        document.getElementById('txtPt').innerText = targetPtPct.toFixed(1) + '%';
        document.getElementById('txtPl').innerText = (100 - targetPtPct).toFixed(1) + '%';

        let cPt = 0, cPl = 0;

        // Loop otimizado sobre as camadas do mapa
        app.geoLayer.eachLayer(layer => {
            const id = layer.feature.ibge;
            const cityData = app.data.dados[id]; // [pct_esq_2022, total_votos]

            if (cityData) {
                const baseCityPct = cityData[0];
                
                // Aplica Swing Uniforme
                let newPct = baseCityPct + swing;
                // Limita entre 0 e 1
                newPct = newPct > 1 ? 1 : (newPct < 0 ? 0 : newPct);
                
                // Salva estado simulado na feature para o tooltip
                layer.feature.simPct = newPct;

                // Contagem
                if (newPct > 0.5) cPt++; else cPl++;

                // Define Cor
                layer.setStyle({
                    fillColor: app.getColor(newPct),
                    fillOpacity: 1,
                    weight: 0.5,
                    color: '#000' // Contorno preto solicitado
                });
            }
        });

        document.getElementById('countPt').innerText = cPt.toLocaleString();
        document.getElementById('countPl').innerText = cPl.toLocaleString();
    },

    // Lógica de Cor: Branco (0.5) -> Cor Pura (1.0 ou 0.0)
    getColor: (pct) => {
        if (pct > 0.5) {
            // ESQUERDA (0.5 a 1.0) -> Branco a Vermelho
            // Normaliza 0.5-1.0 para 0-1
            const intensity = (pct - 0.5) * 2;
            return app.mixWhite('#c4122d', intensity); // Vermelho
        } else {
            // DIREITA (0.5 a 0.0) -> Branco a Azul
            const intensity = (0.5 - pct) * 2;
            return app.mixWhite('#002f6c', intensity); // Azul
        }
    },

    // Mistura Branco com Cor baseada na intensidade (0=Branco, 1=Cor)
    mixWhite: (hex, intensity) => {
        // Converte hex para int
        const n = parseInt(hex.replace('#',''), 16);
        const r = (n >> 16) & 255;
        const g = (n >> 8) & 255;
        const b = n & 255;

        // Mistura: 255 (Branco) -> r (Cor)
        // Se intensity 1: usa r. Se intensity 0: usa 255.
        const nr = Math.round(255 + (r - 255) * intensity);
        const ng = Math.round(255 + (g - 255) * intensity);
        const nb = Math.round(255 + (b - 255) * intensity);

        return `rgb(${nr},${ng},${nb})`;
    },

    getTooltip: (id) => {
        const name = app.data.nomes[id] || id;
        const simPct = app.geoLayer.getLayers().find(l => l.feature.ibge == id)?.feature?.simPct;
        
        if (simPct === undefined) return name;

        const winner = simPct > 0.5 ? "ESQUERDA" : "DIREITA";
        const color = simPct > 0.5 ? "var(--pt)" : "var(--pl)";
        const val = simPct > 0.5 ? simPct : (1 - simPct);

        return `<div style="background:#000; color:#fff; padding:5px; border:1px solid #444; border-radius:4px;">
            <strong>${name}</strong><br>
            Vence: <span style="color:${color}; font-weight:800">${winner}</span><br>
            Votos: ${(val*100).toFixed(1)}%
        </div>`;
    }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
