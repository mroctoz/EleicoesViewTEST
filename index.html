<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Eleitoral 2026 - Advanced</title>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Color Picker -->
    <link href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <style>
        :root {
            --bg-primary: #0a0c10;
            --bg-card: rgba(20, 24, 32, 0.98);
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --text-primary: #ffffff;
            --text-muted: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --gradient-primary: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0c10; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        #app { width: 100vw; height: 100vh; display: flex; position: relative; }
        #map { flex: 1; height: 100%; background: #1a1a1a; z-index: 1; }

        /* SIDEBARS */
        .sidebar {
            width: 400px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            display: flex; flex-direction: column;
            z-index: 1000;
            border-right: 1px solid var(--border-color);
            box-shadow: 5px 0 30px rgba(0,0,0,0.5);
        }
        .sidebar-right { border-left: 1px solid var(--border-color); border-right: none; width: 420px; }

        .header {
            padding: 20px;
            background: linear-gradient(180deg, rgba(10, 12, 16, 1) 0%, rgba(10, 12, 16, 0.9) 100%);
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 {
            font-size: 1.2rem; font-weight: 800; margin: 0; letter-spacing: -0.5px;
            background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* TABS */
        .mode-tabs { display: flex; gap: 8px; margin-top: 15px; }
        .mode-tab {
            flex: 1; padding: 8px; text-align: center; border-radius: 6px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            cursor: pointer; font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
            transition: all 0.2s; text-transform: uppercase;
        }
        .mode-tab:hover { background: rgba(255,255,255,0.1); color: white; }
        .mode-tab.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }

        .controls { padding: 20px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* SECTIONS & ACCORDIONS */
        .section-title {
            font-size: 0.7rem; color: var(--text-muted); font-weight: 800; 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 8px;
        }
        .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }

        .accordion {
            border: 1px solid var(--border-color); border-radius: 8px;
            background: rgba(255,255,255,0.02); overflow: hidden; margin-bottom: 10px;
        }
        .accordion-header {
            padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.03);
            transition: background 0.2s;
        }
        .accordion-header:hover { background: rgba(255,255,255,0.06); }
        .accordion-body { padding: 15px; display: none; background: #0e1116; border-top: 1px solid var(--border-color); }
        .accordion.open .accordion-body { display: block; }
        .accordion.open .accordion-header { color: var(--accent-blue); }

        /* INPUTS & SELECTS */
        select, input[type=number] {
            width: 100%; padding: 10px; border-radius: 6px;
            border: 1px solid #333; background-color: #050505; color: white;
            font-family: inherit; font-size: 0.85rem; appearance: none;
        }
        select:focus, input:focus { border-color: var(--accent-blue); }

        /* SLIDERS */
        .slider-row { margin-bottom: 12px; }
        .slider-head { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; }
        input[type=range] { 
            width: 100%; -webkit-appearance: none; background: transparent; height: 4px; border-radius: 2px;
            background: #333; margin-top: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; 
            background: #fff; border-radius: 50%; cursor: pointer; margin-top: -5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* BUTTONS */
        button.btn-primary { 
            width: 100%; padding: 14px; border-radius: 8px;
            background: var(--gradient-primary); border: none; 
            font-weight: 700; color: white; cursor: pointer; 
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;
            transition: transform 0.2s, filter 0.2s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        button.btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button.btn-primary:active { transform: translateY(0); }

        /* LISTA RESULTADOS */
        .cand-row {
            display: flex; align-items: center; gap: 10px; padding: 10px; margin-bottom: 6px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 6px;
        }
        .cand-color { width: 12px; height: 12px; border-radius: 50%; }
        .cand-info { flex: 1; }
        .cand-head { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .progress-fill { height: 100%; }

        /* LEGENDA & MAPA CONTROLS */
        .legend {
            position: absolute; bottom: 30px; right: 450px;
            background: #0a0c10; padding: 15px; border: 1px solid #333;
            border-radius: 12px; z-index: 999;
        }
        .legend-grid { display: flex; height: 12px; width: 200px; border-radius: 3px; overflow: hidden; }
        .legend-item { flex: 1; }
        
        .map-controls { position: absolute; top: 20px; right: 450px; display: flex; flex-direction: column; gap: 5px; z-index: 999; }
        .map-btn { width: 36px; height: 36px; background: #0a0c10; border: 1px solid #333; color: #ddd; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; }
        .map-btn:hover { background: #222; color: white; }

        /* LOADER */
        #loader {
            position: absolute; inset: 0; background: rgba(5,5,5,0.95); z-index: 9999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #333; border-top-color: var(--accent-blue);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Tooltip Customizada */
        .custom-tooltip {
            background: #111; border: 1px solid #444; color: white;
            font-family: 'Inter', sans-serif; padding: 0; border-radius: 6px;
        }
        .tt-head { background: #222; padding: 8px 10px; font-weight: 700; font-size: 0.8rem; border-bottom: 1px solid #444; border-radius: 5px 5px 0 0; }
        .tt-body { padding: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h3 id="loaderMsg">Inicializando Simulador...</h3>
</div>

<div id="app">
    <!-- BARRA ESQUERDA: CONFIGURAÇÃO -->
    <aside class="sidebar">
        <div class="header">
            <h1>Simulador 2026 <span style="font-weight:300; font-size:0.8em; opacity:0.6">Pro</span></h1>
            <div class="mode-tabs">
                <div class="mode-tab active" id="tabTurn1" onclick="app.setTurn(1)">1º Turno</div>
                <div class="mode-tab" id="tabTurn2" onclick="app.setTurn(2)">2º Turno</div>
            </div>
        </div>

        <!-- CONTROLES 1º TURNO -->
        <div class="controls" id="controlsT1">
            
            <!-- 1. INTENÇÃO DE VOTO (NACIONAL) -->
            <div>
                <div class="section-title">Pesquisa Nacional (Base)</div>
                <div id="slidersT1"></div>
                <div style="text-align:center; font-size:0.8rem; margin-top:5px; color:#4ade80; font-weight:700" id="totalT1">100%</div>
            </div>

            <!-- 2. MATRIZ DE HERANÇA (2022 -> 2026) -->
            <div class="accordion">
                <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                    <span>Matriz de Herança (2022)</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div style="font-size:0.75rem; color:#888; margin-bottom:10px;">
                        Defina a % de votos de 2022 que migram para os candidatos de 2026.
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:0.7rem; font-weight:700;">Origem: LULA (2022)</label>
                        <select id="matrixSrcLula" onchange="app.renderMatrixSliders('LULA')"></select>
                    </div>
                    <!-- Sliders dinâmicos da matriz -->
                    <div id="matrixSlidersContainer"></div>
                </div>
            </div>

            <!-- 3. AJUSTES ESTADUAIS -->
            <div class="accordion">
                <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                    <span>Multiplicadores Estaduais</span>
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="accordion-body">
                    <select id="stateSelectT1" onchange="app.renderStateMultipliers(1)" style="margin-bottom:15px;">
                        <option value="">Selecione um Estado...</option>
                        <!-- Options via JS -->
                    </select>
                    <div id="stateMultipliersT1"></div>
                </div>
            </div>

            <button class="btn-primary" onclick="app.runSimulation()">
                <i class="fas fa-calculator"></i> Simular 1º Turno
            </button>
        </div>

        <!-- CONTROLES 2º TURNO -->
        <div class="controls" id="controlsT2" style="display:none;">
            
            <div style="padding:10px; background:rgba(255,200,0,0.1); border:1px solid rgba(255,200,0,0.3); border-radius:6px; font-size:0.8rem; color:#ffd700;">
                <i class="fas fa-info-circle"></i> O 2º Turno usa os resultados calculados do 1º Turno como base.
            </div>

            <!-- SELEÇÃO DE CANDIDATOS -->
            <div>
                <div class="section-title">Finalistas</div>
                <div style="display:flex; gap:10px;">
                    <select id="candFinal1" onchange="app.initTurn2Defaults()"></select>
                    <div style="padding:10px; font-weight:800;">VS</div>
                    <select id="candFinal2" onchange="app.initTurn2Defaults()"></select>
                </div>
            </div>

            <!-- MIGRAÇÃO DE VOTOS -->
            <div class="accordion open">
                <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                    <span>Migração de Votos (T1 -> T2)</span>
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="accordion-body" id="migrationContainer">
                    <!-- Sliders dinâmicos de migração -->
                </div>
            </div>

            <!-- AJUSTES ESTADUAIS T2 -->
            <div class="accordion">
                <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                    <span>Multiplicadores Estaduais (T2)</span>
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="accordion-body">
                    <select id="stateSelectT2" onchange="app.renderStateMultipliers(2)" style="margin-bottom:15px;">
                        <option value="">Selecione um Estado...</option>
                    </select>
                    <div id="stateMultipliersT2"></div>
                </div>
            </div>

            <button class="btn-primary" onclick="app.runSimulation()">
                <i class="fas fa-calculator"></i> Simular 2º Turno
            </button>
        </div>
    </aside>

    <div id="map"></div>

    <!-- BARRA DIREITA: RESULTADOS -->
    <aside class="sidebar sidebar-right">
        <div class="header">
            <h2 id="regionName">Brasil</h2>
            <div style="font-size: 0.8rem; color: var(--accent-blue);" id="regionType">Nacional</div>
        </div>

        <div style="padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color);">
            <button id="btnBack" style="width:100%; padding:8px; background:#222; color:white; border:1px solid #444; border-radius:6px; margin-bottom:10px; cursor:pointer; display:none;" onclick="app.resetSelection()">
                <i class="fas fa-arrow-left"></i> Voltar ao Brasil
            </button>
            <div style="font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700;">Votos Válidos</div>
            <div id="totalVotesVal" style="font-size: 1.4rem; font-weight: 800; color: white;">-</div>
        </div>

        <div class="controls" id="resultsContainer"></div>
    </aside>

    <div class="map-controls">
        <div class="map-btn" onclick="app.map.zoomIn()">+</div>
        <div class="map-btn" onclick="app.map.zoomOut()">-</div>
    </div>

    <div class="legend">
        <div style="font-size: 0.75rem; margin-bottom: 6px; font-weight: 700; color: white;">Intensidade da Vitória</div>
        <div class="legend-grid" id="legendColors"></div>
        <div style="display:flex; justify-content:space-between; font-size:0.65rem; color:#aaa; margin-top:4px;">
            <span>Equilibrado</span><span>Esmagador</span>
        </div>
    </div>
</div>

<script>
// =============================================================================
// DADOS BASE & CONFIGURAÇÃO
// =============================================================================

// Lista de Estados para dropdown
const STATES = [
    {sigla:'AC', nome:'Acre', id:'12'}, {sigla:'AL', nome:'Alagoas', id:'27'},
    {sigla:'AP', nome:'Amapá', id:'16'}, {sigla:'AM', nome:'Amazonas', id:'13'},
    {sigla:'BA', nome:'Bahia', id:'29'}, {sigla:'CE', nome:'Ceará', id:'23'},
    {sigla:'DF', nome:'Distrito Federal', id:'53'}, {sigla:'ES', nome:'Espírito Santo', id:'32'},
    {sigla:'GO', nome:'Goiás', id:'52'}, {sigla:'MA', nome:'Maranhão', id:'21'},
    {sigla:'MT', nome:'Mato Grosso', id:'51'}, {sigla:'MS', nome:'Mato Grosso do Sul', id:'50'},
    {sigla:'MG', nome:'Minas Gerais', id:'31'}, {sigla:'PA', nome:'Pará', id:'15'},
    {sigla:'PB', nome:'Paraíba', id:'25'}, {sigla:'PR', nome:'Paraná', id:'41'},
    {sigla:'PE', nome:'Pernambuco', id:'26'}, {sigla:'PI', nome:'Piauí', id:'22'},
    {sigla:'RJ', nome:'Rio de Janeiro', id:'33'}, {sigla:'RN', nome:'Rio Grande do Norte', id:'24'},
    {sigla:'RS', nome:'Rio Grande do Sul', id:'43'}, {sigla:'RO', nome:'Rondônia', id:'11'},
    {sigla:'RR', nome:'Roraima', id:'14'}, {sigla:'SC', nome:'Santa Catarina', id:'42'},
    {sigla:'SP', nome:'São Paulo', id:'35'}, {sigla:'SE', nome:'Sergipe', id:'28'},
    {sigla:'TO', nome:'Tocantins', id:'17'}
];

// Candidatos 2026 (Configuráveis)
const CANDIDATES_2026 = [
    { id: 'LULA',    name: 'Lula',             party: 'PT',     color: '#E12525', defaultPct: 35 },
    { id: 'TARCISIO',name: 'Tarcísio',         party: 'REP',    color: '#0066CC', defaultPct: 25 },
    { id: 'CAIADO',  name: 'Ronaldo Caiado',   party: 'UNIÃO',  color: '#009EE3', defaultPct: 8 },
    { id: 'ZEMA',    name: 'Romeu Zema',       party: 'NOVO',   color: '#F58220', defaultPct: 7 },
    { id: 'RATINHO', name: 'Ratinho Jr',       party: 'PSD',    color: '#FAA21B', defaultPct: 5 },
    { id: 'CIRO',    name: 'Ciro Gomes',       party: 'PDT',    color: '#d6006e', defaultPct: 4 },
    { id: 'GENTILI', name: 'Danilo Gentili',   party: 'MISSÃO', color: '#D4AF37', defaultPct: 3 }
];
// Adiciona "Outros" automaticamente na lógica, mas não na lista editável principal.

// Origens 2022 (para matriz)
const SOURCES_2022 = ['LULA', 'JAIR', 'CIRO', 'TEBET', 'OUTROS'];

const GRADIENT_SCHEME = [
    { min: 0,  ratio: 0.9 }, { min: 55, ratio: 0.7 },
    { min: 60, ratio: 0.5 }, { min: 70, ratio: 0.3 },
    { min: 80, ratio: 0.1 }
];

const app = {
    map: null,
    layers: { brazil: null, cities: null },
    data: { 
        base2022: null,  // Dados brutos de 2022
        round1: null,    // Resultado calculado T1
        round2: null,    // Resultado calculado T2
        geoJson: null    // Cache do GeoJSON
    },
    
    // ESTADO GLOBAL DA SIMULAÇÃO
    state: {
        turn: 1, // 1 ou 2
        view: 'states', // 'states' ou 'cities'
        selectedRegion: null, // { id, name }
        
        // Configurações T1
        t1_polls: {}, // { CAND_ID: 30 }
        t1_matrix: {}, // { LULA_22: { LULA_26: 0.9, TARCISIO: 0.05 ... } }
        t1_stateMults: {}, // { SP: { LULA: 1.1 } }

        // Configurações T2
        t2_finalists: [], // [ID1, ID2]
        t2_migration: {}, // { DERROTADO_ID: { FINALISTA_A: 0.6 } } (o resto vai pro B)
        t2_stateMults: {}, // { SP: { LULA: 1.1 } }
    },

    init: async () => {
        // Inicializa Mapa
        app.map = L.map('map', {
            center: [-15, -50], zoom: 4, zoomControl: false,
            preferCanvas: true, background: '#1a1a1a'
        });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.3 }).addTo(app.map);

        // Inicializa Estado Inicial
        CANDIDATES_2026.forEach(c => app.state.t1_polls[c.id] = c.defaultPct);
        
        // Matriz Padrão 2022->2026 (Simplificada para demo)
        SOURCES_2022.forEach(src => {
            app.state.t1_matrix[src] = {};
            CANDIDATES_2026.forEach(dest => {
                // Lógica padrão básica de afinidade ideológica
                let val = 0;
                if(src === 'LULA' && dest.id === 'LULA') val = 0.85;
                if(src === 'LULA' && dest.id === 'CIRO') val = 0.05;
                if(src === 'JAIR' && dest.id === 'TARCISIO') val = 0.60;
                if(src === 'JAIR' && dest.id === 'CAIADO') val = 0.15;
                if(src === 'JAIR' && dest.id === 'ZEMA') val = 0.10;
                app.state.t1_matrix[src][dest.id] = val;
            });
        });

        // Configurações de T2 Padrão
        app.state.t2_finalists = [CANDIDATES_2026[0].id, CANDIDATES_2026[1].id]; // Lula vs Tarcisio

        // Renderiza UI
        app.renderLegend();
        app.renderT1Controls();
        app.renderStateSelects();

        // Carrega Dados 2022
        await app.loadBaseData();
        
        // Carrega Mapa Base
        await app.loadBrazilLayer();

        // Primeira Simulação
        app.runSimulation();
    },

    // =========================================================================
    // CARREGAMENTO DE DADOS
    // =========================================================================
    loadBaseData: async () => {
        try {
            // Tenta carregar o JSON real. Se falhar em ambiente local sem server, avisa.
            const res = await fetch('data/2022_president.json'); 
            if(!res.ok) throw new Error("Arquivo base não encontrado");
            const json = await res.json();
            app.data.base2022 = json['1']; // Pega dados do 1º turno de 2022 como base geográfica
            document.getElementById('loader').classList.add('hidden');
        } catch(e) {
            console.error(e);
            alert("Erro ao carregar dados de 2022. Certifique-se que data/2022_president.json existe.");
        }
    },

    loadBrazilLayer: async () => {
        const res = await fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson');
        const data = await res.json();
        // Mapeia Sigla para ID IBGE
        data.features.forEach(f => {
            const st = STATES.find(s => s.sigla === f.properties.sigla);
            if(st) f.properties.id = st.id;
        });

        app.layers.brazil = L.geoJSON(data, {
            style: app.getStyle,
            onEachFeature: (f, l) => {
                l.on('click', () => app.enterStateMode(f.properties.id, f.properties.name));
                app.bindTooltip(l, f.properties.name);
            }
        }).addTo(app.map);
    },

    // =========================================================================
    // LÓGICA DE SIMULAÇÃO (CORE)
    // =========================================================================
    runSimulation: () => {
        if(!app.data.base2022) return;
        const btn = document.querySelector(app.state.turn === 1 ? '#controlsT1 .btn-primary' : '#controlsT2 .btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
        
        setTimeout(() => {
            if (app.state.turn === 1) {
                app.calculateRound1();
            } else {
                if(!app.data.round1) app.calculateRound1(); // Garante base
                app.calculateRound2();
            }
            
            // Atualiza Mapa e Sidebar
            if(app.layers.brazil) app.layers.brazil.setStyle(app.getStyle);
            if(app.layers.cities) app.layers.cities.setStyle(app.getStyle);
            app.updateSidebarRight();
            
            btn.innerHTML = originalText;
        }, 50);
    },

    calculateRound1: () => {
        const results = { municipios: {}, estados: {}, nacional: {} };
        const base = app.data.base2022.municipios;
        
        // 1. Calcula totais nacionais desejados (Input do usuário)
        const totalPollPct = Object.values(app.state.t1_polls).reduce((a,b)=>a+b,0);
        const targetPcts = {};
        CANDIDATES_2026.forEach(c => {
            targetPcts[c.id] = app.state.t1_polls[c.id] / (totalPollPct || 1); // Normaliza para % real
        });

        // 2. Processa cada município
        for (let ibge in base) {
            const votes22 = base[ibge];
            const uf = ibge.substring(0, 2);
            let munVotes = {};
            let munTotal = 0;

            // A. Aplica Matriz de Herança
            CANDIDATES_2026.forEach(cand => {
                let votes = 0;
                SOURCES_2022.forEach(src => {
                    const srcVotes = app.getVotes22(votes22, src);
                    const ratio = app.state.t1_matrix[src][cand.id] || 0;
                    votes += srcVotes * ratio;
                });
                munVotes[cand.id] = votes;
            });

            // B. Aplica Multiplicador Estadual
            if (app.state.t1_stateMults[uf]) {
                for (let cid in munVotes) {
                    const mult = app.state.t1_stateMults[uf][cid];
                    if (mult) munVotes[cid] *= mult;
                }
            }

            // C. Acumula Totais Preliminares para Normalização Nacional
            // (Simplificação: Na versão Advanced, normalizamos por município primeiro para manter geografia, 
            // depois aplicamos um fator de correção nacional se quisermos forçar a pesquisa exata. 
            // Aqui, vamos confiar na geografia gerada pela matriz + mults, e só ajustar levemente).
            
            // Simples normalização local para garantir números inteiros
            for (let cid in munVotes) munTotal += munVotes[cid];
            
            // Salva
            results.municipios[ibge] = munVotes;
            
            // Agrega Estados
            if(!results.estados[uf]) results.estados[uf] = {};
            for(let cid in munVotes) results.estados[uf][cid] = (results.estados[uf][cid]||0) + munVotes[cid];
        }

        // D. (Opcional) Ajuste Fino Nacional ("Swing") para bater com a Pesquisa
        // Calculamos o total nacional atual gerado
        let currentNational = {};
        let grandTotal = 0;
        Object.values(results.estados).forEach(st => {
            for(let cid in st) {
                currentNational[cid] = (currentNational[cid]||0) + st[cid];
                grandTotal += st[cid];
            }
        });

        // Calcula fator de correção para cada candidato bater a meta da pesquisa
        const correctionFactors = {};
        CANDIDATES_2026.forEach(c => {
            const currentPct = currentNational[c.id] / grandTotal;
            const target = targetPcts[c.id];
            // Se o candidato tem 0 votos ou meta 0, fator 1
            correctionFactors[c.id] = (currentPct > 0 && target > 0) ? (target / currentPct) : 1;
        });

        // Reaplica correção
        results.nacional = {};
        for (let ibge in results.municipios) {
            let mTotal = 0;
            for(let cid in results.municipios[ibge]) {
                results.municipios[ibge][cid] *= correctionFactors[cid];
                mTotal += results.municipios[ibge][cid];
            }
            // Recalcula estaduais e nacionais finais limpos
        }
        
        // Re-agregação final limpa
        const finalEstados = {};
        for (let ibge in results.municipios) {
            const uf = ibge.substring(0,2);
            if(!finalEstados[uf]) finalEstados[uf] = {};
            for(let cid in results.municipios[ibge]) {
                const v = Math.round(results.municipios[ibge][cid]);
                results.municipios[ibge][cid] = v; // Arredonda
                finalEstados[uf][cid] = (finalEstados[uf][cid]||0) + v;
                results.nacional[cid] = (results.nacional[cid]||0) + v;
            }
        }
        results.estados = finalEstados;

        app.data.round1 = results;
    },

    calculateRound2: () => {
        const r1 = app.data.round1;
        if(!r1) return;

        const results = { municipios: {}, estados: {}, nacional: {} };
        const [idA, idB] = app.state.t2_finalists;
        
        for (let ibge in r1.municipios) {
            const votes1 = r1.municipios[ibge];
            const uf = ibge.substring(0, 2);
            
            let votesA = 0;
            let votesB = 0;

            // Para cada candidato do T1, decide pra onde vai no T2
            for (let cid in votes1) {
                const v = votes1[cid];
                if (cid === idA) { votesA += v; continue; }
                if (cid === idB) { votesB += v; continue; }

                // É um derrotado. Verifica migração.
                // Ex: Se migration[CID] = 0.6, significa 60% pro idA.
                let ratioA = 0.5; // Neutro
                if (app.state.t2_migration[cid] !== undefined) {
                    ratioA = app.state.t2_migration[cid];
                }
                
                votesA += v * ratioA;
                votesB += v * (1 - ratioA);
            }

            // Aplica Multiplicadores Estaduais T2
            if (app.state.t2_stateMults[uf]) {
                if (app.state.t2_stateMults[uf][idA]) votesA *= app.state.t2_stateMults[uf][idA];
                if (app.state.t2_stateMults[uf][idB]) votesB *= app.state.t2_stateMults[uf][idB];
            }

            // Salva (arredondado)
            votesA = Math.round(votesA);
            votesB = Math.round(votesB);

            results.municipios[ibge] = { [idA]: votesA, [idB]: votesB };

            // Agrega
            if(!results.estados[uf]) results.estados[uf] = {};
            results.estados[uf][idA] = (results.estados[uf][idA]||0) + votesA;
            results.estados[uf][idB] = (results.estados[uf][idB]||0) + votesB;
            
            results.nacional[idA] = (results.nacional[idA]||0) + votesA;
            results.nacional[idB] = (results.nacional[idB]||0) + votesB;
        }

        app.data.round2 = results;
    },

    getVotes22: (obj, key) => {
        // Helper para mapear as chaves do JSON 2022 para nosso array SOURCES
        // O JSON original tem chaves como "LULA", "JAIR", "CIRO".
        if(key === 'OUTROS') {
            // Soma tudo que não é os principais
            let tot = 0;
            for(let k in obj) {
                if(!['LULA','JAIR','CIRO','SIMONE'].some(x => k.includes(x))) tot += obj[k];
            }
            return tot;
        }
        // Procura chave parcial
        for(let k in obj) {
            if(k.toUpperCase().includes(key === 'TEBET' ? 'SIMONE' : key)) return obj[k];
        }
        return 0;
    },

    // =========================================================================
    // UI & INTERACTION
    // =========================================================================
    setTurn: (t) => {
        app.state.turn = t;
        document.getElementById('tabTurn1').className = `mode-tab ${t===1?'active':''}`;
        document.getElementById('tabTurn2').className = `mode-tab ${t===2?'active':''}`;
        document.getElementById('controlsT1').style.display = t===1?'flex':'none';
        document.getElementById('controlsT2').style.display = t===2?'flex':'none';
        
        if (t === 2 && !app.data.round1) app.runSimulation(); // Se for pro T2 sem rodar T1, roda tudo
        else app.runSimulation(); // Apenas re-renderiza/calcula
    },

    renderT1Controls: () => {
        // Sliders Pesquisa Nacional
        const c = document.getElementById('slidersT1');
        c.innerHTML = '';
        CANDIDATES_2026.forEach(cand => {
            const div = document.createElement('div');
            div.className = 'slider-row';
            div.innerHTML = `
                <div class="slider-head">
                    <span style="color:${cand.color}; font-weight:700">${cand.name}</span>
                    <span id="val_t1_${cand.id}">${cand.defaultPct}%</span>
                </div>
                <input type="range" min="0" max="100" value="${cand.defaultPct}" 
                       oninput="app.updateT1Poll('${cand.id}', this.value)">
            `;
            c.appendChild(div);
        });
        
        // Matrix Dropdown
        const sel = document.getElementById('matrixSrcLula');
        sel.innerHTML = '';
        SOURCES_2022.forEach(src => {
            const opt = document.createElement('option');
            opt.value = src;
            opt.text = src === 'JAIR' ? 'BOLSONARO (2022)' : `${src} (2022)`;
            sel.appendChild(opt);
        });
        app.renderMatrixSliders(SOURCES_2022[0]);
    },

    updateT1Poll: (id, val) => {
        app.state.t1_polls[id] = parseInt(val);
        document.getElementById(`val_t1_${id}`).innerText = val + '%';
        const total = Object.values(app.state.t1_polls).reduce((a,b)=>a+b,0);
        const el = document.getElementById('totalT1');
        el.innerText = total + '%';
        el.style.color = total === 100 ? '#4ade80' : '#facc15';
    },

    renderMatrixSliders: (src) => {
        const c = document.getElementById('matrixSlidersContainer');
        c.innerHTML = '';
        const title = document.createElement('div');
        title.style = "font-size:0.75rem; color:#aaa; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:4px;";
        title.innerText = `Destino dos votos de ${src}:`;
        c.appendChild(title);

        CANDIDATES_2026.forEach(dest => {
            const currentRatio = app.state.t1_matrix[src][dest.id] || 0;
            const pct = Math.round(currentRatio * 100);
            
            const row = document.createElement('div');
            row.className = 'slider-row';
            row.innerHTML = `
                <div class="slider-head">
                    <span style="color:${dest.color}">${dest.name}</span>
                    <span id="mtx_${src}_${dest.id}">${pct}%</span>
                </div>
                <input type="range" min="0" max="100" value="${pct}" 
                       oninput="app.updateMatrix('${src}', '${dest.id}', this.value)">
            `;
            c.appendChild(row);
        });
    },

    updateMatrix: (src, destId, val) => {
        app.state.t1_matrix[src][destId] = parseInt(val) / 100;
        document.getElementById(`mtx_${src}_${destId}`).innerText = val + '%';
    },

    renderStateSelects: () => {
        const opts = '<option value="">Selecione um Estado...</option>' + 
                     STATES.map(s => `<option value="${s.sigla}">${s.nome}</option>`).join('');
        document.getElementById('stateSelectT1').innerHTML = opts;
        document.getElementById('stateSelectT2').innerHTML = opts;

        // Populate T2 Candidate Selects
        const candOpts = CANDIDATES_2026.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        const s1 = document.getElementById('candFinal1');
        const s2 = document.getElementById('candFinal2');
        s1.innerHTML = candOpts; s1.value = CANDIDATES_2026[0].id;
        s2.innerHTML = candOpts; s2.value = CANDIDATES_2026[1].id;
        
        app.initTurn2Defaults();
    },

    renderStateMultipliers: (turn) => {
        const uf = document.getElementById(turn === 1 ? 'stateSelectT1' : 'stateSelectT2').value;
        const container = document.getElementById(turn === 1 ? 'stateMultipliersT1' : 'stateMultipliersT2');
        container.innerHTML = '';
        
        if(!uf) return;

        const candidates = turn === 1 ? CANDIDATES_2026 : app.state.t2_finalists.map(fid => CANDIDATES_2026.find(c=>c.id===fid));
        const stateStore = turn === 1 ? app.state.t1_stateMults : app.state.t2_stateMults;
        
        if (!stateStore[uf]) stateStore[uf] = {};

        candidates.forEach(cand => {
            const currentMult = stateStore[uf][cand.id] !== undefined ? stateStore[uf][cand.id] : 1.0;
            
            const div = document.createElement('div');
            div.className = 'slider-row';
            div.style.marginBottom = "15px";
            div.innerHTML = `
                <div class="slider-head">
                    <span style="color:${cand.color}">${cand.name}</span>
                    <span id="mul_${turn}_${uf}_${cand.id}">x${currentMult.toFixed(2)}</span>
                </div>
                <input type="range" min="0" max="300" value="${currentMult*100}" 
                       oninput="app.updateStateMult(${turn}, '${uf}', '${cand.id}', this.value)">
            `;
            container.appendChild(div);
        });
    },

    updateStateMult: (turn, uf, candId, val) => {
        const store = turn === 1 ? app.state.t1_stateMults : app.state.t2_stateMults;
        const mult = parseInt(val) / 100;
        store[uf][candId] = mult;
        document.getElementById(`mul_${turn}_${uf}_${candId}`).innerText = 'x' + mult.toFixed(2);
    },

    initTurn2Defaults: () => {
        const c1 = document.getElementById('candFinal1').value;
        const c2 = document.getElementById('candFinal2').value;
        app.state.t2_finalists = [c1, c2];

        // Render Migration Sliders
        const container = document.getElementById('migrationContainer');
        container.innerHTML = '';
        const c1Obj = CANDIDATES_2026.find(x=>x.id===c1);
        
        CANDIDATES_2026.forEach(cand => {
            if (cand.id === c1 || cand.id === c2) return;
            
            // Valor atual ou padrão 0.5 (50/50)
            const currentVal = app.state.t2_migration[cand.id] !== undefined ? app.state.t2_migration[cand.id] : 0.5;
            
            const div = document.createElement('div');
            div.className = 'slider-row';
            div.innerHTML = `
                <div class="slider-head">
                    <span style="color:${cand.color}">Votos de ${cand.name}</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#666; margin-bottom:2px;">
                    <span>${c1Obj.name}</span><span>${CANDIDATES_2026.find(x=>x.id===c2).name}</span>
                </div>
                <input type="range" min="0" max="100" value="${currentVal*100}" 
                       oninput="app.state.t2_migration['${cand.id}'] = this.value/100">
            `;
            container.appendChild(div);
        });
        
        // Se estivermos vendo o T2, atualiza os mults estaduais também
        if(app.state.turn === 2 && document.getElementById('stateSelectT2').value) {
            app.renderStateMultipliers(2);
        }
    },

    // =========================================================================
    // MAPA & VISUALIZAÇÃO
    // =========================================================================
    getStyle: (feature) => {
        const id = feature.properties.id;
        const dataset = app.state.turn === 1 ? app.data.round1 : app.data.round2;
        
        if (!dataset) return { fillColor: '#222', weight: 0.5, color: '#444' };
        
        // Decide escopo (municipios ou estados)
        // Se estamos vendo cidades (feature tem id > 2 chars) ou estamos no modo Brasil (feature = estado)
        let votes = {};
        if (id.length === 2 && !app.layers.cities) {
            votes = dataset.estados[id];
        } else {
            votes = dataset.municipios[id];
        }

        if(!votes) return { fillColor: '#222', weight: 0.2, color: '#333', fillOpacity: 0.5 };

        // Acha vencedor
        let max = -1;
        let winner = null;
        let total = 0;
        for(let c in votes) {
            total += votes[c];
            if(votes[c] > max) { max = votes[c]; winner = c; }
        }

        if(!winner) return { fillColor: '#222' };

        const candObj = CANDIDATES_2026.find(c => c.id === winner) || { color: '#555' };
        const pct = (max / total) * 100;
        
        // Calcula opacidade/mix baseado na margem
        const margin = app.getGradientRatio(pct);
        const color = app.mixColor(candObj.color, '#1a1a1a', 1 - margin); // Mistura com fundo escuro

        return {
            fillColor: color,
            weight: id.length === 2 ? 0.8 : 0.2,
            color: '#ffffff',
            fillOpacity: 1
        };
    },

    getGradientRatio: (pct) => {
        if(app.state.turn === 2) {
            // Curva mais agressiva para T2 (50% é empate)
            const diff = pct - 50; 
            if(diff < 2) return 0.2; // Muito apertado
            if(diff < 5) return 0.4;
            if(diff < 10) return 0.6;
            return 0.8;
        }
        // T1
        if(pct < 30) return 0.3;
        if(pct < 40) return 0.5;
        if(pct < 50) return 0.7;
        return 0.9;
    },

    mixColor: (c1, c2, ratio) => {
        // Hex to RGB mix
        const hex = (x) => parseInt(x.replace('#',''), 16);
        const r1 = (hex(c1) >> 16) & 255, g1 = (hex(c1) >> 8) & 255, b1 = hex(c1) & 255;
        const r2 = (hex(c2) >> 16) & 255, g2 = (hex(c2) >> 8) & 255, b2 = hex(c2) & 255;
        
        const r = Math.round(r1 * ratio + r2 * (1-ratio));
        const g = Math.round(g1 * ratio + g2 * (1-ratio));
        const b = Math.round(b1 * ratio + b2 * (1-ratio));
        
        return `rgb(${r},${g},${b})`;
    },

    enterStateMode: async (ufId, ufName) => {
        const loader = document.getElementById('loader');
        loader.classList.remove('hidden');
        document.getElementById('loaderMsg').innerText = `Carregando ${ufName}...`;
        
        // Limpa mapa anterior de cidades se existir
        if(app.layers.cities) app.map.removeLayer(app.layers.cities);
        app.layers.brazil.setStyle({ fillOpacity: 0.1, color:'#333' }); // Diminui destaque do Brasil

        if(!app.data.geoJson) {
            const r = await fetch("https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-100-mun.json");
            app.data.geoJson = await r.json();
        }

        const feats = app.data.geoJson.features.filter(f => f.properties.id.startsWith(ufId));
        
        app.layers.cities = L.geoJSON({ type:"FeatureCollection", features:feats }, {
            style: app.getStyle,
            onEachFeature: (f, l) => {
                l.on('click', L.DomEvent.stopPropagation); // Previne zoom out
                app.bindTooltip(l, f.properties.name);
            }
        }).addTo(app.map);

        app.map.fitBounds(app.layers.cities.getBounds());
        app.state.selectedRegion = { id: ufId, name: ufName };
        
        document.getElementById('btnBack').style.display = 'block';
        app.updateSidebarRight();
        loader.classList.add('hidden');
    },

    resetSelection: () => {
        if(app.layers.cities) app.map.removeLayer(app.layers.cities);
        app.layers.brazil.setStyle(app.getStyle);
        app.map.setView([-15, -50], 4);
        app.state.selectedRegion = null;
        document.getElementById('btnBack').style.display = 'none';
        app.updateSidebarRight();
    },

    bindTooltip: (layer, name) => {
        layer.bindTooltip(() => {
            const id = layer.feature.properties.id;
            const dataset = app.state.turn === 1 ? app.data.round1 : app.data.round2;
            if(!dataset) return "Sem dados";
            
            const scope = id.length === 2 ? 'estados' : 'municipios';
            const votes = dataset[scope][id];
            if(!votes) return "Sem votos";

            // Calcula Vencedor
            const sorted = Object.entries(votes).sort((a,b)=>b[1]-a[1]);
            const total = sorted.reduce((a,b)=>a+b[1],0);
            const winner = sorted[0];
            const wObj = CANDIDATES_2026.find(c=>c.id===winner[0]);

            return `
                <div class="custom-tooltip">
                    <div class="tt-head">${name}</div>
                    <div class="tt-body">
                        <div style="color:${wObj.color}; font-weight:800; font-size:1.1em">${wObj.name}</div>
                        <div>${((winner[1]/total)*100).toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }, { sticky: true });
    },

    updateSidebarRight: () => {
        const title = document.getElementById('regionName');
        const sub = document.getElementById('regionType');
        const list = document.getElementById('resultsContainer');
        const totalEl = document.getElementById('totalVotesVal');
        
        const region = app.state.selectedRegion;
        title.innerText = region ? region.name : "Brasil";
        sub.innerText = region ? "Estado" : "Nacional";
        
        list.innerHTML = '';
        
        const dataset = app.state.turn === 1 ? app.data.round1 : app.data.round2;
        if(!dataset) return;

        let votes = {};
        if (region) {
            votes = dataset.estados[region.id];
        } else {
            votes = dataset.nacional;
        }

        const sorted = Object.entries(votes).sort((a,b)=>b[1]-a[1]);
        const total = sorted.reduce((a,b)=>a+b[1],0);
        totalEl.innerText = total.toLocaleString();

        sorted.forEach(([cid, v]) => {
            const obj = CANDIDATES_2026.find(c=>c.id===cid);
            if(!obj) return;
            
            const pct = (v/total)*100;
            const div = document.createElement('div');
            div.className = 'cand-row';
            div.innerHTML = `
                <div class="cand-color" style="background:${obj.color}"></div>
                <div class="cand-info">
                    <div class="cand-head">
                        <span>${obj.name}</span>
                        <span style="color:${obj.color}">${pct.toFixed(2)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${pct}%; background:${obj.color}"></div>
                    </div>
                    <div style="font-size:0.7rem; color:#666; margin-top:2px; text-align:right;">
                        ${v.toLocaleString()} votos
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    },

    renderLegend: () => {
        const el = document.getElementById('legendColors');
        el.innerHTML = '';
        for(let i=0; i<5; i++) {
            const d = document.createElement('div');
            d.className = 'legend-item';
            const opacity = 0.2 + (i*0.2);
            d.style.background = `rgba(255,255,255,${opacity})`;
            el.appendChild(d);
        }
    }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
